Namespace("flipsnap").define(function(ns){(function(window,document,undefined){var div=document.createElement("div");var prefix=["webkit","moz","o","ms"];var saveProp={};var support=Flipsnap.support={};var gestureStart=false;var DISTANCE_THRESHOLD=5;var ANGLE_THREHOLD=55;support.transform3d=hasProp(["perspectiveProperty","WebkitPerspective","MozPerspective","OPerspective","msPerspective"]);support.transform=hasProp(["transformProperty","WebkitTransform","MozTransform","OTransform","msTransform"]);support.transition=hasProp(["transitionProperty","WebkitTransitionProperty","MozTransitionProperty","OTransitionProperty","msTransitionProperty"]);support.addEventListener="addEventListener"in window;support.mspointer=window.navigator.msPointerEnabled;support.cssAnimation=(support.transform3d||support.transform)&&support.transition;var eventTypes=["touch","mouse"];var events={start:{touch:"touchstart",mouse:"mousedown"},move:{touch:"touchmove",mouse:"mousemove"},end:{touch:"touchend",mouse:"mouseup"}};if(support.addEventListener){document.addEventListener("gesturestart",function(){gestureStart=true});document.addEventListener("gestureend",function(){gestureStart=false})}function Flipsnap(element,opts){return this instanceof Flipsnap?this.init(element,opts):new Flipsnap(element,opts)}Flipsnap.prototype.init=function(element,opts){var self=this;self.element=element;if(typeof element==="string"){self.element=document.querySelector(element)}if(!self.element){throw new Error("element not found")}if(support.mspointer){self.element.style.msTouchAction="pan-y"}opts=opts||{};self.distance=opts.distance;self.maxPoint=opts.maxPoint;self.disableTouch=opts.disableTouch===undefined?false:opts.disableTouch;self.disable3d=opts.disable3d===undefined?false:opts.disable3d;self.transitionDuration=opts.transitionDuration===undefined?"350ms":opts.transitionDuration+"ms";self.currentPoint=0;self.currentX=0;self.animation=false;self.use3d=support.transform3d;if(self.disable3d===true){self.use3d=false}if(support.cssAnimation){self._setStyle({transitionProperty:getCSSVal("transform"),transitionTimingFunction:"cubic-bezier(0,0,0.25,1)",transitionDuration:"0ms",transform:self._getTranslate(0)})}else{self._setStyle({position:"relative",left:"0px"})}self.refresh();eventTypes.forEach(function(type){self.element.addEventListener(events.start[type],self,false)});return self};Flipsnap.prototype.handleEvent=function(event){var self=this;switch(event.type){case events.start.touch:self._touchStart(event,"touch");break;case events.start.mouse:self._touchStart(event,"mouse");break;case events.move.touch:self._touchMove(event,"touch");break;case events.move.mouse:self._touchMove(event,"mouse");break;case events.end.touch:self._touchEnd(event,"touch");break;case events.end.mouse:self._touchEnd(event,"mouse");break;case"click":self._click(event);break}};Flipsnap.prototype.refresh=function(){var self=this;self._maxPoint=self.maxPoint===undefined?function(){var childNodes=self.element.childNodes,itemLength=-1,i=0,len=childNodes.length,node;for(;i<len;i++){node=childNodes[i];if(node.nodeType===1){itemLength++}}return itemLength}():self.maxPoint;if(self.distance===undefined){if(self._maxPoint<0){self._distance=0}else{self._distance=self.element.scrollWidth/(self._maxPoint+1)}}else{self._distance=self.distance}self._maxX=-self._distance*self._maxPoint;self.moveToPoint()};Flipsnap.prototype.hasNext=function(){var self=this;return self.currentPoint<self._maxPoint};Flipsnap.prototype.hasPrev=function(){var self=this;return self.currentPoint>0};Flipsnap.prototype.toNext=function(transitionDuration){var self=this;if(!self.hasNext()){return}self.moveToPoint(self.currentPoint+1,transitionDuration)};Flipsnap.prototype.toPrev=function(transitionDuration){var self=this;if(!self.hasPrev()){return}self.moveToPoint(self.currentPoint-1,transitionDuration)};Flipsnap.prototype.moveToPoint=function(point,transitionDuration){var self=this;transitionDuration=transitionDuration===undefined?self.transitionDuration:transitionDuration+"ms";var beforePoint=self.currentPoint;if(point===undefined){point=self.currentPoint}if(point<0){self.currentPoint=0}else if(point>self._maxPoint){self.currentPoint=self._maxPoint}else{self.currentPoint=parseInt(point,10)}if(support.cssAnimation){self._setStyle({transitionDuration:transitionDuration})}else{self.animation=true}self._setX(-self.currentPoint*self._distance,transitionDuration);if(beforePoint!==self.currentPoint){self._triggerEvent("fsmoveend",true,false);self._triggerEvent("fspointmove",true,false)}};Flipsnap.prototype._setX=function(x,transitionDuration){var self=this;self.currentX=x;if(support.cssAnimation){self.element.style[saveProp.transform]=self._getTranslate(x)}else{if(self.animation){self._animate(x,transitionDuration||self.transitionDuration)}else{self.element.style.left=x+"px"}}};Flipsnap.prototype._touchStart=function(event,type){var self=this;if(self.disableTouch||self.scrolling||gestureStart){return}self.element.addEventListener(events.move[type],self,false);document.addEventListener(events.end[type],self,false);var tagName=event.target.tagName;if(type==="mouse"&&tagName!=="SELECT"&&tagName!=="INPUT"&&tagName!=="TEXTAREA"&&tagName!=="BUTTON"){event.preventDefault()}if(support.cssAnimation){self._setStyle({transitionDuration:"0ms"})}else{self.animation=false}self.scrolling=true;self.moveReady=false;self.startPageX=getPage(event,"pageX");self.startPageY=getPage(event,"pageY");self.basePageX=self.startPageX;self.directionX=0;self.startTime=event.timeStamp;self._triggerEvent("fstouchstart",true,false)};Flipsnap.prototype._touchMove=function(event,type){var self=this;if(!self.scrolling||gestureStart){return}var pageX=getPage(event,"pageX");var pageY=getPage(event,"pageY");var distX;var newX;if(self.moveReady){event.preventDefault();distX=pageX-self.basePageX;newX=self.currentX+distX;if(newX>=0||newX<self._maxX){newX=Math.round(self.currentX+distX/3)}self.directionX=distX===0?self.directionX:distX>0?-1:1;var isPrevent=!self._triggerEvent("fstouchmove",true,true,{delta:distX,direction:self.directionX});if(isPrevent){self._touchAfter({moved:false,originalPoint:self.currentPoint,newPoint:self.currentPoint,cancelled:true})}else{self._setX(newX)}}else{var triangle=getTriangleSide(self.startPageX,self.startPageY,pageX,pageY);if(triangle.z>DISTANCE_THRESHOLD){if(getAngle(triangle)>ANGLE_THREHOLD){event.preventDefault();self.moveReady=true;self.element.addEventListener("click",self,true)}else{self.scrolling=false}}}self.basePageX=pageX};Flipsnap.prototype._touchEnd=function(event,type){var self=this;self.element.removeEventListener(events.move[type],self,false);document.removeEventListener(events.end[type],self,false);if(!self.scrolling){return}var newPoint=-self.currentX/self._distance;newPoint=self.directionX>0?Math.ceil(newPoint):self.directionX<0?Math.floor(newPoint):Math.round(newPoint);if(newPoint<0){newPoint=0}else if(newPoint>self._maxPoint){newPoint=self._maxPoint}self._touchAfter({moved:newPoint!==self.currentPoint,originalPoint:self.currentPoint,newPoint:newPoint,cancelled:false});self.moveToPoint(newPoint)};Flipsnap.prototype._click=function(event){var self=this;event.stopPropagation();event.preventDefault()};Flipsnap.prototype._touchAfter=function(params){var self=this;self.scrolling=false;self.moveReady=false;setTimeout(function(){self.element.removeEventListener("click",self,true)},200);self._triggerEvent("fstouchend",true,false,params)};Flipsnap.prototype._setStyle=function(styles){var self=this;var style=self.element.style;for(var prop in styles){setStyle(style,prop,styles[prop])}};Flipsnap.prototype._animate=function(x,transitionDuration){var self=this;var elem=self.element;var begin=+new Date;var from=parseInt(elem.style.left,10);var to=x;var duration=parseInt(transitionDuration,10);var easing=function(time,duration){return-(time/=duration)*(time-2)};var timer=setInterval(function(){var time=new Date-begin;var pos,now;if(time>duration){clearInterval(timer);now=to}else{pos=easing(time,duration);now=pos*(to-from)+from}elem.style.left=now+"px"},10)};Flipsnap.prototype.destroy=function(){var self=this;eventTypes.forEach(function(type){self.element.removeEventListener(events.start[type],self,false)})};Flipsnap.prototype._getTranslate=function(x){var self=this;return self.use3d?"translate3d("+x+"px, 0, 0)":"translate("+x+"px, 0)"};Flipsnap.prototype._triggerEvent=function(type,bubbles,cancelable,data){var self=this;var ev=document.createEvent("Event");ev.initEvent(type,bubbles,cancelable);if(data){for(var d in data){if(data.hasOwnProperty(d)){ev[d]=data[d]}}}return self.element.dispatchEvent(ev)};function getPage(event,page){return event.changedTouches?event.changedTouches[0][page]:event[page]}function hasProp(props){return some(props,function(prop){return div.style[prop]!==undefined})}function setStyle(style,prop,val){var _saveProp=saveProp[prop];if(_saveProp){style[_saveProp]=val}else if(style[prop]!==undefined){saveProp[prop]=prop;style[prop]=val}else{some(prefix,function(_prefix){var _prop=ucFirst(_prefix)+ucFirst(prop);if(style[_prop]!==undefined){saveProp[prop]=_prop;style[_prop]=val;return true}})}}function getCSSVal(prop){if(div.style[prop]!==undefined){return prop}else{var ret;some(prefix,function(_prefix){var _prop=ucFirst(_prefix)+ucFirst(prop);if(div.style[_prop]!==undefined){ret="-"+_prefix+"-"+prop;return true}});return ret}}function ucFirst(str){return str.charAt(0).toUpperCase()+str.substr(1)}function some(ary,callback){for(var i=0,len=ary.length;i<len;i++){if(callback(ary[i],i)){return true}}return false}function getTriangleSide(x1,y1,x2,y2){var x=Math.abs(x1-x2);var y=Math.abs(y1-y2);var z=Math.sqrt(Math.pow(x,2)+Math.pow(y,2));return{x:x,y:y,z:z}}function getAngle(triangle){var cos=triangle.y/triangle.z;var radina=Math.acos(cos);return 180/(Math.PI/radina)}if(typeof exports=="object"){module.exports=Flipsnap}else if(typeof define=="function"&&define.amd){define(function(){return Flipsnap})}else{window.Flipsnap=Flipsnap}})(window,window.document);ns.provide({Flipsnap:window.Flipsnap});delete window.Flipsnap});Namespace("jp.mixi.common.widget.pc.holdposition").define(function(ns){"use strict";var userAgent=window.navigator.userAgent.toLowerCase();if(userAgent.match(/ipad|iphone|android/)){return}if(userAgent.indexOf("mac")!==-1&&userAgent.indexOf("safari")!==-1&&userAgent.indexOf("chrome")===-1){return}var DEFAULT_PADDING_TOP=5;var isStartedListenScrollEvent=false;var $selfColumnElement;var $pairColumnElement;var selfColumnLeft;var $window=$j(window);var startListenScrollEvent=function(target){if(isStartedListenScrollEvent)return;$window.on("scroll",function(e){reposition(target)});$window.on("resize",function(e){resetColumLeftHorizontalPosition(target,5)});reposition(target);isStartedListenScrollEvent=true};function resetColumLeftHorizontalPosition(target,counter){if(counter<=0){return}selfColumnLeft=$selfColumnElement.offset().left;reposition(target);setTimeout(function(){resetColumLeftHorizontalPosition(target,counter-1)},1e3)}function reposition(target){var pairColumnHeight=$pairColumnElement.height();var targetHeight=target.element.prop("scrollHeight");var selfColumnHeight=$selfColumnElement.height();if(pairColumnHeight<selfColumnHeight)return;var $element=target.element;var scrollTop=$window.scrollTop();var scrollLeft=$window.scrollLeft();var paddingTop=parseInt(target.dataset.paddingTop,10)||DEFAULT_PADDING_TOP;var pairColumnRect=$pairColumnElement[0].getBoundingClientRect();if(target.top-paddingTop<scrollTop&&pairColumnHeight+pairColumnRect.top>=targetHeight){if($element.css("position")==="fixed"){selfColumnHeight=$selfColumnElement.height()+targetHeight}$element.css("position","fixed");$element.css("top",paddingTop+"px");var overLeft=selfColumnLeft-scrollLeft;$element.css("left",overLeft+"px")}else if(target.top+paddingTop>scrollTop&&$element.css("position")==="fixed"){$element.css("position","");$element.css("top","")}else if(pairColumnHeight+pairColumnRect.top<targetHeight&&$element.css("position")!=="relative"){var overHeight=pairColumnHeight-selfColumnHeight-paddingTop-targetHeight;$element.css("position","relative");$element.css("top",overHeight+"px");$element.css("left","auto")}}var holdElement=function(element,dataset){$selfColumnElement=$j(dataset.selfColumnSelector);$pairColumnElement=$j(dataset.pairColumnSelector);selfColumnLeft=$selfColumnElement.offset().left;var $element=$j(element);var appVersion=window.navigator.appVersion.toLowerCase();if(appVersion.indexOf("msie 7.")!==-1||appVersion.indexOf("msie 8.")!==-1){$element.css("zoom",1)}$window.on("load",function(){var targetData={top:$element.offset().top,element:$element,dataset:dataset};startListenScrollEvent(targetData)})};ns.provide({registerElement:holdElement})});Namespace("jp.mixi.group.window.mode").define(function(ns){var MODE_LIST=[{id:"create",description:"グループ新規作成",isCreate:function(){return true},isUpdate:function(){return false},isView:function(){return false},isAlert:function(){return false}},{id:"update",description:"グループ編集",isCreate:function(){return false},isUpdate:function(){return true},isView:function(){return false},isAlert:function(){return false}},{id:"view",description:"グループ確認",isCreate:function(){return false},isUpdate:function(){return false},isView:function(){return true},isAlert:function(){return false}},{id:"alert",description:"グループ作成・編集",isCreate:function(){return false},isUpdate:function(){return false},isView:function(){return false},isAlert:function(){return true}}];ns.provide({getWindowModeById:function(id){var mode=_.find(MODE_LIST,function(mode){return mode.id==id});if(!mode){throw"Invalid mode id."}return mode}})});Namespace("jp.mixi.service.visibilitylevel").use("jp.co.mixi.lang.class defineClass").use("jp.co.mixi.gateway gateway").use("jp.mixi.model.relation.group getGroupModel").use("brook.util through").define(function(ns){var GROUP_LEVEL_ID_OFFSET=10;var BASIC_LEVEL_SETTINGS=[{description:"全体に公開",nameText:"全体",name:"public",level_id:4},{description:"友人の友人まで公開",nameText:"友人の友人",name:"foaf",level_id:3},{description:"友人まで公開",nameText:"友人",name:"friend",level_id:2},{description:"仲良しに公開",nameText:"仲良し",name:"buddy",level_id:100},{description:"非公開",nameText:"非公開",name:"private",level_id:1}];var BASIC_LEVEL_TYPES={voice:["public","foaf","friend","buddy"],check:["public","foaf","friend","buddy","private"]};var DEFAULT_SERVICE="voice";var _VisibilityLevel=ns.defineClass({initialize:function(args){var _self=this;_self.description=args.description;_self.subDescription=args.subDescription||"";_self.nameText=args.nameText;_self.name=args.name;_self.groupId=args.groupId;_self.levelId=args.levelId;_self.isDefault=args.isDefault},isGroup:function(){return this.name==="group"},asPrivacy:function(){return{name:this.name,group_id:this.groupId}},isDefaultLevel:function(){return this.isDefault}});var getBasicLevels=function(service,defaultLevelSetting){service=service||DEFAULT_SERVICE;defaultLevelSetting=defaultLevelSetting||_getVoiceDefaultLevelSettingFromGateWay();var basicLevelNames=BASIC_LEVEL_TYPES[service];if(!basicLevelNames){throw"invalid service name: "+service}var serviceLevelSettings=_.filter(BASIC_LEVEL_SETTINGS,function(setting){return _.include(basicLevelNames,setting.name)});var basicLevels=[];_.each(serviceLevelSettings,function(setting){var level=new _VisibilityLevel({description:setting.description,name:setting.name,nameText:setting.nameText,levelId:setting.level_id,isDefault:setting.level_id==defaultLevelSetting.id});basicLevels.push(level)});return basicLevels};var getLevelFromGroup=function(group,defaultLevelSetting){defaultLevelSetting=defaultLevelSetting||_getVoiceDefaultLevelSettingFromGateWay();var levelId=Number(group.group_id)+Number(GROUP_LEVEL_ID_OFFSET);var subDescription=_.sprintf("(%d人)",group.all_member_id_list.length);return new _VisibilityLevel({description:group.name,subDescription:subDescription,name:"group",nameText:group.name,groupId:group.group_id,levelId:levelId,isDefault:group.group_id==defaultLevelSetting.group_id})};var __defaultLevelUpdater=function(defaultLevel){var groupModel=ns.getGroupModel();groupModel.method("update").observe(ns.through(function(rpcResult){if(rpcResult.response.error){return}var group=rpcResult.response.result;if(defaultLevel.group_id==group.group_id){defaultLevel.description=group.name}}))};var getDefaultLevel=function(defaultLevelSetting){if(!defaultLevelSetting){defaultLevelSetting=_getVoiceDefaultLevelSettingFromGateWay()}if(defaultLevelSetting.name!=="group"){var basicLevelSetting=_.find(BASIC_LEVEL_SETTINGS,function(basicLevel){return basicLevel.name===defaultLevelSetting.name});return new _VisibilityLevel({description:basicLevelSetting.description,nameText:basicLevelSetting.nameText,name:basicLevelSetting.name,levelId:basicLevelSetting.level_id,isDefault:true})}else{__defaultLevelUpdater(defaultLevelSetting);var levelId=Number(defaultLevelSetting.group_id)+Number(GROUP_LEVEL_ID_OFFSET);return new _VisibilityLevel({description:defaultLevelSetting.description,nameText:defaultLevelSetting.description,name:defaultLevelSetting.name,groupId:defaultLevelSetting.group_id,levelId:levelId,isDefault:true})}};var _getVoiceDefaultLevelSettingFromGateWay=function(){var voiceSettings=ns.gateway("voice_settings");if(voiceSettings){return voiceSettings.default_level}throw'no information for default level setting: "defaultLevelSetting" arg nor "voice_settings" gateway'};ns.provide({getBasicLevels:getBasicLevels,getDefaultLevel:getDefaultLevel,getLevelFromGroup:getLevelFromGroup})});Namespace("jp.mixi.service.ui.levelselector").use("brook promise").use("brook.util through,wait,from,mapper").use("brook.model createModel").use("brook.channel sendChannel").use("jp.co.mixi.lang.class defineClass").use("jp.mixi.model.relation.group getGroupModel").use("jp.mixi.group.window.mode getWindowModeById").use("jp.mixi.service.visibilitylevel getBasicLevels,getDefaultLevel,getLevelFromGroup").define(function(ns){var eventHandler;var DEFAULT_SERVICE="voice";var getLevelSelectorEventModel=function(){if(!eventHandler){eventHandler=ns.createModel();eventHandler.addMethod("open",ns.promise());eventHandler.addMethod("close",ns.promise());eventHandler.addMethod("changeLevel",ns.promise())}return eventHandler};var __isChildOf=function(parent,child){if(parent===child){return false}while(child&&child!==parent){child=child.parentNode}return child===parent};var groupModel=ns.getGroupModel();var CSS_SELECTOR_OF={BASIC_LEVELS:".JS_basicLevels",GROUP_LEVELS:".JS_groupLevels",CREATE_GROUP:".JS_createGroup",LOADING_GROUP:".JS_loadingGroup",SELECTOR_CONTENT:".JS_selectorContent",SELECTOR_LOADING:".JS_selectorLoading"};var LevelSelector=ns.defineClass({initialize:function(args){var _self=this;_self._selectBoxElem=args.selectBoxElem;_self._levelListElem=args.levelListElem;_self._groupWindow=args.groupWindow;_self._aLevelTemplate=args.aLevelTemplate;_self._defaultLevelSetting=args.defaultLevelSetting;_self._service=args.service||DEFAULT_SERVICE;_self._levelElemOf={};_self._isOpen=false;_self._onClickBodyHandler=_self._onClickBody.bind(_self);_self._selectBoxElem.click(function(evt){if(evt){evt.preventDefault();evt.stopPropagation()}if(_self._isOpen){_self._close().run()}else{_self._open().run()}});_self._eventHandler=getLevelSelectorEventModel();if(_self._groupWindow){_self._groupWindow.observeEvent("close",_self._close())}_self.renderBasicLevels();_self._startObservingGroupModel()},observeEvent:function(eventName,promise){this._eventHandler.method(eventName).observe(promise)},setService:function(){var _self=this;return ns.through(function(value){if(value.defaultLevelSetting){_self._defaultLevelSetting=value.defaultLevelSetting}_self._service=value.service;_self.renderBasicLevels()})},setDefaultLevel:function(){var _self=this;return ns.through(function(){var defaultLevel=ns.getDefaultLevel(_self._defaultLevelSetting);_self._setLevel().run(defaultLevel)})},getSelectedLevel:function(){return this._currentLevel},renderBasicLevels:function(){var _self=this;_self._levelListElem.find(CSS_SELECTOR_OF.BASIC_LEVELS).html("");_.each(ns.getBasicLevels(_self._service,_self._defaultLevelSetting),function(level){var element=_self._createLevelElem(level);_self._levelListElem.find(CSS_SELECTOR_OF.BASIC_LEVELS).append(element)});_self.setDefaultLevel().run()},_onClickBody:function(e){var _self=this;var isListClicked=__isChildOf(_self._levelListElem.get(0),e.target);if(isListClicked){return}var isBoxClicked=__isChildOf(_self._selectBoxElem.get(0),e.target)||e.target===_self._selectBoxElem.get(0);if(isBoxClicked){return}_self._close().run()},_close:function(){var _self=this;return ns.through(function(){_self._isOpen=false;window.scrollTo(0,_self._scrollYWhenOpen);$j("body").unbind("click",_self._onClickBodyHandler);_self._levelListElem.hide();_self._levelListElem.find(CSS_SELECTOR_OF.CREATE_GROUP).unbind("click")}).bind(_self._eventHandler.notify("close"))},_open:function(){var _self=this;return ns.through(function(){_self._isOpen=true;_self._scrollYWhenOpen=window.pageYOffset!==undefined?window.pageYOffset:(document.documentElement||document.body.parentNode||document.body).scrollTop;_self._levelListElem.show();$j("body").click(_self._onClickBodyHandler)}).bind(_self._eventHandler.notify("open")).bind(_self._showLoading()).bind(_self._getCurrentGroups()).bind(_self._renderGroupLevels()).bind(_self._registerCreate()).bind(ns.wait(200)).bind(_self._setLevel()).bind(_self._hideLoading())},_showLoading:function(){var _self=this;return ns.through(function(){var contentElem=_self._levelListElem.find(CSS_SELECTOR_OF.SELECTOR_CONTENT);var loadingElem=_self._levelListElem.find(CSS_SELECTOR_OF.SELECTOR_LOADING);contentElem.hide();loadingElem.show()})},_hideLoading:function(){var _self=this;return ns.through(function(){var contentElem=_self._levelListElem.find(CSS_SELECTOR_OF.SELECTOR_CONTENT);var loadingElem=_self._levelListElem.find(CSS_SELECTOR_OF.SELECTOR_LOADING);loadingElem.hide();contentElem.show()})},_startObservingGroupModel:function(){var _self=this;var MESSAGE_EDIT="「%s」を編集しました";var MESSAGE_CREATE="「%s」を作成しました";var showToast=function(messageFormat){return ns.through(function(group){var TRUNCATE_LENGTH=12;var message=_.str.sprintf(messageFormat,_.str.truncate(group.name,TRUNCATE_LENGTH));ns.mapper(function(group){return{type:"normal",message:message}}).bind(ns.wait(600)).bind(ns.sendChannel("dialog_toast")).run(group)})};groupModel.method("create").observe(ns.promise(function(next,rpcResult){if(rpcResult.response.error){return}var group=rpcResult.response.result;next(group)}).bind(_self._getCurrentGroups()).bind(_self._renderGroupLevels()).bind(function(next,currentGroups){next(_.last(currentGroups))}).bind(showToast(MESSAGE_CREATE)).bind(ns.mapper(function(group){return ns.getLevelFromGroup(group,_self._defaultLevelSetting)})).bind(_self._setLevel()));groupModel.method("update").observe(ns.promise(function(next,rpcResult){if(rpcResult.response.error){return}var group=rpcResult.response.result;next(group)}).bind(showToast(MESSAGE_EDIT)).bind(ns.mapper(function(group){return ns.getLevelFromGroup(group,_self._defaultLevelSetting)})).bind(_self._setLevel()));groupModel.method("delete").observe(_self.setDefaultLevel())},_setLevel:function(){var _self=this;return ns.through(function(level){if(level.levelId){_self._currentLevel=level}var currentLevelElem=_self._levelElemOf[_self._currentLevel.levelId];if(currentLevelElem){currentLevelElem.find("input").get(0).checked=true}var spanElem=_self._selectBoxElem.find("span");if(spanElem.length){spanElem.text(_self._currentLevel.description)}else{_self._selectBoxElem.text(_self._currentLevel.description)}}).bind(_self._eventHandler.notify("changeLevel"))},_renderGroupLevels:function(){var _self=this;return ns.promise(function(next,groups){var loadingGroup=_self._levelListElem.find(CSS_SELECTOR_OF.LOADING_GROUP);_self._levelListElem.find(CSS_SELECTOR_OF.GROUP_LEVELS).html("");_.each(groups,function(group){_self._appendGroup(group)});loadingGroup.hide();next(groups)})},_appendGroup:function(group){var _self=this;var level=ns.getLevelFromGroup(group,_self._defaultLevelSetting);var element=_self._createLevelElem(level);_self._levelListElem.find(CSS_SELECTOR_OF.GROUP_LEVELS).append(element)},_registerCreate:function(){var _self=this;var mode=ns.getWindowModeById("create");return ns.through(function(groups){_self._levelListElem.find(CSS_SELECTOR_OF.CREATE_GROUP).click(function(evt){if(evt){evt.preventDefault();evt.stopPropagation()}_self._close().bind(ns.through(function(){window.scrollTo(0,0)})).bind(_self._groupWindow.open({currentGroups:groups,mode:mode})).run()})})},_createLevelElem:function(level){var _self=this;_self._aLevelTemplate.param(level);var element=$j(_self._aLevelTemplate.output());_self._levelElemOf[level.levelId]=element;element.click(function(evt){if(evt){evt.preventDefault();evt.stopPropagation()}var spanElem=_self._selectBoxElem.find("span");if(spanElem.length){spanElem.text(level.description)}else{_self._selectBoxElem.text(level.description)}_self._close().bind(_self._setLevel()).run(level)});return element},_getCurrentGroups:function(){return ns.from({}).bind(groupModel.notify("find")).bind(ns.mapper(function(rpcResult){return rpcResult.response.result}))}});ns.provide({LevelSelector:LevelSelector,getLevelSelectorEventModel:getLevelSelectorEventModel})});Namespace("jp.mixi.service.widget.announceballoon").use("brook promise").use("brook.util through,from").use("jp.co.mixi.gateway gateway").use("jp.mixi.model.utils createRPCPromise,whenExpiredSessionToReload").use("jp.mixi.service.analysis postUIEventLog").define(function(ns){"use strict";var CLOSE_METHOD_MAPPING={hide:"hide",remove:"remove"};var elementsOf={};var __deactivete=_.once(function(){return ns.promise().bind(ns.createRPCPromise("jp.mixi.serviceactivation.peruser.deactivate"),ns.whenExpiredSessionToReload)});var registerElement=function(element,dataset){element=$j(element);var name=dataset.name;if(!elementsOf[name]){elementsOf[name]=[]}elementsOf[name].push(element);element.click(function(evt){evt.preventDefault();evt.stopPropagation()});element.find(".JS_closeBalloon").click(function(evt){evt.preventDefault();evt.stopPropagation();closeBalloon(name,dataset.closeAction).ready()();var eventName=dataset.eventName;if(eventName){ns.postUIEventLog(eventName)}})};var closeBalloon=function(name,action){var closeMethod=CLOSE_METHOD_MAPPING[action]||CLOSE_METHOD_MAPPING.hide;var hideElement=ns.promise(function(next,value){var elements=elementsOf[name];if(!elements){return}_.invoke(elements,closeMethod);next(value)});return ns.from({service:name}).bind(hideElement).bind(__deactivete())};ns.provide({registerElement:registerElement,closeBalloon:closeBalloon})});Namespace("jp.mixi.service.widget.balloonanchor").use("brook *").use("brook.util *").define(function(ns){"use strict";var WAIT_TIME=500;var initialize=function(elem,dataset){ns.promise().bind(ns.wait(WAIT_TIME)).bind(function(){var element=$j(elem);var balloon=document.getElementById(dataset.balloonId);if(!balloon){return}var jballoon=$j(balloon);var elementOffset=element.offset();var leftOffset=Math.floor(dataset.leftOffset||0);var topOffset=Math.floor(dataset.topOffset||0);var left=elementOffset.left+element.width()+leftOffset;var top=elementOffset.top+topOffset;var isOnlyTopOffset=dataset.isOnlyTopOffset||0;jballoon.css("left",left);if(isOnlyTopOffset){jballoon.css("top",topOffset)}else{jballoon.css("top",top)}jballoon.show();var diff=jballoon.offset().left-left;jballoon.hide();jballoon.css("left",left-diff);if(_.isFunction(jballoon.fadeIn)){jballoon.fadeIn("fast")}else{jballoon.show()}}).run()};ns.provide({registerElement:initialize})});Namespace("jp.mixi.news.model.check").use("brook promise").use("brook.model createModel").use("jp.co.mixi.gateway gateway").use("jp.co.mixi.net.jsonrpc JSONRPC").define(function(ns){"use strict";var rpc=ns.JSONRPC.createService("/system/rpc.json",{auth_type:"postkey",secret:ns.gateway("rpc_post_key"),internal_encoding:"euc-jp"});var rpcPromiseForCreate=rpc.createRPCPromise("jp.mixi.news.check");var createCheckModel=function(){var checkModel=ns.createModel();checkModel.addMethod("create",ns.promise().bind(rpcPromiseForCreate));return checkModel};var checkModel=createCheckModel();ns.provide({getCheckModel:function(){return checkModel}})});Namespace("jp.mixi.news.model.entry").use("brook promise").use("brook.model createModel").use("jp.co.mixi.gateway gateway").use("jp.co.mixi.net.jsonrpc JSONRPC").define(function(ns){"use strict";var rpc=ns.JSONRPC.createService("/system/rpc.json",{auth_type:"postkey",secret:ns.gateway("rpc_post_key"),internal_encoding:"euc-jp"});var createEntryModel=function(){var model=ns.createModel();model.addMethod("search",ns.promise().bind(rpc.createRPCPromise("jp.mixi.news.entry.search")));return model};var entryModel=createEntryModel();ns.provide({getEntryModel:function(){return entryModel}})});Namespace("jp.mixi.news.model.feedback").use("brook promise").use("brook.model createModel").use("jp.co.mixi.gateway gateway").use("jp.co.mixi.net.jsonrpc JSONRPC").define(function(ns){"use strict";var rpc=ns.JSONRPC.createService("/system/rpc.json",{auth_type:"postkey",secret:ns.gateway("rpc_post_key"),internal_encoding:"euc-jp"});var rpcPromiseForCreate=rpc.createRPCPromise("jp.mixi.plugins.favorite.createFavorite");var rpcPromiseForGetMember=rpc.createRPCPromise("jp.mixi.plugins.favorite.getMembers");var promiseForAlreadyCreated=rpcPromiseForGetMember.bind(ns.promise(function(n,v){var loginMemberId=ns.gateway("login_member_id");if(!loginMemberId){n({error:"login required"});return}if(v.response.error){n({error:v.response.error});return}if(!v.response.result){n({error:"no result"});return}if(v.response.result.error){n({error:v.response.result.error});return}var members=v.response.result.members;for(var i=0;i<members.length;i++){if(members[i].member_id==loginMemberId){n({result:true});return}}n({result:false})}));var createFeedbackModel=function(){var feedbackModel=ns.createModel();feedbackModel.addMethod("create",ns.promise().bind(rpcPromiseForCreate));feedbackModel.addMethod("getMembers",ns.promise().bind(rpcPromiseForGetMember));feedbackModel.addMethod("alreadyCreated",ns.promise().bind(promiseForAlreadyCreated));return feedbackModel};var feedbackModel=createFeedbackModel();ns.provide({getFeedbackModel:function(){return feedbackModel}})});Namespace("jp.mixi.news.model.quote").use("brook promise").use("brook.model createModel").use("brook.util cond").use("jp.co.mixi.gateway gateway").use("jp.co.mixi.net.jsonrpc JSONRPC").define(function(ns){"use strict";var rpc=ns.JSONRPC.createService("/system/rpc.json",{auth_type:"postkey",secret:ns.gateway("rpc_post_key"),internal_encoding:"euc-jp"});var rpcPromiseForGetDiaryEntries=rpc.createRPCPromise("jp.mixi.news.quote.diary.getEntries");var is_diary=function(param){return param.type=="diary"};var rpcPromiseForGetVoiceEntries=rpc.createRPCPromise("jp.mixi.news.quote.voice.getEntries");var is_voice=function(param){return param.type=="voice"};var createQuoteModel=function(){var quoteModel=ns.createModel();quoteModel.addMethod("getEntries",ns.promise().bind(ns.cond(is_diary,rpcPromiseForGetDiaryEntries)).bind(ns.cond(is_voice,rpcPromiseForGetVoiceEntries)));return quoteModel};var quoteModel=createQuoteModel();ns.provide({getQuoteModel:function(){return quoteModel}})});Namespace("jp.mixi.news.model.quote.level").use("jp.co.mixi.data.accessor createAccessor").define(function(ns){"use strict";var PUBLIC_VOICE_LEVEL=4;var data={level:PUBLIC_VOICE_LEVEL};var accessor=ns.createAccessor(data,["level"]);ns.provide({getSharedLevelModel:function(){return accessor},getPublicLevel:function(){return PUBLIC_VOICE_LEVEL}})});Namespace("jp.mixi.news.model.quote.member.mute").use("brook promise").use("brook.model createModel").use("jp.mixi.model.utils createRPCPromise").define(function(ns){"use strict";var PROCEDURE_PREFIX="jp.mixi.news.quote.voice.mute";var model;var createMuteMemberModel=function(){return ns.createModel({create:ns.promise().bind(ns.createRPCPromise(PROCEDURE_PREFIX+".createEntry")),delete:ns.promise().bind(ns.createRPCPromise(PROCEDURE_PREFIX+".deleteEntry"))})};var getMuteMemberModel=function(){if(!model){model=createMuteMemberModel()}return model};ns.provide({getMuteMemberModel:getMuteMemberModel})});Namespace("jp.mixi.news.model.quote.posthomefeed").use("jp.co.mixi.data.accessor createAccessor").define(function(ns){"use strict";var data={state:true};var accessor=ns.createAccessor(data,["state"]);ns.provide({getSharedPostHomeFeedModel:function(){return accessor}})});Namespace("jp.mixi.news.model.quote.service").use("jp.co.mixi.data.accessor createAccessor").define(function(ns){"use strict";var data={service:"voice"};var accessor=ns.createAccessor(data,["service"]);ns.provide({getSharedServiceModel:function(){return accessor}})});Namespace("jp.mixi.news.model.quote.textcounter").use("jp.co.mixi.lang.string countByteLength").use("jp.mixi.news.model.quote.service getSharedServiceModel").use("jp.mixi.news.model.quote.twittersync getSharedTwitterSyncModel").define(function(ns){"use strict";var mixiMaxLength=150;var twitterMaxLength=140;var serviceModel=ns.getSharedServiceModel();var twitterSyncModel=ns.getSharedTwitterSyncModel();var getBodyLengthAndMaxLength=function(body,newsQuote,commentDelimiter){var currentService=serviceModel.funcGet().service;var getBodyLengthForMixi=function(){return Math.ceil(ns.countByteLength(getBody(),2)/2)};var getBodyLengthForTwitter=function(){return getBody().length};var getBody=function(){var quoteText;if(currentService=="voice"){quoteText=commentDelimiter+newsQuote}else{quoteText=""}return body+quoteText};var twitterSyncEnabled=twitterSyncModel.funcGet().state&&currentService=="voice";return{maxLength:twitterSyncEnabled?twitterMaxLength:mixiMaxLength,currentLength:twitterSyncEnabled?getBodyLengthForTwitter():getBodyLengthForMixi()}};ns.provide({getBodyLengthAndMaxLength:getBodyLengthAndMaxLength})});Namespace("jp.mixi.news.model.quote.twittersync").use("jp.co.mixi.data.accessor createAccessor").define(function(ns){"use strict";var data={state:false};var accessor=ns.createAccessor(data,["state"]);ns.provide({getSharedTwitterSyncModel:function(){return accessor}})});Namespace("jp.mixi.news.model.voice").use("brook promise").use("brook.model createModel").use("jp.co.mixi.gateway gateway").use("jp.co.mixi.net.jsonrpc JSONRPC").define(function(ns){"use strict";var rpc=ns.JSONRPC.createService("/system/rpc.json",{auth_type:"postkey",secret:ns.gateway("rpc_post_key"),internal_encoding:"euc-jp"});var rpcPromiseForCreate=rpc.createRPCPromise("jp.mixi.voice.create");var createVoiceModel=function(){var voiceModel=ns.createModel();voiceModel.addMethod("create",ns.promise().bind(rpcPromiseForCreate));return voiceModel};var voiceModel=createVoiceModel();ns.provide({getVoiceModel:function(){return voiceModel}})});Namespace("jp.mixi.news.pc.component.ranking.categoryselector").define(function(ns){"use strict";var categorySelector=function(element){$j(element).change(function(e){var url=$j(this).val();if(url){window.location.href=url}})};ns.provide({registerElement:categorySelector})});Namespace("jp.mixi.news.ui.pc.checkwindow").define(function(ns){"use strict";var openCheckWindow=function(shareUrl){window.open(shareUrl,"share",["width=632","height=456","location=yes","resizable=yes","toolbar=no","menubar=no","scrollbars=no","status=no"].join(","))};ns.provide({openCheckWindow:openCheckWindow})});Namespace("jp.mixi.news.ui.photogroup.navigator").use("brook.channel sendChannel").use("flipsnap Flipsnap").use("jp.co.mixi.lang.class defineClass").use("jp.co.mixi.gateway gateway").use("jp.co.mixi.ui.template getTemplateByElementId").define(function(ns){"use strict";var SELECT_THUMBNAIL_CHANNEL=ns.CURRENT_NAMESPACE+".selectThumbnail";var PhotoGroupNavigator=ns.defineClass({moveToIndex:function(index){this.flipsnap.moveToPoint(this.getPageFromIndex(index));this.selectThumbnail(index)},initialize:function(element,data){this.jRoot=$j(element);this.jNavContainer=this.jRoot.find(data.navContainerSelector);this.jNavPhotoList=this.jRoot.find(data.navPhotoListSelector);this.jNavNextButton=this.jRoot.find(data.navNextButtonSelector);this.jNavPrevButton=this.jRoot.find(data.navPrevButtonSelector);this.thumbnailSelector=data.thumbnailSelector;this.entryList=ns.gateway("news_entry_list");this.classForSelected=data.classForSelected;this.flipsnap=undefined;this.currentPosition=0;this.thumbnailsPerPage=0;this.assignPhotoList();this.initFlipsnap();this.updateUI();var self=this;this.jNavNextButton.click(function(){self.onNextButtonClick()});this.jNavPrevButton.click(function(){self.onPrevButtonClick()});this.jNavPhotoList.find("a").click(function(e){self.onThumbnailButtonClick(e)})},assignPhotoList:function(){var template=ns.getTemplateByElementId("photo_group_thumbnail_row");template.param({news_entry_list:this.entryList});var html=template.output();this.jNavPhotoList.html(html)},initFlipsnap:function(){this.currentPosition=0;var navigatorWidth=this.jNavContainer.width();var thumbnailWidth=this.jNavPhotoList.children().last().outerWidth({margin:true});this.thumbnailsPerPage=Math.floor(navigatorWidth/thumbnailWidth);this.flipsnap=ns.Flipsnap(this.jNavPhotoList.get(0),{distance:thumbnailWidth*this.thumbnailsPerPage,maxPoint:Math.ceil(this.entryList.length/this.thumbnailsPerPage)-1});this.jNavPhotoList.width(thumbnailWidth*this.entryList.length);var self=this;$j(this.flipsnap.element).on("fsmoveend",function(){self.currentPosition=self.flipsnap.currentPoint;self.updateUI()})},onNextButtonClick:function(){this.flipsnap.toNext()},onPrevButtonClick:function(){this.flipsnap.toPrev()},onThumbnailButtonClick:function(event){var target=this.jRoot.find(event.currentTarget).closest(this.thumbnailSelector);var index=this.jNavPhotoList.children().index(target);this.selectThumbnail(index);ns.sendChannel(SELECT_THUMBNAIL_CHANNEL).run({index:index})},updateUI:function(){var entry=this.entryList[this.currentPosition];this.setVisibility(this.jNavNextButton,this.flipsnap.hasNext());this.setVisibility(this.jNavPrevButton,this.flipsnap.hasPrev())},selectThumbnail:function(index){this.jNavPhotoList.children().removeClass(this.classForSelected);this.jNavPhotoList.children().eq(index).addClass(this.classForSelected);this.flipsnap.moveToPoint(this.getPageFromIndex(index))},setVisibility:function(jElement,isVisible){if(isVisible){jElement.show()}else{jElement.hide()}},getPageFromIndex:function(index){return Math.floor(index/this.thumbnailsPerPage)}});ns.provide({PhotoGroupNavigator:function(element,data){return new PhotoGroupNavigator(element,data)}})});Namespace("jp.mixi.news.ui.photogroup.view").use("brook.channel sendChannel").use("flipsnap Flipsnap").use("jp.co.mixi.lang.class defineClass").use("jp.co.mixi.gateway gateway").use("jp.co.mixi.ui.template getTemplateByElementId").use("jp.co.mixi.net.storage Storage").use("jp.mixi.service.analysis postUIEventLog").define(function(ns){"use strict";var STORAGE_KEY_PREFIX="point_for_group_";var EXPIRE_TIME=1e3*60*60;var SHARE_BUTTON_CLICK_EVENT_NAME="news.photogroup.entry.share";var SET_NEWS_CHANNEL=ns.CURRENT_NAMESPACE+".setNews";var NO_IMG_FILE="/img/smartphone/touch/common/noimage002.png";var UI_EVENT_NAME_SHOW="news.photogroup.view.entry.show";var PhotoGroupViewer=ns.defineClass({moveToPoint:function(index){this.flipsnap.moveToPoint(index)},initialize:function(element,data){this.jRoot=$j(element);this.jPhotoList=this.jRoot.find(data.photoListSelector);this.jTitle=this.jRoot.find(data.titleSelector);this.jDescription=this.jRoot.find(data.descriptionSelector);this.jNewsId=this.jRoot.find(data.newsIdSelector);this.jMediaLink=this.jRoot.find(data.mediaLinkSelector);this.jMediaCopyright=this.jRoot.find(data.mediaCopyrightSelector);this.jPublishedAt=this.jRoot.find(data.publishedAtSelector);this.jNextButton=this.jRoot.find(data.nextButtonSelector);this.jPrevButton=this.jRoot.find(data.prevButtonSelector);this.jFacebookButton=this.jRoot.find(data.facebookButtonSelector);this.jLineButton=this.jRoot.find(data.lineButtonSelector);this.jTwitterButton=this.jRoot.find(data.twitterButtonSelector);this.jQuoteDescription=this.jRoot.find(data.quoteDescriptionSelector);this.entryList=ns.gateway("news_entry_list");this.groupId=ns.gateway("group_id");this.startNewsId=ns.gateway("start_news_id");this.urlNewsPrefixSSL=ns.gateway("url_news_prefix_ssl");this.loginMemberId=ns.gateway("login_member_id");this.viewerWidth=data.viewerWidth;this.flipsnap=undefined;this.currentPosition=0;this.shareInfoForCurrentPosition=undefined;this.setNewsTimerId=undefined;this.assignPhotoList();this.initFlipsnap(this.getStartPoint());this.showEntry();var self=this;$j(window).resize(function(){self.onResize()});this.jNextButton.click(function(){self.onNextButtonClick()});this.jPrevButton.click(function(){self.onPrevButtonClick()});this.jFacebookButton.click(this.makeShareButtonEventHandler(self,"facebook"));this.jLineButton.click(this.makeShareButtonEventHandler(self,"line"));this.jTwitterButton.click(this.makeShareButtonEventHandler(self,"twitter"))},assignPhotoList:function(){var template=ns.getTemplateByElementId("photo_group_entry_row");template.param({news_entry_list:this.entryList});var html=template.output();this.jPhotoList.html(html)},getStartPoint:function(){if(this.startNewsId){for(var i=0;i<this.entryList.length;i++){if(this.entryList[i].news_id==this.startNewsId){return i}}}if(ns.Storage.isAvailable()){return ns.Storage.load(ns.CURRENT_NAMESPACE,STORAGE_KEY_PREFIX+this.groupId)||0}return 0},initFlipsnap:function(startPoint){this.currentPosition=startPoint;var width=this.viewerWidth?this.viewerWidth:this.jRoot.width();this.flipsnap=ns.Flipsnap(this.jPhotoList.get(0),{distance:width});this.jPhotoList.width(width*this.entryList.length);this.flipsnap.moveToPoint(startPoint);var self=this;$j(this.flipsnap.element).on("fsmoveend",function(){self.currentPosition=self.flipsnap.currentPoint;self.showEntryWithDelay()})},onResize:function(){if(this.viewerWidth)return;var width=this.jRoot.width();this.jPhotoList.width(width*this.entryList.length);this.flipsnap.distance=width;this.flipsnap.refresh()},onNextButtonClick:function(){this.flipsnap.toNext()},onPrevButtonClick:function(){this.flipsnap.toPrev()},makeShareButtonEventHandler:function(self,service){return function(evt){evt.preventDefault();var url=self.shareInfoForCurrentPosition.url[service];var pageName=self.shareInfoForCurrentPosition.pageName[service];ns.postUIEventLog(SHARE_BUTTON_CLICK_EVENT_NAME,pageName,function(){location.href=url})}},showEntryWithDelay:function(){this.loadPhotoWithDelay(50);this.setNewsWithDelay(300);this.postShowEntryLog()},showEntry:function(){this.loadPhoto();this.setNews();this.postShowEntryLog()},setNewsWithDelay:function(delay){if(this.setNewsTimerId){clearTimeout(this.setNewsTimerId)}var self=this;this.setNewsTimerId=setTimeout(function(){self.setNews();self.setNewsTimerId=null},delay);this.saveCurrentPoint(this.flipsnap.currentPoint)},setNews:function(){var entry=this.entryList[this.currentPosition];this.setShareInfo();this.jTitle.text(entry.original_title).attr("href",entry.news_url);this.jDescription.html(entry.description);this.jDescription.toggleClass("decoratable",entry.can_decorate_description?true:false);this.jQuoteDescription.html(entry.quote_voice_info.title+" "+entry.quote_voice_info.short_url);this.jNewsId.text(entry.news_id);this.jMediaLink.text(entry.media_name).attr("href",entry.media_url);this.jMediaCopyright.text(entry.media_copyright);this.jPublishedAt.text(this.formatDate(entry.created_at));this.setVisibility(this.jNextButton,this.flipsnap.hasNext());this.setVisibility(this.jPrevButton,this.flipsnap.hasPrev());ns.sendChannel(SET_NEWS_CHANNEL).run({entry:entry,viewer:this,index:this.currentPosition})},formatDate:function(datestring){var date=new Date(datestring.replace(/-/g,"/"));return date.getFullYear()+"年"+(date.getMonth()+1)+"月"+date.getDate()+"日 "+date.getHours()+"時"+date.getMinutes()+"分"},setShareInfo:function(){var entry=this.entryList[this.currentPosition];var newsUrl=this.urlNewsPrefixSSL+"view_photo_group.pl?group_id="+this.groupId+"&start_news_id="+entry.news_id;var newsShareUrl=newsUrl+"&share_from=view_photo_group";var url={newsUrl:newsUrl,facebook:"http://www.facebook.com/sharer.php?u="+encodeURIComponent(newsShareUrl+"&from=facebook"),line:"http://line.me/R/msg/text/?"+encodeURIComponent(entry.quote_voice_info.title+"\r\n"+newsShareUrl+"&from=line"),twitter:"http://twitter.com/share?text="+encodeURIComponent(entry.quote_voice_info.title)+"&url="+encodeURIComponent(newsShareUrl+"&from=twitter")};var pageName={};var self=this;_.each(["facebook","line","twitter"],function(shareTo){pageName[shareTo]="group_id="+self.groupId+"&news_id="+entry.news_id+"&share_to="+shareTo+"&share_from=view_photo_group"});this.shareInfoForCurrentPosition={url:url,pageName:pageName}},loadPhotoWithDelay:function(delay){var self=this;setTimeout(function(){self.loadPhoto()},delay)},loadPhoto:function(){var showError=function(){jImg.attr("src",NO_IMG_FILE)};for(var i=-1;i<=1;i++){var tmpPos=this.currentPosition+i;if(tmpPos<0||tmpPos>=this.entryList.length)continue;var entry=this.entryList[tmpPos];var jImg=this.jPhotoList.find("img").eq(tmpPos);jImg.on("error",showError);jImg.attr("src",entry.original_image_url);jImg.show()}},setVisibility:function(jElement,isVisible){if(isVisible){jElement.show()}else{jElement.hide()}},saveCurrentPoint:function(currentPoint){if(ns.Storage.isAvailable()){var expireDate=new Date((new Date).getTime()+EXPIRE_TIME);ns.Storage.save(ns.CURRENT_NAMESPACE,STORAGE_KEY_PREFIX+this.groupId,currentPoint,expireDate)}},postShowEntryLog:function(){var entry=this.entryList[this.currentPosition];var eventName=UI_EVENT_NAME_SHOW;var pageName="group_id="+this.groupId+"&news_id="+entry.news_id;ns.postUIEventLog(eventName,pageName)}});ns.provide({PhotoGroupViewer:function(element,data){return new PhotoGroupViewer(element,data)}})});Namespace("jp.mixi.news.ui.togglebutton").use("jp.co.mixi.lang.class defineClass").use("brook.util through").define(function(ns){"use strict";var TOOLTIP_SHOW_DURATION_SP=1800;var TOOLTIP_SHOW_DURATION_PC=700;var ToggleButton=ns.defineClass({initialize:function(args){var self=this;self.jElement=args.element;self.jButton=args.button;self.jTooltip=args.tooltip;self.onMessage=args.onMessage;self.offMessage=args.offMessage;self.toggleModel=args.toggleModel;self.defaultState=args.defaultState||false;self.jButton.click(function(){var currentState=self.jElement.hasClass("on");var newState=!currentState;self.toggleModel.notify("set").run({state:newState})});var onChangeButtonState=ns.through(function(value){if(value.state){self.jElement.removeClass("off").addClass("on");self.jTooltip.html(self.onMessage)}else{self.jElement.removeClass("on").addClass("off");self.jTooltip.html(self.offMessage)}if(!value.preventTooltip){self.showTooltip()}});self.toggleModel.method("set").observe(onChangeButtonState);self.toggleModel.notify("set").run({state:self.defaultState,preventTooltip:true})},showTooltip:function(){var self=this;if(self.jTooltip.fadeTo){self.jTooltip.stop(true,true).fadeTo("normal",1).delay(TOOLTIP_SHOW_DURATION_PC).fadeOut("normal")}else{self.jTooltip.css("-webkit-animation","none").css("animakit-animation","none").css("opacity",0).animate("tooltipBalloonFadeInOut",TOOLTIP_SHOW_DURATION_SP,"linear",function(){self.jTooltip.hide()}).show()}}});ns.provide({ToggleButton:ToggleButton})});Namespace("jp.mixi.news.widget.admin.modificationlocker").use("jp.co.mixi.lang.class defineClass").define(function(ns){"use strict";var ModificationLocker=ns.defineClass({initialize:function(element,dataset){var self=this;self.jElement=$j(element);self.jLockTarget=self.jElement.find(dataset.modificationLockTargetClass);self.jLocker=self.jElement.find(dataset.modificationLockerClass);self.bindClickEvent()},bindClickEvent:function(){var self=this;self.jLocker.click(function(evt){self.jLockTarget.prop("readonly",!self.jLockTarget.prop("readonly"))})}});ns.provide({registerElement:function(element,dataset){new ModificationLocker(element,dataset)}})});Namespace("jp.mixi.news.widget.admin.photogroup.photopanel").define(function(ns){"use strict";var ENOUGH_WIDTH=640;var ENOUGH_HEIGHT=640;var initialize=function(element){var jRoot=$j(element);var jImg=jRoot.find("img");var setImageSize=function(){var w=jImg[0].naturalWidth;var h=jImg[0].naturalHeight;if(!w||!h)return;if(w<ENOUGH_WIDTH&&h<ENOUGH_HEIGHT){jImg.css("max-width",jRoot.width()*w/ENOUGH_WIDTH);jImg.css("max-height",jRoot.height()*h/ENOUGH_HEIGHT)}};if(jImg[0].complete){setImageSize()}else{jImg.load(setImageSize)}};ns.provide({registerElement:initialize})});Namespace("jp.mixi.news.widget.admin.recommend").use("brook.dom.compat dataset").use("jp.co.mixi.gateway gateway").use("jp.co.mixi.lang.class defineClass").use("jp.co.mixi.ui.template getTemplateByElementId").define(function(ns){"use strict";var TEMPLATE_NAME="recommend_news_snippet";var recommendEntries=ns.gateway("recommend_news_loop");var Recommend=ns.defineClass({initialize:function(elem){this.element=$j(elem);this.selector=this.element.find(".JS_sortSelector");this.filterSwitch=this.element.find(".JS_filterEditedOnly");this.area=this.element.find(".JS_recommendArea");this.checkedMap={};var _self=this;this.selector.bind("change",function(evt){_self.changeSort();evt.stopPropagation();evt.preventDefault()});this.filterSwitch.bind("change",function(evt){_self.changeSort();evt.stopPropagation();evt.preventDefault()});_self.changeSort()},changeSort:function(){var sortKey=this.selector.val();var isEditedOnly=this.filterSwitch.attr("checked")==="checked";var template=ns.getTemplateByElementId(TEMPLATE_NAME);var newsList=recommendEntries.concat();if(isEditedOnly){newsList=_.filter(newsList,function(entry){var editedTitle=entry["edited_title"];return editedTitle&&editedTitle!==""})}if(sortKey!=="default"){newsList.sort(function(a,b){return a[sortKey]<b[sortKey]?1:0})}var checkedMap=this.checkedMap;newsList.each(function(entry){var sortParams=entry.sort_params;sortParams.each(function(param){param["is_selected"]=param.name===sortKey});entry.checked=!!checkedMap[entry.news_id]});template.param({recommend_news_loop:newsList,recommend_sort_key:sortKey});this.area.html(template.output());this.registerCheckEvent()},registerCheckEvent:function(){var _self=this;_self.element.find(".JS_recommendCheck").on("change",function(evt){var newsId=ns.dataset(this).newsId;_self.checkedMap[newsId]=this.checked;evt.stopPropagation();evt.preventDefault()})}});ns.provide({registerElement:function(elem){new Recommend(elem)}})});Namespace("jp.mixi.news.widget.category.select").use("jp.co.mixi.lang.class defineClass").define(function(ns){"use strict";var CategorySelect=ns.defineClass({initialize:function(element,data){var _self=this;_self.jSelectElement=$j(element);_self.url=data.url;_self.type=data.type;_self.categoryId=data.categoryId;_self.date=data.date;_self.jSelectElement.change(function(){window.location.href=_self.createUrl(_self.jSelectElement.val())})},createUrl:function(subCategoryId){return this.url+"?type="+this.type+"&category_id="+this.categoryId+"&sub_category_id="+subCategoryId+"&date="+this.date}});ns.provide({registerElement:function(element,data){new CategorySelect(element,data)}})});Namespace("jp.mixi.news.widget.check.button.pc").use("jp.mixi.news.ui.pc.checkwindow openCheckWindow").define(function(ns){"use strict";ns.provide({registerElement:function(element,data){$j(element).click(function(){ns.openCheckWindow(data.shareUrl)})}})});Namespace("jp.mixi.news.widget.emoji.button.pc").use("jp.co.mixi.emojiPaletteLoader EmojiPaletteLoader").use("jp.co.mixi.lang.class defineClass").define(function(ns){"use strict";var EMOJI_ICON_HALF_HEIGHT=11;var EmojiButton=ns.defineClass({initialize:function(element,data){var self=this;self.jTextAreaElement=$j(data.textAreaElementId);self.emojiPaletteLoader=ns.EmojiPaletteLoader();self.emojiPaletteLoader.loadEmojiPalette();$j(element).click(function(event){self.clickEvent(event)})},clickEvent:function(event){var self=this;event.preventDefault();event.stopPropagation();window.openEmojiPalette(self.jTextAreaElement.get(0),event);var emojiPaletteBase=self.emojiPaletteLoader.getEmojiPaletteBase();var emojiPaletteOffset=emojiPaletteBase.getDimensions();$j(emojiPaletteBase).css({top:emojiPaletteBase.offsetTop-emojiPaletteOffset.height-EMOJI_ICON_HALF_HEIGHT+"px"})}});ns.provide({registerElement:function(element,data){new EmojiButton(element,data)}})});Namespace("jp.mixi.news.widget.photogroup.view").use("brook.channel channel").use("brook.util through").use("jp.co.mixi.gateway gateway").use("jp.mixi.news.ui.photogroup.view PhotoGroupViewer").use("jp.mixi.news.ui.photogroup.navigator PhotoGroupNavigator").use("jp.mixi.news.ui.pc.checkwindow openCheckWindow").define(function(ns){"use strict";var CHECK_SERVICE_KEY="53be64390c2bf14912cc8ded09c28d346a7a28b0";var VIEWER_SET_NEWS_CHANNEL="jp.mixi.news.ui.photogroup.view.setNews";var NAVIGATOR_SELECT_THUMBNAIL_CHANNEL="jp.mixi.news.ui.photogroup.navigator.selectThumbnail";var photoGroupViewer=function(element,data){var jRoot=$j(element);var jTotalSharedCount=jRoot.find(data.totalSharedCountSelector);var jPrivateQuoteCount=jRoot.find(data.privateQuoteCountSelector);var jPrivateQuoteContainer=jRoot.find(data.privateQuoteContainerSelector);var jCheckButton=jRoot.find(data.checkButtonSelector);var jQuoteDescription=jRoot.find(data.quoteDescriptionSelector);var jAddDiaryLink=jRoot.find(data.addDiaryLinkSelector);var jRelationalPost=jRoot.find(data.relationalPostSelector);var jQuoteVoiceArea=jRoot.find(data.quoteVoiceAreaSelector);var jQuoteVoiceCount=jRoot.find(data.quoteVoiceCountSelector);var jQuoteVoiceLink=jRoot.find(data.quoteVoiceLinkSelector);var jQuoteVoiceCountContainer=jRoot.find(data.quoteVoiceCountContainerSelector);var jQuoteVoiceAuthor=jRoot.find(data.quoteVoiceAuthorSelector);var jQuoteVoiceBody=jRoot.find(data.quoteVoiceBodySelector);var jQuoteVoiceFeedbackCount=jRoot.find(data.quoteVoiceFeedbackCountSelector);var jQuoteVoiceCommentCount=jRoot.find(data.quoteVoiceCommentCountSelector);var jQuoteVoiceCommentLink=jRoot.find(data.quoteVoiceCommentLinkSelector);var jQuoteDiaryArea=jRoot.find(data.quoteDiaryAreaSelector);var jQuoteDiaryCount=jRoot.find(data.quoteDiaryCountSelector);var jQuoteDiaryLink=jRoot.find(data.quoteDiaryLinkSelector);var jQuoteDiaryCountContainer=jRoot.find(data.quoteDiaryCountContainerSelector);var jQuoteDiaryAuthor=jRoot.find(data.quoteDiaryAuthorSelector);var jQuoteDiaryTitle=jRoot.find(data.quoteDiaryTitleSelector);var jQuoteDiaryBody=jRoot.find(data.quoteDiaryBodySelector);var jQuoteDiaryViewLink=jRoot.find(data.quoteDiaryViewLinkSelector);var loginMemberId=ns.gateway("login_member_id");var mixiPrefixSSL=ns.gateway("url_mixi_prefix_ssl");var mixiNewsPrefixSSL=ns.gateway("url_news_prefix_ssl");var photoGroupViewer;var navigator;var initialize=function(){ns.channel(VIEWER_SET_NEWS_CHANNEL).observe(setNewsPromise);ns.channel(NAVIGATOR_SELECT_THUMBNAIL_CHANNEL).observe(onThumbnailSelectPromise);navigator=ns.PhotoGroupNavigator(element,data);photoGroupViewer=ns.PhotoGroupViewer(element,data);jCheckButton.click(onClickCheckButton)};var onClickCheckButton=function(){var shareUrl=mixiPrefixSSL+"share.pl?k="+CHECK_SERVICE_KEY+"&u="+encodeURIComponent(photoGroupViewer.shareInfoForCurrentPosition.url.newsUrl);ns.openCheckWindow(shareUrl)};var setNewsPromise=ns.through(function(value){var entry=value.entry;var index=value.index;var quoteVoiceLink=mixiNewsPrefixSSL+"list_quote.pl?sort=feedback_count&type=voice&news_id="+entry.news_id;var quoteDiaryLink=mixiNewsPrefixSSL+"list_quote.pl?sort=feedback_count&type=diary&news_id="+entry.news_id;var addDiaryLink=mixiPrefixSSL+"add_diary.pl?id="+loginMemberId+"&news_id="+entry.news_id+"&diary_body="+entry.quote_diary_info.body+"&news_title="+entry.quote_diary_info.title+"&news_url="+entry.quote_diary_info.news_url+"&via=photogroup";jTotalSharedCount.text(entry.total_shared_count);jQuoteVoiceCount.text(entry.quote_voice_count);jQuoteDiaryCount.text(entry.quote_diary_count);var privateCount=entry.total_shared_count-entry.quote_voice_count-entry.quote_diary_count;jPrivateQuoteCount.text(privateCount);setVisibility(jPrivateQuoteContainer,privateCount>0);jQuoteVoiceLink.attr("href",quoteVoiceLink);setVisibility(jQuoteVoiceCountContainer,entry.quote_voice_count>0);jQuoteDiaryLink.attr("href",quoteDiaryLink);setVisibility(jQuoteDiaryCountContainer,entry.quote_diary_count>0);jAddDiaryLink.attr("href",addDiaryLink);setVisibility(jRelationalPost,loginMemberId||entry.quote_voice_count||entry.quote_diary_count);setQuoteVoice(entry);setQuoteDiary(entry);if(navigator){navigator.moveToIndex(index)}});var onThumbnailSelectPromise=ns.through(function(value){setTimeout(function(){photoGroupViewer.moveToPoint(value.index)},100)});var setQuoteVoice=function(entry){var voice=entry.voice;if(!voice){jQuoteVoiceArea.hide();return}jQuoteVoiceBody.html(voice.body_with_emoji_view_html);var voiceThumbnail=$j("<img>").attr("src",voice.member_thumbnail_url).attr("alt",voice.member_nickname);jQuoteVoiceAuthor.html("").append(voiceThumbnail).append(voice.member_nickname).attr("href",voice.url_show_friend);jQuoteVoiceFeedbackCount.text(voice.feedback_count);jQuoteVoiceCommentCount.text(voice.comment_count);jQuoteVoiceCommentLink.attr("href",voice.url_view_voice);jQuoteVoiceArea.show()};var setQuoteDiary=function(entry){var diary=entry.diary;if(!diary){jQuoteDiaryArea.hide();return}jQuoteDiaryTitle.text(diary.title);jQuoteDiaryBody.html(diary.body_with_emoji_view_html);var diaryThumbnail=$j("<img>").attr("src",diary.member_thumbnail_url).attr("alt",diary.member_nickname);jQuoteDiaryAuthor.html("").append(diaryThumbnail).append(diary.member_nickname).attr("href",diary.url_show_friend);jQuoteDiaryViewLink.attr("href",diary.url_view_diary);jQuoteDiaryArea.show()};var setVisibility=function(jElement,isVisible){if(isVisible){jElement.show()}else{jElement.hide()}};initialize()};ns.provide({registerElement:photoGroupViewer})});Namespace("jp.mixi.news.widget.postuievent").use("jp.mixi.service.analysis postUIEventLog").define(function(ns){"use strict";ns.provide({registerElement:function(element,dataset){$j(element).on("click",function(evt){evt.preventDefault();ns.postUIEventLog(dataset.eventName,dataset.pageName,function(){location.href=element.href})})}})});Namespace("jp.mixi.news.widget.quote.feedback").use("brook promise").use("jp.co.mixi.gateway gateway").use("jp.co.mixi.lang.class defineClass").use("jp.co.mixi.lang parseIntAsDecimal").use("jp.mixi.model.feedback createFeedbackModel").define(function(ns){"use strict";var MESSAGE_FAILED_FEEDBACK="この投稿にイイネできません";var QuoteFeedback=ns.defineClass({initialize:function(element,data){var self=this;self.feedbackClass=data.feedbackClass;self.feedbackCountClass=data.feedbackCountClass;self.jFeedback=$j(element);var feedbackModel=ns.createFeedbackModel("voice",{id:data.postTime,owner_id:data.ownerId});self.jFeedback.find(self.feedbackClass).click(function(){ns.promise().bind(ns.promise(self.beforeFeedbackFunc())).bind(feedbackModel.notify("create")).bind(ns.promise(self.afterFeedbackFunc())).run()});var memberId=ns.parseIntAsDecimal(ns.gateway("login_member_id"));if(data.isFeedbacked||data.ownerId==memberId){self.off()}},beforeFeedbackFunc:function(){var self=this;return function(next,param){self.off();next(param)}},afterFeedbackFunc:function(){var self=this;return function(next,param){if(param.response.result){var jCounter=self.jFeedback.find(self.feedbackCountClass);jCounter.text(ns.parseIntAsDecimal(jCounter.text())+1)}else{alert(MESSAGE_FAILED_FEEDBACK)}}},off:function(){var self=this;self.jFeedback.find(self.feedbackClass).hide()}});ns.provide({registerElement:function(element,data){new QuoteFeedback(element,data)}})});Namespace("jp.mixi.news.widget.quote.form").use("brook promise").use("jp.co.mixi.gateway gateway").use("jp.co.mixi.lang.class defineClass").use("jp.co.mixi.lang parseIntAsDecimal").use("jp.mixi.news.model.voice getVoiceModel").use("jp.mixi.news.model.quote.level getSharedLevelModel").use("jp.mixi.news.model.quote.twittersync getSharedTwitterSyncModel").use("jp.mixi.news.model.quote.posthomefeed getSharedPostHomeFeedModel").define(function(ns){"use strict";var PUBLIC_LEVEL=4;var BLOCKED_REQUEST_CODE=-32098;var QuoteSubmitVoice=ns.defineClass({initialize:function(element,data){var self=this;self.jElement=$j(element);self.jSubmitElement=self.jElement.find(data.submitElement);self.jReplaceQuoteTextElement=self.jElement.find(data.replaceQuoteTextElement);self.jBodyElement=self.jElement.find(data.bodyElement);self.jQuoteTextElement=self.jElement.find(data.quoteTextElement);self.jFailedElement=self.jElement.find(data.failedElement);self.jBlockedElement=self.jElement.find(data.blockedElement);self.jNewsIdElement=self.jElement.find(data.newsIdElement);self.newsId=data.newsId;if(data.skipPostFeedElement)self.jSkipPostFeedElement=self.jElement.find(data.skipPostFeedElement);if(data.twitterSyncElement)self.jTwitterSyncElement=self.jElement.find(data.twitterSyncElement);if(data.levelElement)self.jLevelElement=self.jElement.find(data.levelElement);self.commentDelimiter=data.commentDelimiter;self.locationHref=data.locationHref;self.via=data.via;var memberId=ns.parseIntAsDecimal(ns.gateway("login_member_id"));var voiceModel=ns.getVoiceModel();self.jSubmitElement.click(function(e){e.preventDefault();var postParam={viewer_id:memberId,owner_id:memberId,body:self.getBody(),level:self.getLevel(),news_id:self.getNewsId(),via:self.via,twitter_sync:self.getTwitterSync(),skip_post_feed:self.getSkipHomeFeed()};ns.promise().bind(voiceModel.notify("create")).bind(ns.promise(self.afterSubmitVoiceFunc())).run(postParam)})},afterSubmitVoiceFunc:function(){var self=this;return function(next,param){if(param.response.result){self.jBodyElement.val("");self.jQuoteTextElement.hide();self.fadeOut(self.jReplaceQuoteTextElement);self.fadeIn(self.jReplaceQuoteTextElement);if(self.locationHref&&param.request.level==PUBLIC_LEVEL){window.location.href=self.locationHref}}else{if(BLOCKED_REQUEST_CODE===param.response.error.code){self.fadeIn(self.jBlockedElement)}else{self.fadeIn(self.jFailedElement)}}}},getBody:function(){var self=this;var body=self.jBodyElement.val();return body?body+self.commentDelimiter+self.jQuoteTextElement.text():self.jQuoteTextElement.text()},getNewsId:function(){var self=this;return self.newsId?self.newsId:ns.parseIntAsDecimal(self.jNewsIdElement.text())},getLevel:function(){var self=this;return self.jLevelElement?self.jLevelElement.val():ns.getSharedLevelModel().funcGet().level},getTwitterSync:function(){var self=this;return self.jTwitterSyncElement?self.jTwitterSyncElement.prop("checked"):ns.getSharedTwitterSyncModel().funcGet().state},getSkipHomeFeed:function(){var self=this;return self.jSkipPostFeedElement?self.jSkipPostFeedElement.prop("checked"):!ns.getSharedPostHomeFeedModel().funcGet().state},fadeIn:function(jElement){return jElement.fadeIn?jElement.fadeIn("slow"):jElement.show()},fadeOut:function(jElement){return jElement.fadeOut?jElement.fadeOut("slow"):jElement.hide()}});ns.provide({registerElement:function(element,data){new QuoteSubmitVoice(element,data)}})});Namespace("jp.mixi.news.widget.quote.form.deprecated.level").use("brook.channel sendChannel").use("jp.co.mixi.lang.class defineClass").define(function(ns){"use strict";var SelectVoiceLevel=ns.defineClass({initialize:function(elem,dataset){this.element=elem;this.dataset=dataset;this.registerHandler()},registerHandler:function(){var _self=this;ns.sendChannel("jp.mixi.news.widget.quote.voice.level.changed").run({level:parseInt(_self.dataset.defaultVoiceLevel,10)});if(parseInt(_self.dataset.isPremium,10)===1&&parseInt(_self.dataset.defaultVoiceLevel,10)===parseInt(_self.dataset.publicVoiceLevel,10)){$j(_self.dataset.checkboxElement).show();$j(_self.dataset.checkboxLabelElement).show()}_self.element.change(function(){ns.sendChannel("jp.mixi.news.widget.quote.voice.level.changed").run({level:parseInt($j(_self.element).val(),10)});if(parseInt(_self.dataset.isPremium,10)===0){return}if(parseInt($j(_self.element).val(),10)===parseInt(_self.dataset.publicVoiceLevel,10)){$j(_self.dataset.checkboxElement).show();$j(_self.dataset.checkboxLabelElement).show()}else{$j(_self.dataset.checkboxElement).hide();$j(_self.dataset.checkboxLabelElement).hide()}})}});ns.provide({registerElement:function(elem,dataset){new SelectVoiceLevel($j(elem),dataset)}})});Namespace("jp.mixi.news.widget.quote.form.deprecated.saveskipfeed").use("jp.co.mixi.net.storage Storage").use("jp.co.mixi.lang.class defineClass").define(function(ns){"use strict";var STORAGE_NAMESPACE="jp.mixi.news.widget.quote.voice.saveskipfeed";var SELECTED_SERVICE_KEY="checked_service";var EXPIRE_TIME=1e3*60*60*24*30;var SkipFeedCheckBox=ns.defineClass({initialize:function(elem,dataset){this.element=elem;var service=Boolean(parseInt(dataset.defaultService,10));if(ns.Storage.isAvailable()){service=ns.Storage.load(STORAGE_NAMESPACE,SELECTED_SERVICE_KEY)}if(service===true){$j(elem).prop("checked",true)}else{$j(elem).prop("checked",false)}this.registerHandler()},registerHandler:function(){var _self=this;_self.element.click(function(){if(ns.Storage.isAvailable()){var expireDate=new Date((new Date).getTime()+EXPIRE_TIME);ns.Storage.save(STORAGE_NAMESPACE,SELECTED_SERVICE_KEY,_self.element.prop("checked"),expireDate)}})}});ns.provide({registerElement:function(element,dataset){new SkipFeedCheckBox($j(element),dataset)}})});Namespace("jp.mixi.news.widget.quote.form.level").use("brook.util through").use("jp.co.mixi.gateway gateway").use("jp.co.mixi.ui.template getTemplateByElementId").use("jp.mixi.service.ui.levelselector LevelSelector").use("jp.mixi.news.model.quote.service getSharedServiceModel").use("jp.mixi.news.model.quote.level getSharedLevelModel").define(function(ns){var DEFAULT_SERVICE="voice";var initialize=function(element,dataset){var jRoot=$j(element);var jOpenSelectorButton=jRoot.find(dataset.openSelectorButton);var jLevelSelectorPanel=$j(dataset.levelSelectorPanel);var levelSelectorRowTemplate=dataset.levelSelectorRowTemplate;var currentService;var serviceModel=ns.getSharedServiceModel();var levelModel=ns.getSharedLevelModel();var defaultLevelSettings={voice:ns.gateway("voice_default_setting"),check:ns.gateway("check_default_setting")};var levelSelector=new ns.LevelSelector({selectBoxElem:jOpenSelectorButton,levelListElem:jLevelSelectorPanel,aLevelTemplate:ns.getTemplateByElementId(levelSelectorRowTemplate),service:DEFAULT_SERVICE,defaultLevelSetting:defaultLevelSettings[DEFAULT_SERVICE]});var onLevelChange=ns.through(function(value){var selectedLevel=levelSelector.getSelectedLevel();levelModel.notify("set").run({level:selectedLevel.levelId,service:currentService})});levelSelector.observeEvent("changeLevel",onLevelChange);var onServiceChange=ns.through(function(value){currentService=value.service;levelSelector.setService().run({service:currentService,defaultLevelSetting:defaultLevelSettings[currentService]})});serviceModel.notify("get").bind(onServiceChange).run();serviceModel.method("set").observe(onServiceChange)};ns.provide({registerElement:function(element,dataset){initialize(element,dataset)}})});Namespace("jp.mixi.news.widget.quote.form.posthomefeed").use("brook.util through").use("jp.co.mixi.net.storage Storage").use("jp.mixi.news.model.quote.service getSharedServiceModel").use("jp.mixi.news.model.quote.level getSharedLevelModel,getPublicLevel").use("jp.mixi.news.model.quote.posthomefeed getSharedPostHomeFeedModel").use("jp.mixi.news.ui.togglebutton ToggleButton").define(function(ns){"use strict";var STORAGE_NAMESPACE="jp.mixi.news.widget.quote.form.posthomefeed";var SELECTED_SERVICE_KEY="posthomefeed_enabled";var EXPIRE_TIME=1e3*60*60*24*30;var publicLevel=ns.getPublicLevel();var initialize=function(element,dataset){var jElement=$j(element);var service;var level;var model=ns.getSharedPostHomeFeedModel();var initializeToggleButton=function(){var defaultState=true;if(ns.Storage.isAvailable()){var state=ns.Storage.load(STORAGE_NAMESPACE,SELECTED_SERVICE_KEY);if(state!==null)defaultState=state}new ns.ToggleButton({element:jElement,button:jElement.find(dataset.postHomeFeedButton),tooltip:jElement.find(dataset.postHomeFeedTooltip),onMessage:dataset.postHomeFeedOnMessage,offMessage:dataset.postHomeFeedOffMessage,toggleModel:model,defaultState:defaultState})};var changeVisibility=function(){if(service==="voice"&&level===publicLevel){jElement.show()}else{jElement.hide()}};var observeModel=function(){var onChangeService=ns.through(function(value){service=value.service;changeVisibility()});var onChangeLevel=ns.through(function(value){level=value.level;changeVisibility()});var onChangePostHomeFeed=ns.through(function(value){if(ns.Storage.isAvailable()){var expireDate=new Date((new Date).getTime()+EXPIRE_TIME);ns.Storage.save(STORAGE_NAMESPACE,SELECTED_SERVICE_KEY,value.state,expireDate)}});model.method("set").observe(onChangePostHomeFeed);var serviceModel=ns.getSharedServiceModel();serviceModel.notify("get").bind(onChangeService).run();serviceModel.method("set").observe(onChangeService);var levelModel=ns.getSharedLevelModel();levelModel.notify("get").bind(onChangeLevel).run();levelModel.method("set").observe(onChangeLevel)};initializeToggleButton();observeModel()};ns.provide({registerElement:initialize})});Namespace("jp.mixi.news.widget.quote.form.textarea").use("jp.co.mixi.lang.class defineClass").use("jp.mixi.news.model.quote.textcounter getBodyLengthAndMaxLength").define(function(ns){"use strict";var OVER_MESSAGE="文字オーバーしています。";var QuoteCounter=ns.defineClass({initialize:function(element,data){var self=this;self.jRootElement=$j(element);self.jCounterElement=self.jRootElement.find(data.counterElement);self.jMaxLengthElement=self.jRootElement.find(data.maxLengthElement);self.jSubmitElement=self.jRootElement.find(data.submitElement);self.jErrorMessageElement=self.jRootElement.find(data.errorMessageElement);self.jBodyElement=self.jRootElement.find(data.bodyElement);self.jQuoteTextElement=self.jRootElement.find(data.quoteTextElement);self.commentDelimiter=data.commentDelimiter;self.currentService=data.defaultService;self.observeBodyTextChange()},observeBodyTextChange:function(){var self=this;var loop=function(){var lengthInfo=ns.getBodyLengthAndMaxLength(self.jBodyElement.val(),self.jQuoteTextElement.text(),self.commentDelimiter);var currentLength=lengthInfo.currentLength;var maxLength=lengthInfo.maxLength;self.jCounterElement.text(currentLength);self.jMaxLengthElement.text(maxLength);if(currentLength>maxLength){self.jCounterElement.addClass("over");self.jErrorMessageElement.show();self.jSubmitElement.prop("disabled",true)}else{self.jCounterElement.removeClass("over");self.jErrorMessageElement.hide();self.jSubmitElement.prop("disabled",false)}setTimeout(loop,200)};loop()}});ns.provide({registerElement:function(element,data){new QuoteCounter(element,data)}})});Namespace("jp.mixi.news.widget.quote.form.twittersync").use("brook.util through").use("jp.mixi.news.model.quote.service getSharedServiceModel").use("jp.mixi.news.model.quote.twittersync getSharedTwitterSyncModel").use("jp.mixi.news.ui.togglebutton ToggleButton").use("jp.co.mixi.net.storage Storage").define(function(ns){"use strict";var STORAGE_NAME_SPACE="jp.mixi.news.widget.quote.form.twittersync";var STORAGE_KEY="twitter_post_enabled";var STORAGE_EXPIRE_TIME=1e3*60*60*24*30;var getDefaultState=function(){var defaultState=false;if(ns.Storage.isAvailable()){defaultState=ns.Storage.load(STORAGE_NAME_SPACE,STORAGE_KEY)||false}return defaultState};var initialize=function(element,dataset){var jElement=$j(element);var twitterSyncModel=ns.getSharedTwitterSyncModel();new ns.ToggleButton({element:jElement,button:jElement.find(dataset.twitterSyncButton),tooltip:jElement.find(dataset.twitterSyncTooltip),onMessage:dataset.twitterSyncOnMessage,offMessage:dataset.twitterSyncOffMessage,toggleModel:twitterSyncModel,defaultState:getDefaultState()});var observeModel=function(){var onChangeService=ns.through(function(value){if(value.service==="voice"){jElement.show()}else{jElement.hide()}});var serviceModel=ns.getSharedServiceModel();serviceModel.notify("get").bind(onChangeService).run();serviceModel.method("set").observe(onChangeService);var onToggleButtonChangeState=ns.through(function(value){if(ns.Storage.isAvailable()){var expireDate=new Date((new Date).getTime()+STORAGE_EXPIRE_TIME);ns.Storage.save(STORAGE_NAME_SPACE,STORAGE_KEY,value.state,expireDate)}});twitterSyncModel.method("set").observe(onToggleButtonChangeState)};observeModel()};ns.provide({registerElement:initialize})});Namespace("jp.mixi.news.widget.quote.mutemember").use("brook promise").use("brook.util through,filter").use("brook.channel sendChannel").use("jp.co.mixi.lang.class defineClass").use("jp.co.mixi.lang.location location").use("jp.co.mixi.dom.dataset.formatter format").use("jp.mixi.news.model.quote.member.mute getMuteMemberModel").define(function(ns){"use strict";var CREATE_METHOD_NAME="create";var DELETE_METHOD_NAME="delete";var CREATE_MESSAGE="さんをミュート";var DELETE_MESSAGE="さんのミュートを解除";var isTargetMember=function(targetMemberId){return ns.filter(function(value){return targetMemberId===value.request.mute_member_id})};var toastDialog=function(message){return ns.through(function(value){var suffixMessage=value.response.error?"できませんでした":"しました";var dialogMessage=message+suffixMessage;ns.sendChannel("dialog_toast").run({type:"normal",message:dialogMessage})})};var successFilter=ns.filter(function(value){return!value.response.error});var attach=function(element,dataset){var jElement=$j(element);var model=ns.getMuteMemberModel();var format={commentSenderId:"number",commentSenderName:"string",commentSenderIsMuted:"boolean",noReload:"boolean"};var formattedData=ns.format(format,dataset);var commentSenderId=formattedData.commentSenderId;var commentSenderName=formattedData.commentSenderName;var noReload=formattedData.noReload;var commentSenderIsMuted=formattedData.commentSenderIsMuted;var methodName=commentSenderIsMuted?DELETE_METHOD_NAME:CREATE_METHOD_NAME;model.method(CREATE_METHOD_NAME).observe(isTargetMember(commentSenderId).bind(toastDialog(commentSenderName+CREATE_MESSAGE)).bind(successFilter).bind(function(next,value){if(!noReload){ns.location.reload()}next(value)}));model.method(DELETE_METHOD_NAME).observe(isTargetMember(commentSenderId).bind(toastDialog(commentSenderName+DELETE_MESSAGE)).bind(successFilter).bind(function(next,value){if(!noReload){ns.location.reload()}next(value)}));jElement.on("click",function(event){model.notify(methodName).run({mute_member_id:commentSenderId})})};ns.provide({registerElement:attach})});Namespace("jp.mixi.news.widget.quote.popup").define(function(ns){"use strict";var equalOrChildOf=function(reference,eventTarget){return reference===eventTarget||$j(eventTarget).closest(reference).length>0};var attach=function(element,dataset){var jElement=$j(element);var jTriggerElement=jElement.find(dataset.triggerElementSelector);var jPopupElement=jElement.find(dataset.popupElementSelector);var jClickAllowedElement=jElement.find(dataset.clickAllowedElementSelector);jTriggerElement.on("click",function(event){jPopupElement.toggle()});jPopupElement.on("click",function(event){jPopupElement.hide()});$j(document).on("click",function(event){if(!equalOrChildOf(jClickAllowedElement.get(0),event.target)){jPopupElement.hide()}})};ns.provide({registerElement:attach})});Namespace("jp.mixi.news.widget.relation.community.select").define(function(ns){var unCheckRelatedCommunity=function(jCheckboxElements,jParentTextElements){jCheckboxElements.each(function(){if(!this.checked){return true}var checkboxElement=this;jParentTextElements.each(function(){if(checkboxElement.value!=this.value){return true}checkboxElement.checked=false;return false})})};var relateCommunityToParent=function(jCheckboxElements,jParentTextElements){jCheckboxElements.each(function(){if(!this.checked){return true}var checkboxElement=this;jParentTextElements.each(function(){if(this.value){return true}this.value=checkboxElement.value;return false});this.checked=false})};ns.provide({registerElement:function(element,data){$j(element).click(function(evt){if(window.opener){var jCheckboxElements=$j("."+data.parentCheckboxClass).find(":checkbox");var jParentTextElements=$j(window.opener.document).find('#form1 [name="news_community"]');unCheckRelatedCommunity(jCheckboxElements,jParentTextElements);relateCommunityToParent(jCheckboxElements,jParentTextElements)}})}})});Namespace("jp.mixi.news.widget.settings.replacekeyword").use("jp.co.mixi.lang.class defineClass").define(function(ns){"use strict";var ReplaceKeyword=ns.defineClass({initialize:function(element,dataset){var self=this;self.jReplaceText=$j(element);self.jReplaceTarget=$j(dataset.replaceTarget);self.bindClickEvent()},bindClickEvent:function(){var self=this;this.jReplaceText.click(function(evt){evt.preventDefault();evt.stopPropagation();self.jReplaceTarget.val(self.jReplaceText.text())})}});ns.provide({registerElement:function(element,dataset){new ReplaceKeyword(element,dataset)}})});Namespace("jp.mixi.news.widget.settings.sort").use("jp.co.mixi.lang.class defineClass").define(function(ns){"use strict";var SortWidgetSettings=ns.defineClass({initialize:function(element,dataset){var self=this;self.jForm=$j(element);self.jMoveUpButton=self.jForm.find(dataset.moveUpButton);self.jMoveDownButton=self.jForm.find(dataset.moveDownButton);self.jSubmitButton=self.jForm.find(dataset.submitButton);self.jDisplayOrderCsv=self.jForm.find(dataset.displayOrderCsv);self.moveTarget=dataset.moveTarget;self.currentDisplayOrder=dataset.currentDisplayOrder;self.bindClickEvent()},bindClickEvent:function(){var self=this;this.jMoveUpButton.click(function(evt){evt.preventDefault();evt.stopPropagation();var self=this;var jFromElement=$j(self).parent().parent().parent(self.moveTarget);var jToElement=jFromElement.prev();jToElement.before(jFromElement)});this.jMoveDownButton.click(function(evt){evt.preventDefault();evt.stopPropagation();var self=this;var jFromElement=$j(self).parent().parent().parent(self.moveTarget);var jToElement=jFromElement.next();jToElement.after(jFromElement)});this.jSubmitButton.click(function(evt){evt.preventDefault();evt.stopPropagation();var displayOrderCsv=_.map(self.jForm.find(self.currentDisplayOrder),function(elem){return $j(elem).val()}).join(",");self.jDisplayOrderCsv.val(displayOrderCsv);self.jForm.submit()})}});ns.provide({registerElement:function(element,dataset){new SortWidgetSettings(element,dataset)}})});Namespace("jp.mixi.news.widget.settings.switchbutton").use("jp.co.mixi.lang.class defineClass").define(function(ns){"use strict";var SwitchButton=ns.defineClass({initialize:function(element,dataset){var self=this;self.jSwitchRow=$j(element);self.jSwitchCheckbox=self.jSwitchRow.find(dataset.switchCheckboxClass);self.jSwitchButton=self.jSwitchRow.find(dataset.switchButtonClass);self.switchToggleClassName=dataset.switchToggleClassName;self.switchButtonTextOn=dataset.switchButtonTextOn;self.switchButtonTextOff=dataset.switchButtonTextOff;self.bindClickEvent()},bindClickEvent:function(){var self=this;this.jSwitchButton.click(function(evt){evt.preventDefault();evt.stopPropagation();if(self.switchButtonTextOn&&self.switchButtonTextOff){self.jSwitchButton.text(self.jSwitchCheckbox.is(":checked")?self.switchButtonTextOff:self.switchButtonTextOn)}self.jSwitchRow.toggleClass(self.switchToggleClassName);self.jSwitchCheckbox.prop("checked",!self.jSwitchCheckbox.is(":checked"))})}});ns.provide({registerElement:function(element,dataset){new SwitchButton(element,dataset)}})});Namespace("jp.mixi.news.widget.touch.folddescription").use("jp.mixi.service.analysis postUIEventLog").define(function(ns){"use strict";ns.provide({registerElement:function(element,dataset){$j("#JS_showMore",element).click(function(){$j("#JS_description",element).show();$j("#JS_descriptionFold",element).hide();ns.postUIEventLog("news.fold.description","showMore")})}})});Namespace("jp.mixi.news.widget.touch.menu.searchform").define(function(ns){"use strict";var clearedFlg;var bindFocusEvent=function(jSearchForm){jSearchForm.focus(function(){if(clearedFlg==false){jSearchForm.val("");clearedFlg=true}})};ns.provide({registerElement:function(element,data){clearedFlg=false;bindFocusEvent($j(element))}})});Namespace("jp.mixi.news.widget.touch.photogroup.descriptionopener").define(function(ns){"use strict";var initialize=function(data){var jCloseButton=$j(data.closeButtonSelector);var jOpenButton=$j(data.openButtonSelector);var jDescription=$j(data.descriptionSelector);var descriptionCloseClass=data.descriptionCloseClass;var onCloseButtonClick=function(evt){evt.preventDefault();jDescription.addClass(descriptionCloseClass)};var onOpenButtonClick=function(evt){evt.preventDefault();jDescription.removeClass(descriptionCloseClass)};jCloseButton.click(onCloseButtonClick);jOpenButton.click(onOpenButtonClick)};ns.provide({registerElement:function(element,data){initialize(data)}})});Namespace("jp.mixi.news.widget.touch.photogroup.view").use("brook.util through").use("brook.channel sendChannel,channel").use("jp.co.mixi.gateway gateway").use("jp.mixi.news.model.feedback getFeedbackModel").use("jp.mixi.news.ui.photogroup.view PhotoGroupViewer").define(function(ns){"use strict";var FEEDBACK_SERVICE_KEY="53be64390c2bf14912cc8ded09c28d346a7a28b0";var TOAST_KEY="dialog_toast";var FEEDBACK_SUCCESS_MESSAGE="しました";var FEEDBACK_FAILED_MESSAGE="できませんでした";var VIEWER_SET_NEWS_CHANNEL="jp.mixi.news.ui.photogroup.view.setNews";var jViewer;var jFeedbackButton;var jFeedbackContainer;var jFacebookButton;var jQuoteCount;var jQuoteLink;var jQuoteArea;var jQuoteBody;var jQuoteVoiceLink;var jQuoteMemberNickname;var jQuoteMemberThumbnail;var jQuoteMemberLink;var jQuoteFeedbackCount;var jQuoteCommentCount;var jQuoteCreatedAt;var jQuotePostTimeFormatted;var photoGroupViewer;var feedbackModel;var urlNewsPrefixSSL;var urlMixiPrefixSSL;var groupId;var loginMemberId;var disableFeedbackClass;var shareTitleSuffix;var initialize=function(){jFeedbackButton.click(onFeedbackButtonClick)};var onFeedbackButtonClick=function(evt){evt.preventDefault();var newsUrl=photoGroupViewer.shareInfoForCurrentPosition.url.newsUrl;if(!loginMemberId){location.href=urlMixiPrefixSSL+"login.pl?next_url="+encodeURIComponent(newsUrl);return}if(jFeedbackContainer.hasClass(disableFeedbackClass)){return}jFeedbackContainer.addClass(disableFeedbackClass);feedbackModel.notify("create").bind(ns.through(function(v){var success=!v.response.error&&v.response.result&&!v.response.result.error;ns.sendChannel("dialog_toast").run({type:"feedback",message:success?FEEDBACK_SUCCESS_MESSAGE:FEEDBACK_FAILED_MESSAGE})})).run({uri:newsUrl,service_key:FEEDBACK_SERVICE_KEY,via:"smallscreen"})};var setNewsPromise=ns.through(function(value){var entry=value.entry;var viewer=value.viewer;jQuoteCount.text(entry.quote_voice_count);jQuoteLink.attr("href",urlNewsPrefixSSL+"list_quote.pl?sort=feedback_count&type=voice&news_id="+entry.news_id);canProvideFeedback(function(enable){if(enable){jFeedbackContainer.removeClass(disableFeedbackClass)}else{jFeedbackContainer.addClass(disableFeedbackClass)}},viewer.shareInfoForCurrentPosition.url.newsUrl);if(entry.voice){jQuoteBody.html(entry.voice.body_with_emoji_view_html);jQuoteVoiceLink.attr("href",entry.voice.url_view_voice);jQuoteMemberNickname.text(entry.voice.member_nickname);jQuoteMemberThumbnail.attr("src",entry.voice.member_thumbnail_url);jQuoteMemberLink.attr("href",entry.voice.url_show_friend);jQuoteFeedbackCount.text(entry.voice.feedback_count);jQuoteCommentCount.text(entry.voice.comment_count);jQuoteCreatedAt.text(entry.voice.created_at);jQuotePostTimeFormatted.text(entry.voice.post_time_formatted);jQuoteArea.show()}else{jQuoteArea.hide()}});var canProvideFeedback=function(callback,url){if(!loginMemberId){callback(true);return}feedbackModel.notify("alreadyCreated").bind(ns.through(function(v){callback(!v.error&&!v.result)})).run({uri:url,service_key:FEEDBACK_SERVICE_KEY,via:"smallscreen"})};ns.provide({registerElement:function(element,data){jViewer=$j(element);jFeedbackButton=$j(data.feedbackButtonSelector);jFeedbackContainer=$j(data.feedbackContainerSelector);jFacebookButton=$j(data.facebookButtonSelector);jQuoteCount=$j(data.quoteCountSelector);jQuoteLink=$j(data.quoteLinkSelector);jQuoteArea=$j(data.quoteAreaSelector);jQuoteBody=$j(data.quoteBodySelector);jQuoteVoiceLink=jViewer.find(data.quoteVoiceLinkSelector);jQuoteMemberNickname=$j(data.quoteMemberNicknameSelector);jQuoteMemberThumbnail=$j(data.quoteMemberThumbnailSelector);jQuoteMemberLink=$j(data.quoteMemberLinkSelector);jQuoteFeedbackCount=$j(data.quoteFeedbackCountSelector);jQuoteCommentCount=$j(data.quoteCommentCountSelector);jQuoteCreatedAt=$j(data.quoteCreatedAtSelector);jQuotePostTimeFormatted=$j(data.quotePostTimeFormattedSelector);disableFeedbackClass=data.disableFeedbackClass;groupId=ns.gateway("group_id");feedbackModel=ns.getFeedbackModel();shareTitleSuffix=ns.gateway("share_title_suffix");urlNewsPrefixSSL=ns.gateway("url_news_prefix_ssl");urlMixiPrefixSSL=ns.gateway("url_mixi_prefix_ssl");loginMemberId=ns.gateway("login_member_id");ns.channel(VIEWER_SET_NEWS_CHANNEL).observe(setNewsPromise);photoGroupViewer=ns.PhotoGroupViewer(element,data);initialize()}})});Namespace("jp.mixi.news.widget.touch.quote.expandmenu").define(function(ns){"use strict";var setEventListener=function(element,dataset){var $element=$j(element);var open=$element.find(dataset.openSelector);var close=$element.find(dataset.closeSelector);var content=$element.find(dataset.contentSelector);open.on("click",function(event){event.preventDefault();open.hide();close.show();content.show()});close.on("click",function(event){event.preventDefault();close.hide();open.show();content.hide()})};ns.provide({registerElement:setEventListener})});Namespace("jp.mixi.news.widget.touch.quote.form").use("brook promise").use("brook.util through").use("brook.channel sendChannel").use("jp.co.mixi.gateway gateway").use("jp.co.mixi.lang parseIntAsDecimal").use("jp.mixi.news.model.check getCheckModel").use("jp.mixi.news.model.voice getVoiceModel").use("jp.mixi.news.model.quote.service getSharedServiceModel").use("jp.mixi.news.model.quote.level getSharedLevelModel,getPublicLevel").use("jp.mixi.news.model.quote.twittersync getSharedTwitterSyncModel").use("jp.mixi.news.widget.touch.quote.form.textarea getBody").define(function(ns){"use strict";var jForm;var jTextarea;var newsQuote;var jSourceArea;var jSkipPostFeed;var newsId;var voiceVia;var checkKey;var checkUrl;var checkVia;var checkImagePostKey;var checkImageUrl;var locationHref;var MESSAGE_SUCCESS_CHECK="チェックしました";var MESSAGE_FAILED_CHECK="チェックできませんでした";var MESSAGE_SUCCESS_VOICE="つぶやきました";var MESSAGE_FAILED_VOICE="つぶやけませんでした";var checkModel;var voiceModel;var memberId=ns.parseIntAsDecimal(ns.gateway("login_member_id"));var publicLevel=ns.getPublicLevel();var currentLevel;var currentService;var twitterSyncEnabled;var bindSubmitEvent=function(){jForm.submit(function(){this.disabled=true;if(currentService=="check"){check()}else if(currentService=="voice"){voice()}this.disabled=false;return false})};var check=function(){checkModel.notify("create").run({member_id:memberId,body:ns.getBody(),level:currentLevel,key:checkKey,url:checkUrl,via:checkVia,image_post_key:checkImagePostKey||undefined,image_url:checkImageUrl||undefined})};var voice=function(){voiceModel.notify("create").run({viewer_id:memberId,owner_id:memberId,body:jTextarea.val()?ns.getBody():newsQuote,level:currentLevel,news_id:newsId,via:voiceVia,twitter_sync:twitterSyncEnabled,skip_post_feed:jSkipPostFeed.prop("checked")?1:0})};var renderResult=function(messageSuccess,messageFailed){return ns.promise(function(next,value){if(value.response.result){jTextarea.val("");ns.sendChannel("dialog_toast").run({type:"normal",message:messageSuccess});if(locationHref&&value.request.level==publicLevel){window.location.href=locationHref}}else{ns.sendChannel("dialog_toast").run({type:"normal",message:messageFailed})}})};var onLevelChanged=ns.through(function(value){currentLevel=value.level});var onServiceChanged=ns.through(function(value){currentService=value.service});var onTwitterSyncEnabledChanged=ns.through(function(value){twitterSyncEnabled=value.state});var observeModel=function(){var levelModel=ns.getSharedLevelModel();levelModel.notify("get").bind(onLevelChanged).run();levelModel.method("set").observe(onLevelChanged);var serviceModel=ns.getSharedServiceModel();serviceModel.notify("get").bind(onServiceChanged).run();serviceModel.method("set").observe(onServiceChanged);var twitterSyncModel=ns.getSharedTwitterSyncModel();twitterSyncModel.notify("get").bind(onTwitterSyncEnabledChanged).run();twitterSyncModel.method("set").observe(onTwitterSyncEnabledChanged);checkModel.method("create").observe(renderResult(MESSAGE_SUCCESS_CHECK,MESSAGE_FAILED_CHECK));voiceModel.method("create").observe(renderResult(MESSAGE_SUCCESS_VOICE,MESSAGE_FAILED_VOICE))};ns.provide({registerElement:function(element,data){jForm=$j(element);jTextarea=jForm.find("textarea");jSourceArea=jForm.find(data.sourceArea);newsId=data.newsId;newsQuote=data.newsQuote;voiceVia=data.voiceVia;checkKey=data.checkKey;checkUrl=data.checkUrl;checkVia=data.checkVia;checkImagePostKey=data.checkImagePostKey;checkImageUrl=data.checkImageUrl;locationHref=data.locationHref;jSkipPostFeed=jForm.find(data.skipPostFeed);checkModel=ns.getCheckModel();voiceModel=ns.getVoiceModel();bindSubmitEvent();observeModel()}})});Namespace("jp.mixi.news.widget.touch.quote.form.element").use("brook.util through").use("jp.mixi.news.model.quote.service getSharedServiceModel").use("jp.mixi.news.model.quote.level getSharedLevelModel,getPublicLevel").define(function(ns){"use strict";var jElement;var isPremium;var skipPostFeedCheck;var skipPostFeedCheckLabel;var premiumHelpLink;var currentService;var currentLevel;var publicLevel=ns.getPublicLevel();var serviceModel=ns.getSharedServiceModel();var levelModel=ns.getSharedLevelModel();var observeModel=function(){serviceModel.notify("get").bind(onChangeService).run();serviceModel.method("set").observe(onChangeService);levelModel.notify("get").bind(onChangeLevel).run();levelModel.method("set").observe(onChangeLevel)};var onChangeService=ns.through(function(value){currentService=value.service;showAndHidePremiumLink()});var onChangeLevel=ns.through(function(value){currentLevel=value.level;showAndHidePremiumLink();showAndHideSkipPostFeedElement()});var showAndHidePremiumLink=function(){var link=jElement.find(premiumHelpLink);if(!isPremium&&currentService==="voice"&&currentLevel===publicLevel){link.show()}else{link.hide()}};var showAndHideSkipPostFeedElement=function(){if(currentService==="voice"&&isPremium&&currentLevel===publicLevel){jElement.find(skipPostFeedCheck).show();jElement.find(skipPostFeedCheckLabel).show()}else{jElement.find(skipPostFeedCheck).hide();jElement.find(skipPostFeedCheckLabel).hide()}};ns.provide({registerElement:function(element,data){jElement=$j(element);isPremium=parseInt(data.isPremium,10)===1;skipPostFeedCheck=data.skipPostFeedCheckbox;skipPostFeedCheckLabel=data.skipPostFeedCheckboxLabel;premiumHelpLink=data.premiumHelpLink;observeModel()}})});Namespace("jp.mixi.news.widget.touch.quote.form.tab").use("brook.util through").use("jp.co.mixi.net.storage Storage").use("jp.mixi.news.model.quote.service getSharedServiceModel").define(function(ns){"use strict";var STORAGE_NAMESPACE="jp.mixi.news.widget.touch.quote.form";var SELECTED_SERVICE_KEY="selected_service";var EXPIRE_TIME=1e3*60*60*24*30;var defaultLoaded=false;var initialize=function(jElement,data){var model=ns.getSharedServiceModel();var toggleTabPromise=ns.through(function(value){if(value.service===data.service){jElement.addClass("current");if(ns.Storage.isAvailable()){var expireDate=new Date((new Date).getTime()+EXPIRE_TIME);ns.Storage.save(STORAGE_NAMESPACE,SELECTED_SERVICE_KEY,data.service,expireDate)}}else{jElement.removeClass("current")}});var setDefaultTab=function(){var service;if(ns.Storage.isAvailable()){service=ns.Storage.load(STORAGE_NAMESPACE,SELECTED_SERVICE_KEY)}if(service){model.notify("set").run({service:service})}defaultLoaded=true};jElement.click(function(){model.notify("set").run({service:data.service})});if(!defaultLoaded)setDefaultTab();model.notify("get").bind(toggleTabPromise).run();model.method("set").observe(toggleTabPromise)};ns.provide({registerElement:function(element,data){initialize($j(element),data)}})});Namespace("jp.mixi.news.widget.touch.quote.form.textarea").use("brook promise").use("brook.channel channel").use("brook.channel sendChannel").use("jp.mixi.news.model.quote.service getSharedServiceModel").use("jp.mixi.news.model.quote.textcounter getBodyLengthAndMaxLength").define(function(ns){"use strict";var jTextarea;var newsQuote;var jCounter;var jSubmitButton;var jOver;var commentDelimiter;var OVER_MESSAGE="文字オーバーしています";var serviceModel=ns.getSharedServiceModel();var observeModel=function(){var change=ns.channel("jp.mixi.news.widget.touch.quote.form.textarea.change");change.observe(afterUpdateTextLength())};var afterUpdateTextLength=function(){return ns.promise(function(next,value){updateCounterAndForm();setTimeout(sendChannelTextareaChange,200);next(value)})};var updateCounterAndForm=function(){jOver.text("");var lengthInfo=ns.getBodyLengthAndMaxLength(jTextarea.val(),newsQuote,commentDelimiter);var maxLength=lengthInfo.maxLength;var currentLength=lengthInfo.currentLength;if(currentLength>maxLength){jOver.text(currentLength-maxLength+OVER_MESSAGE);jCounter.html("");jSubmitButton.each(function(){this.disabled=true})}else{jCounter.html(currentLength+"/"+maxLength);jSubmitButton.each(function(){this.disabled=false})}};var sendChannelTextareaChange=function(){ns.sendChannel("jp.mixi.news.widget.touch.quote.form.textarea.change").run()};var getBody=function(){var quoteText=newsQuote;var currentService=serviceModel.funcGet().service;if(currentService=="voice"){quoteText=commentDelimiter+quoteText}else{quoteText=""}return jTextarea.val()+quoteText};ns.provide({registerElement:function(element,data){var jRoot=$j(element);jTextarea=jRoot.find(data.textArea);jCounter=jRoot.find(data.counter);jSubmitButton=jRoot.find(data.submitButton);jOver=jRoot.find(data.over);newsQuote=data.newsQuote;commentDelimiter=data.commentDelimiter;observeModel();sendChannelTextareaChange()},getBody:getBody})});Namespace("jp.mixi.news.widget.touch.quote.mute").use("brook.widget bindAllWidget").use("jp.co.mixi.lang.class defineClass").use("jp.co.mixi.ui.modalwindow createModalWindow").use("jp.co.mixi.ui.template getTemplateByElementId").use("jp.co.mixi.dom.dataset.formatter format").define(function(ns){"use strict";var attach=function(element,dataset){var jElement=$j(element);var format={closerOverlayElementSelector:"string",triggerElementSelector:"string",closerElementSelector:"string",popupTemplateId:"string",commentSenderId:"number",commentSenderName:"string"};var formattedData=ns.format(format,dataset);var closerOverlayElementSelector=formattedData.closerOverlayElementSelector;var triggerElementSelector=formattedData.triggerElementSelector;var closerElementSelector=formattedData.closerElementSelector;var popupTemplateId=formattedData.popupTemplateId;var commentSenderId=formattedData.commentSenderId;var commentSenderName=formattedData.commentSenderName;jElement.on("click",function(){var popupTemplate=ns.getTemplateByElementId(popupTemplateId);popupTemplate.param({sender_id:commentSenderId,sender_name:commentSenderName});var jTemplate=$j(popupTemplate.output());var jLayer=$j(closerOverlayElementSelector);jLayer.empty();jLayer.append(jTemplate);ns.bindAllWidget.run();var params={closerOverlayElementSelector:closerOverlayElementSelector,triggerElementSelector:triggerElementSelector,closerElementSelector:closerElementSelector};ns.createModalWindow(jLayer,params)})};ns.provide({registerElement:attach})});