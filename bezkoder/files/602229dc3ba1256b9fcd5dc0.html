Namespace("jp.mixi.device.checker").use("jp.co.mixi.lang.navigator navigator").define(function(ns){var _isiOS=function(){return!!Zepto.os.ios};var _isiPhone=function(){return!!Zepto.os.iphone};var _isiPhoneOfficialClientWebView=function(){return!!(_isiPhone&&!ns.navigator.userAgent.match(/Safari/)&&ns.navigator.userAgent.match(/nonavigation/))};var _isiPad=function(){return!!Zepto.os.ipad};var _isAndroid=function(){return!!Zepto.os.android};var _isChromeForAndroid=function(){return _isAndroid()&&/Chrome/.test(ns.navigator.userAgent)};var _isFirefoxForAndroid=function(){return/Android/.test(ns.navigator.userAgent)&&_isFirefox()};var _isFirefox=function(){return/Firefox/.test(ns.navigator.userAgent)};var _isWebOS=function(){return!!Zepto.os.webos};var _isFirefoxOSMobile=function(){return _isFirefox()&&/(Mobile|Tablet)/.test(ns.navigator.userAgent)&&!_isFirefoxForAndroid()};var _isTouchPad=function(){return!!Zepto.os.touchpad};var _isBlackBerry=function(){return!!Zepto.os.blackberry};var _hasFixedPositionBug=function(){var version=_getVersion();return version.charAt(0)=="5"&&_isiOS()};var _hasIframeClickThroughBug=function(){var version=_getVersion();return _isAndroid()&&parseFloat(version)>=2};var _hasTapHighlightThroughBug=function(){var version=_getVersion();return _isAndroid()&&parseFloat(version)>=2&&parseFloat(version)<3};var _hasPositionAbsoluteParentBug=function(){var version=_getVersion();return _isAndroid()&&parseFloat(version)>=2&&parseFloat(version)<3};var _hasPositionFixedParentBug=function(){var version=_getVersion();return _isAndroid()&&parseFloat(version)>=4};var _hasOnClickConfirmBug=function(){return _isiOS()&&/^7\.0/.test(_getVersion())};var _isSupportFixedPosition=function(){var version=_getVersion();return _isAndroid()&&parseFloat(version)>=2.2||_isiOS()&&parseFloat(version)>=5||ns.navigator.platform=="Win32"};var _isSmoothScrollSupportedDevice=function(){return!(_isAndroid()&&_getVersion()<=2.1)};var _getVersion=function(){return Zepto.os.version};var _isSmartDevice=function(){return"createTouch"in document.documentElement||"ontouchstart"in document.documentElement};ns.provide({isiOS:_isiOS,isiPhone:_isiPhone,isiPhoneOfficialClientWebView:_isiPhoneOfficialClientWebView,isiPad:_isiPad,isAndroid:_isAndroid,isChromeForAndroid:_isChromeForAndroid,isFirefoxForAndroid:_isFirefoxForAndroid,isWebOS:_isWebOS,isFirefoxOSMobile:_isFirefoxOSMobile,isTouchPad:_isTouchPad,isBlackBerry:_isBlackBerry,hasFixedPositionBug:_hasFixedPositionBug,hasIframeClickThroughBug:_hasIframeClickThroughBug,hasTapHighlightThroughBug:_hasTapHighlightThroughBug,hasPositionAbsoluteParentBug:_hasPositionAbsoluteParentBug,hasPositionFixedParentBug:_hasPositionFixedParentBug,hasOnClickConfirmBug:_hasOnClickConfirmBug,isSupportFixedPosition:_isSupportFixedPosition,isSmoothScrollSupportedDevice:_isSmoothScrollSupportedDevice,getVersion:_getVersion,isSmartDevice:_isSmartDevice})});Namespace("jp.mixi.service.analysis").use("jp.co.mixi.gateway gateway").use("jp.co.mixi.lang parseIntAsDecimal").use("jp.co.mixi.net.jsonrpc JSONRPC").use("jp.co.mixi.logging Log").use("jp.mixi.analysis.google_analytics sendEvent").define(function(ns){var memberId=ns.parseIntAsDecimal(ns.gateway("login_member_id"));var postKey=ns.gateway("rpc_post_key");var SAMPLING_ID=68;var isSamplingId=memberId%100===SAMPLING_ID;var rpc=ns.JSONRPC.createService("/system/rpc.json",{auth_type:"postkey",secret:postKey});var isDebug=ns.gateway("RUN_MODE")=="debug";var isStaging=ns.gateway("RUN_MODE")=="staging";var DEFAULT_ACTION="click";ns.provide({postAnalysisLog:function(locationParam){if(!locationParam){return}if(!isSamplingId&&!isDebug){return}rpc.call("jp.mixi.analysis.analysisOfClickCount",{member_id:memberId,location:locationParam},function(){})},postUIEventLog:function(eventName,pageName,callback,errorCallback){if(!eventName){return}rpc.call("jp.mixi.analysis.uievent.send",{member_id:memberId,event_name:eventName,page_name:pageName},callback||function(){},errorCallback||function(){})},postUIEventLogToGA:function(trackerName,params){if(!trackerName){ns.Log.warn("trackerName is required");return}if(!params.eventCategory){ns.Log.warn("eventCategory is required");return}if(!params.eventAction){params.eventAction=DEFAULT_ACTION}ns.sendEvent(trackerName,params)},isSamplingIdOnePercent:function(samplingId){var isSampling=memberId%100===samplingId;if(!isSampling&&!isDebug&&!isStaging){return}return true},isSamplingIdTenPercent:function(samplingId){var isSampling=memberId%10===samplingId;if(!isSampling&&!isDebug&&!isStaging){return}return true},postWidgetProfilerLog:function(logAggregate,totalCount,totalTime,pathname){if(!logAggregate||!totalCount||!totalTime||!pathname){return}rpc.call("jp.mixi.analysis.behaviour.sendMessage",{name:"widget.profiler",value:{logAgregate:logAggregate,totalCount:totalCount,totalTime:totalTime,pathname:pathname}},function(){})}})});Namespace("jp.mixi.analysis.google_analytics").define(function(ns){"use strict";var enabledTrackerList=window._mixiGaEnabledTrackerList||[];var trackerEnabled={};for(var k in enabledTrackerList){trackerEnabled[enabledTrackerList[k]]=true}var sendEvent=function(trackerName,params){var q={eventCategory:params.eventCategory,eventAction:params.eventAction,eventLabel:params.eventLabel,page:params.page};if(_.isFunction(params.hitCallback)){q.hitCallback=params.hitCallback}if(params.eventValue!==undefined){q.eventValue=params.eventValue}if(params.nonInteraction){q.nonInteraction=params.nonInteraction}window.ga(trackerName+".send","event",q)};var isEnabledTracker=function(trackerName){return!!trackerEnabled[trackerName]};ns.provide({sendEvent:sendEvent,isEnabledTracker:isEnabledTracker})});Namespace("jp.mixi.analysis.google_analytics.clientidsender").define(function(ns){"use strict";var createClientIdSender=function(element,dataset){if(dataset.trackerName===undefined){dataset.trackerName="global"}ga(function(){var clientId=ga.getByName(dataset.trackerName).get("clientId");element.value=clientId})};ns.provide({registerElement:createClientIdSender})});Namespace("jp.mixi.analysis.google_analytics.detailedtimingtracker").use("jp.mixi.device.checker isSmartDevice").define(function(ns){"use strict";var detailedTimingTracker={isSent:false,trackerName:"",hitType:"timing",timingCategory:"",timingValues:{},initialize:function(trackerName,categoryName){if(!trackerName)throw new Error("trackerName required");if(!categoryName)throw new Error("timingCategory required");this.trackerName=trackerName;this.timingCategory=categoryName;if(!window.performance||!window.performance.timing||!ns.isSmartDevice()){this.timingValues={}}else{var timing=window.performance.timing;this.timingValues={timeFromDomLoadingToDomInteractive:timing.domInteractive-timing.domLoading,timeFromDomInteractiveToDomContentLoadedEventStart:timing.domContentLoadedEventStart-timing.domInteractive,timeFromDomContentLoadedEventStartToDomContentLoadedEventEnd:timing.domContentLoadedEventEnd-timing.domContentLoadedEventStart,timeFromDomContentLoadedEventEndToDomComplete:timing.domComplete-timing.domContentLoadedEventEnd}}return this},sendDetailedTimings:function(){if(this.isSent){return}if(Object.keys(this.timingValues).length===0){return}for(var key in this.timingValues){window.ga(this.trackerName+".send",this.hitType,{timingCategory:this.timingCategory,timingVar:key,timingValue:this.timingValues[key]})}this.isSent=true}};ns.provide({detailedTimingTracker:detailedTimingTracker})});Namespace("jp.mixi.analysis.google_analytics.eventtracker").define(function(ns){"use strict";var makeRequest=function(dataset){var category=dataset.eventCategory;var action=dataset.eventAction||"click";var label=dataset.eventLabel;var value=dataset.eventValue;if(!category)throw new Error("data-event-category required");var request={hitType:"event",eventCategory:category,eventAction:action,eventLabel:label,eventValue:value};return request};ns.provide({registerElement:function(element,dataset){var trackerName=dataset.trackerName||"global";$j(element).on("mousedown",function(){window.ga(trackerName+".send",makeRequest(dataset))})}})});Namespace("jp.mixi.analysis.google_analytics.networkspeedtracker").use("jp.mixi.device.checker isSmartDevice").define(function(ns){"use strict";var protocol=location.protocol==="https:"?"https:":"http:";var testImgPath=protocol+"//img.mixi.net/img/smartphone/touch/icon/close003.gif";var track=function(trackerName){var startTime;var $img=$j("<img>");$img.on("load",function(){window.ga(trackerName+".send","timing",{timingCategory:"common/NetworkSpeed",timingVar:"load image",timingValue:(new Date).getTime()-startTime})});startTime=(new Date).getTime();$img.attr("src",testImgPath+"?time="+startTime).hide().appendTo(document.body)};ns.provide({trackNetworkSpeed:function(trackerName){if(!ns.isSmartDevice())return;if(!trackerName)throw new Error("trackerName required");setTimeout(function(){track(trackerName)},3e3)}})});Namespace("jp.mixi.analysis.google_analytics.seenelementtracker").use("jp.mixi.analysis.google_analytics sendEvent").define(function(ns){"use strict";var SCROLL_INTERVAL=300;var initialize=function(element,dataset){var $element=$j(element);var trackerName="global";var eventCategory=dataset.eventCategory;var eventAction=dataset.eventAction||"seen";var eventLabel=dataset.eventLabel||undefined;if(!eventCategory)throw new Error("data-event-category required");var sendSeenLog=_.once(function(){ns.sendEvent(trackerName,{eventCategory:eventCategory,eventAction:eventAction,eventLabel:eventLabel,nonInteraction:true})});var $window=$j(window);var isSeen=function(elementBottom){if($element.css("display")==="none"){return false}var windowBottom=$window.scrollTop()+$window.height();return windowBottom>elementBottom};$window.on("load",function(){var elementBottom=$element.offset().top+$element.height();if(isSeen(elementBottom)){sendSeenLog();return}var scrollEvent=_.debounce(function(){if(isSeen(elementBottom)){sendSeenLog();$window.off("scroll",scrollEvent)}},SCROLL_INTERVAL);$window.on("scroll",scrollEvent)})};ns.provide({registerElement:initialize})});Namespace("jp.mixi.analysis.google_analytics.sendpageview").use("brook promise").use("brook.util through").use("jp.co.mixi.lang.location location").define(function(ns){"use strict";var sendVirtualPageView=function(dataset){return ns.through(function(){var trackerName=dataset.trackerName;var virtualPageName=dataset.virtualPageName;var virtualPagePath=ns.location.pathname+"#virtualpage-"+virtualPageName;window.ga(trackerName+".send","pageview",{page:virtualPagePath})})};ns.provide({registerElement:function(element,dataset){var onMouseDownPromise=ns.promise().bind(sendVirtualPageView(dataset));$j(element).on("mousedown",function(){onMouseDownPromise.run()})}})});Namespace("jp.mixi.analysis.google_analytics.submitbuttontracker").use("jp.mixi.analysis.google_analytics sendEvent").define(function(ns){"use strict";var createSubmitButtonClickTracker=function(element,dataset){var root=$j(element);var trackerName=dataset.trackerName;var eventCategory=dataset.eventCategory||"form";var eventAction=dataset.eventAction||"submit";var eventLabel=dataset.eventLabel;if(!trackerName)throw new Error("data-tracker-name required");if(root[0].tagName.toLowerCase()!=="form")throw new Error("element must be form");root.on("submit",function(e){ns.sendEvent(trackerName,{eventCategory:eventCategory,eventAction:eventAction,eventLabel:eventLabel,hitCallback:function(){e.target.submit()}});return false})};ns.provide({registerElement:createSubmitButtonClickTracker})});Namespace("jp.mixi.analysis.google_analytics.textlinktracker").use("jp.mixi.analysis.google_analytics sendEvent").define(function(ns){"use strict";var createTextLinkClickTracker=function(element,dataset){var root=$j(element);var trackerName=dataset.trackerName;var eventCategory=dataset.eventCategory||"link";var eventAction=dataset.eventAction||"click";var eventLabel=dataset.eventLabel;if(!trackerName)throw new Error("data-tracker-name required");root.on("click","a[href]",function(e){var clicked=$j(this);var label=eventLabel||clicked.text();ns.sendEvent(trackerName,{eventCategory:eventCategory,eventAction:eventAction,eventLabel:label,hitCallback:function(){var href=clicked.attr("href");if(/^#|^javscript:/.test(href||""))return false;location.href=href}});e.preventDefault();return false})};ns.provide({registerElement:createTextLinkClickTracker})});Namespace("jp.mixi.analysis.google_analytics.timingtracker").use("jp.co.mixi.net.uri parseQueryString").use("jp.mixi.device.checker isSmartDevice").use("jp.co.mixi.logging Log").use("jp.mixi.analysis.growthforecast gauge").define(function(ns){"use strict";var SERVICE_NAME_FOR_GROWTH_FORECAST="timingtracker_on_real_device_android";var REAL_DEVICE_ANDROID_BENCHMARK_FLAG_KEY="enabled-real-device-android-benchmark";var FROM={LOAD:"load",DOM_LOADING:"domLoading",DOM_CONTENT_LOADED_EVENT_START:"domContentLoadedEventStart"};var TimingTracker=function(options){var _isAvailableNavigationTimingAPI=!!(window.performance&&window.performance.timing);if(options&&options.from===FROM.LOAD){this.startTime=window._mixiGaTimingInfo.startTime}else if(options&&options.from===FROM.DOM_LOADING){this.startTime=_isAvailableNavigationTimingAPI&&window.performance.timing.domLoading}else if(options&&options.from===FROM.DOM_CONTENT_LOADED_EVENT_START){this.startTime=_isAvailableNavigationTimingAPI&&window.performance.timing.domContentLoadedEventStart}else{this.startTime=(new Date).getTime()}this.isSent=false};TimingTracker.prototype.sendTiming=function(trackerName,params){if(this.isSent)return;if(!ns.isSmartDevice())return;if(!this.startTime)return;if(!trackerName)throw new Error("trackerName required");if(!(params&&params.timingCategory))throw new Error("timingCategory required");if(!(params&&params.timingVar))throw new Error("timingVar required");var timingValue=(new Date).getTime()-this.startTime;if(this._isEnabledRealDeviceAndroidBenchmark(location)){this._sendTimingToMixiGrowthForecast(trackerName,params,timingValue)}this._sendTimingToGoogleAnalytics(trackerName,params,timingValue);this.isSent=true};TimingTracker.prototype._sendTimingToGoogleAnalytics=function(trackerName,params,timingValue){window.ga(trackerName+".send","timing",{timingCategory:params.timingCategory,timingVar:params.timingVar,timingValue:timingValue,timingLabel:params.timingLabel})};TimingTracker.prototype._sendTimingToMixiGrowthForecast=function(trackerName,params,timingValue){var labelPart=params.timingLabel?"_"+params.timingLabel:"";var isGrowthForecastLoaded="gauge"in ns;if(!isGrowthForecastLoaded){ns.Log.warn("GrowthForecast are not available on the production env.");return}var replaceNonAlphanumChar=function(str){return str.replace(/[^0-9a-z\._-]/gi,"_")};ns.gauge({service:SERVICE_NAME_FOR_GROWTH_FORECAST,section:replaceNonAlphanumChar(params.timingCategory+labelPart),graph:replaceNonAlphanumChar(params.timingVar),number:timingValue})};TimingTracker.prototype._isEnabledRealDeviceAndroidBenchmark=function(loc){var queryString=loc.search.slice(1);var queryMap=ns.parseQueryString(queryString);return Boolean(Number(queryMap[REAL_DEVICE_ANDROID_BENCHMARK_FLAG_KEY]))};ns.provide({TimingTracker:TimingTracker,FROM_OPTIONS:FROM})});Namespace("jp.mixi.analysis.widget.elementtracker").use("jp.co.mixi.dom.dataset.formatter format").use("jp.co.mixi.net.jsonrpc JSONRPC").use("jp.co.mixi.net.storage Storage").define(function(ns){"use strict";var isImpressionEventSent=false;function appendTracker(element,dataset){var formattedDataset=ns.format({trackingNamespace:"string",trackingResourceId:"string"},dataset);appendImpressionTracker(element,formattedDataset);appendClickTracker(element,formattedDataset)}function appendImpressionTracker(element,dataset){var scrollCheckInterval=500;var $window=$j(window);var impressionTracker=_.throttle(function(){if($window.scrollTop()+$window.height()>=$j(element).offset().top){$window.off("load",impressionTracker);$window.off("scroll",impressionTracker);sendEvent("impression",dataset,function(){isImpressionEventSent=true})}},scrollCheckInterval);$window.on("load",impressionTracker);$window.on("scroll",impressionTracker)}function appendClickTracker(element,dataset){$j(element).one("click",function(e){var nextLocation=element.href;if(nextLocation)e.preventDefault();if(!isImpressionEventSent)sendEvent("impression",dataset);sendEvent("click",dataset,function(){if(nextLocation)location.href=nextLocation})})}function sendEvent(eventName,dataset,onComplete){var isFirstTrackingPer24h=true;if(ns.Storage.isAvailable()){var storageNamespace=ns.CURRENT_NAMESPACE;var storageKey=[dataset.trackingNamespace,dataset.trackingResourceId,eventName].join("-");var storageExpire=1e3*60*60*24;var storageExpireDate=new Date(Date.now()+storageExpire);isFirstTrackingPer24h=ns.Storage.load(storageNamespace,storageKey)?false:true;try{ns.Storage.save(storageNamespace,storageKey,true,storageExpireDate)}catch(e){}}var timeout=500;ns.JSONRPC.createService("/system/rpc.json",{auth_type:"none"}).call("jp.mixi.analysis.elementtracker.element.track",{namespace:dataset.trackingNamespace,resource_id:dataset.trackingResourceId,event:eventName,is_first_tracking_per_24h:isFirstTrackingPer24h},onComplete||function(){},onComplete||function(){});if(onComplete){setTimeout(onComplete,timeout)}}ns.provide({registerElement:appendTracker})});Namespace("jp.mixi.analysis.widget.uieventinvoker").use("jp.mixi.service.analysis postUIEventLog,postUIEventLogToGA").define(function(ns){"use strict";var shouldSendToGA=function(dataset){return!!dataset.trackerName};var sendToGA=function(dataset){ns.postUIEventLogToGA(dataset.trackerName,{eventCategory:dataset.eventCategory,eventAction:dataset.eventAction,eventLabel:dataset.eventLabel,eventValue:dataset.eventValue})};var sendToSyslog=function(dataset){var moveToOtherPage;if(dataset.href){moveToOtherPage=function(){location.href=dataset.href}}ns.postUIEventLog(dataset.eventName,dataset.pageName,moveToOtherPage)};var logUIEvent=function(element,dataset){if(dataset.href){$j(element).on("click",function(e){e.preventDefault();shouldSendToGA(dataset)?sendToGA(dataset):sendToSyslog(dataset)})}else{$j(element).on("mousedown",function(e){shouldSendToGA(dataset)?sendToGA(dataset):sendToSyslog(dataset)})}};ns.provide({registerElement:logUIEvent})});Namespace("jp.mixi.analysis.performance.navigationtimingapi").define(function(ns){"use strict";ns.provide({performance:window.performance,isNavigationTimingAPIAvailable:function(){return Boolean(window.performance)}})});(function(){"use strict";var isPerformanceTimingsCollected=false;$j(window).on("load",function navigationTimingAPILogSenderOnLoad(){isPerformanceTimingsCollected=true});Namespace("jp.mixi.analysis.performance.navigationtimingapilogger").use("jp.co.mixi.logging Log").use("jp.co.mixi.lang.location location").use("jp.mixi.analysis.performance.navigationtimingapilogger.syslogsender SyslogSender").use("jp.mixi.analysis.performance.navigationtimingapi performance,isNavigationTimingAPIAvailable").define(function(ns){var CHECKING_STAMPS_INTERVAL_MSEC=500;var NavigationTimingAPILogger=function(senders){this.senders=senders;this.additionalTiming={};this.additionalTimingKeysToWait=[];this.isSent=false};NavigationTimingAPILogger.prototype.enableAutomaticallySending=function(){var that=this;if(!ns.isNavigationTimingAPIAvailable()){return}var timeoutHandler=function(){var isAllAdditionalTimingsCollected=that.additionalTimingKeysToWait.length===0||_.every(that.additionalTimingKeysToWait,function(additionalTimingKeyToWait){return additionalTimingKeyToWait in that.additionalTiming});if(!(isAllAdditionalTimingsCollected&&isPerformanceTimingsCollected)){setTimeout(timeoutHandler,CHECKING_STAMPS_INTERVAL_MSEC);return}that.sendLog()};timeoutHandler()};NavigationTimingAPILogger.prototype.waitToStamp=function(eventName){if(this.isSent){ns.Log.warn("This logger already sent logs. You should send once more.")}this.additionalTimingKeysToWait.push(eventName)};NavigationTimingAPILogger.prototype.sendLog=function(){if(!ns.isNavigationTimingAPIAvailable()){return}_.each(this.senders,function(sender){sender.sendLog(ns.location.href,ns.performance.navigation,ns.performance.timing,this.additionalTiming)},this);this.isSent=true};NavigationTimingAPILogger.prototype.stamp=function(eventName){if(eventName in this.additionalTiming){ns.Log.warn("The event is already stamped: "+eventName);return}if(this.isSent){ns.Log.warn("This logger already sent logs. You should send once more or "+"use `waitToStamp('"+eventName+"')` before `load` event dispatched.")}this.additionalTiming[eventName]=(new Date).getTime()};var defaultLogger=new NavigationTimingAPILogger([ns.SyslogSender]);defaultLogger.enableAutomaticallySending();ns.provide({NavigationTimingAPILogger:NavigationTimingAPILogger,defaultLogger:defaultLogger})})})();Namespace("jp.mixi.analysis.performance.navigationtimingapilogger.syslogsender").use("jp.co.mixi.net.jsonrpc JSONRPC").use("jp.co.mixi.gateway gateway").use("jp.co.mixi.logging Log").define(function(ns){"use strict";var _callJSONRPC=function(params){var postKey=ns.gateway("rpc_post_key");var rpc=ns.JSONRPC.createService("/system/rpc.json",{auth_type:"postkey",secret:postKey});rpc.call("jp.mixi.analysis.performance.logNavigationTimingAPI",params,function(response){var error=response.error;if(error){ns.Log.error(["failed to post log",error.code,error.message].join(" "))}})};ns.provide({SyslogSender:{sendLog:function(locationHref,performanceNavigation,performanceTiming,additionalTiming){var jsonrpcParams={location_href:locationHref,performance_navigation:performanceNavigation,performance_timing:performanceTiming,additional_timing:additionalTiming};_callJSONRPC(jsonrpcParams)}}})});