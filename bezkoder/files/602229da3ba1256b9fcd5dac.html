"use strict";var __extends=this&&this.__extends||function(){var extendStatics=function(d,b){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)if(Object.prototype.hasOwnProperty.call(b,p))d[p]=b[p]};return extendStatics(d,b)};return function(d,b){extendStatics(d,b);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)}}();var mixiJsErrorReport;(function(mixiJsErrorReport){function toStringByErrorLikeObject(errorLike){try{if(!errorLike){return String(errorLike)}if(typeof errorLike.stack==="string"){return errorLike.stack}if(typeof errorLike.message==="string"){return errorLike.message}return String(errorLike)}catch(e){return"(Object that have a broken #toString)"}}mixiJsErrorReport.toStringByErrorLikeObject=toStringByErrorLikeObject})(mixiJsErrorReport||(mixiJsErrorReport={}));var mixiJsErrorReport;(function(mixiJsErrorReport){var SafeLogger=function(){function SafeLogger(di){this.di=di}SafeLogger.prototype.logSafely=function(message){try{this.di.global.console.error(message)}catch(e){}};SafeLogger.prototype.logCaughtErrorSafely=function(errorLikeObj){try{this.logSafely(mixiJsErrorReport.toStringByErrorLikeObject(errorLikeObj))}catch(e){}};return SafeLogger}();mixiJsErrorReport.SafeLogger=SafeLogger})(mixiJsErrorReport||(mixiJsErrorReport={}));var mixiJsErrorReport;(function(mixiJsErrorReport){var StrictMixiGateway=function(){function StrictMixiGateway(di){this.di=di}StrictMixiGateway.prototype.getParamStrict=function(paramName){this.assertMixiGatewayIsDefined(paramName);var params=this.di.global.Mixi.Gateway.getParam();this.assertParamIsDefined(paramName,params);return params[paramName]};StrictMixiGateway.prototype.assertMixiGatewayIsDefined=function(paramName){var global=this.di.global;var mixiGatewayExists=global.Mixi&&global.Mixi.Gateway&&typeof global.Mixi.Gateway.getParam==="function";if(!mixiGatewayExists){throw new Error('Mixi.Gateway.getParam is unavailable: "'+paramName+'"')}};StrictMixiGateway.prototype.assertParamIsDefined=function(paramName,params){if(!(paramName in params)){throw new Error('Specified Mixi.Gateway parameter is not defined: "'+paramName+'"')}};return StrictMixiGateway}();mixiJsErrorReport.StrictMixiGateway=StrictMixiGateway})(mixiJsErrorReport||(mixiJsErrorReport={}));var mixiJsErrorReport;(function(mixiJsErrorReport){var ENABLE_SAMPLING_ON_DEBUG_ENV=false;var ERROR_REPORT_SAMPLING_RATE_KEY="error_report_sampling_rate";var SAMPLING_RATE_FOR_SERVER_SIDE_SAMPLING_UNAVAILABLE=.001*10;var Sampler=function(){function Sampler(di){this.di=di}Sampler.prototype.isSampleSafely=function(){try{var _a=this.di,logger=_a.logger,randomGen=_a.randomGen;var samplingRateHint=this.getSamplingRateSafely();if(samplingRateHint.standaloneMode.enabled&&!samplingRateHint.developmentMode.enabled){logger.logSafely("Standalone mode is enabled. Becayse the sampling rate "+"from the server via 'Mixi.Gateway.getParam' is unavailable: "+(""+samplingRateHint.standaloneMode.reason))}return randomGen()<samplingRateHint.samplingRate}catch(e){this.di.logger.logCaughtErrorSafely(e);return false}};Sampler.prototype.getSamplingRateSafely=function(){try{var gateway=this.di.gateway;if(this.shouldEnableDevelMode()){return{samplingRate:1,developmentMode:{enabled:true,reason:"Staging or development environment"},standaloneMode:{enabled:true,reason:"Using 100% as the sampling rate because: Development mode"}}}var samplingRateFromGateway=gateway.getParamStrict(ERROR_REPORT_SAMPLING_RATE_KEY);return{samplingRate:Number(samplingRateFromGateway),developmentMode:{enabled:false,reason:this.isStagingOrDevelEnv()?"Staging or development environment but ENABLE_SAMPLING_ON_DEBUG_ENV is true":"Production environment"},standaloneMode:{enabled:false,reason:"Using the server-side sampling rate"}}}catch(e){var errorMsg=mixiJsErrorReport.toStringByErrorLikeObject(e);return{samplingRate:SAMPLING_RATE_FOR_SERVER_SIDE_SAMPLING_UNAVAILABLE,developmentMode:{enabled:false,reason:"Error was thrown during sampling: "+errorMsg},standaloneMode:{enabled:true,reason:"Using the client-side sampling rate because: "+errorMsg}}}};Sampler.prototype.shouldEnableDevelMode=function(){return!ENABLE_SAMPLING_ON_DEBUG_ENV&&this.isStagingOrDevelEnv()};Sampler.prototype.isStagingOrDevelEnv=function(){var location=this.di.global.location;return Boolean(location&&typeof location.hostname==="string"&&location.hostname.match(/(d[0-9]{6}\.lo|s[0-9]{4}\.st)\./))};return Sampler}();mixiJsErrorReport.Sampler=Sampler})(mixiJsErrorReport||(mixiJsErrorReport={}));var mixiJsErrorReport;(function(mixiJsErrorReport){mixiJsErrorReport.MAX_REPORT_COUNT_CAN_SEND_PER_SESSION=100;var ErrorWatcherState=function(){function ErrorWatcherState(di){this.di=di;this.hint={plan:"NOT_SUPPRESSED_YET",reason:"Never been suppressed"};var limit=di.limit;this.errorReportRemained=limit}ErrorWatcherState.prototype.shouldSendErrorReport=function(){if(this.hint.plan==="ALREADY_SUPPRESSED"){return this.hint}if(!this.di.sampler.isSampleSafely()){return{plan:"ALREADY_SUPPRESSED",reason:"Not sample"}}return this.hint};ErrorWatcherState.prototype.suppressReporting=function(){this.hint={plan:"ALREADY_SUPPRESSED",reason:"Server said 'No thanks'"}};ErrorWatcherState.prototype.consumeErrorReportCount=function(){var limit=this.di.limit;if(this.errorReportRemained<=0){this.hint={plan:"ALREADY_SUPPRESSED",reason:"Already reached a limit: "+limit};return}this.errorReportRemained--;if(this.errorReportRemained<=0){this.hint={plan:"WILL_SUPPRESSED_AFTER_THE_NEXT",reason:"Reached a limit: "+limit};return}};return ErrorWatcherState}();mixiJsErrorReport.ErrorWatcherState=ErrorWatcherState})(mixiJsErrorReport||(mixiJsErrorReport={}));var mixiJsErrorReport;(function(mixiJsErrorReport){function composeDI(partialDI){partialDI=partialDI||{};var global=partialDI.global||window;var Error=partialDI.Error||window.Error;var XMLHttpRequest=partialDI.XMLHttpRequest||window.XMLHttpRequest;var logger=partialDI.logger||new mixiJsErrorReport.SafeLogger({global:global});var gateway=partialDI.gateway||new mixiJsErrorReport.StrictMixiGateway({global:global});var restfulApiClient=partialDI.restfulApiClient||new mixiJsErrorReport.restfulApi.SafeClient({logger:logger,global:global,XMLHttpRequest:XMLHttpRequest});var randomGen=partialDI.randomGen||function(){return Math.random()};var sampler=partialDI.sampler||new mixiJsErrorReport.Sampler({gateway:gateway,logger:logger,randomGen:randomGen,global:global});var state=partialDI.state||new mixiJsErrorReport.ErrorWatcherState({sampler:sampler,limit:mixiJsErrorReport.MAX_REPORT_COUNT_CAN_SEND_PER_SESSION});return{logger:logger,gateway:gateway,restfulApiClient:restfulApiClient,randomGen:randomGen,global:global,state:state,sampler:sampler,XMLHttpRequest:XMLHttpRequest,Error:Error}}mixiJsErrorReport.composeDI=composeDI})(mixiJsErrorReport||(mixiJsErrorReport={}));var mixiJsErrorReport;(function(mixiJsErrorReport){var restfulApi;(function(restfulApi){var HttpError=function(_super){__extends(HttpError,_super);function HttpError(message){return _super.call(this,message)||this}HttpError.createByHttpStatusCode=function(statusCode){return new HttpError("Unexpected status code: "+statusCode)};return HttpError}(Error);restfulApi.HttpError=HttpError;var SafeClient=function(){function SafeClient(di){this.di=di}SafeClient.prototype.callSafely=function(options,callback){var _this=this;try{var url=options.url,method=options.method,body=options.body;var xhr_1=new this.di.XMLHttpRequest;xhr_1.open(method,url);xhr_1.setRequestHeader("Content-Type","application/json");xhr_1.onreadystatechange=function(){try{if(xhr_1.readyState===4){if(xhr_1.status>=200&&xhr_1.status<300){_this.assertResponseContentType(xhr_1.getResponseHeader("Content-Type"));var response={statusCode:xhr_1.status,body:JSON.parse(xhr_1.responseText)};_this.handleSuccessulSafely(response,callback)}else{throw HttpError.createByHttpStatusCode(xhr_1.status)}}}catch(e){_this.handleErrorSafely(e,callback)}};xhr_1.send(JSON.stringify(body))}catch(e){this.handleErrorSafely(e,callback)}};SafeClient.prototype.assertResponseContentType=function(responseContentType){switch(responseContentType){case"application/json":return;default:throw new Error("Expected Content-Type of the reponse to be "+'"application/json" or so on but got: '+(""+responseContentType))}};SafeClient.prototype.handleErrorSafely=function(error,callback){try{callback([error,undefined])}catch(e){this.di.logger.logCaughtErrorSafely(e)}};SafeClient.prototype.handleSuccessulSafely=function(response,callback){try{callback([undefined,response])}catch(e){this.handleErrorSafely(e,callback)}};return SafeClient}();restfulApi.SafeClient=SafeClient})(restfulApi=mixiJsErrorReport.restfulApi||(mixiJsErrorReport.restfulApi={}))})(mixiJsErrorReport||(mixiJsErrorReport={}));var mixiJsErrorReport;(function(mixiJsErrorReport){var START_CONTENT_LENGTH=30;var END_CONTENT_LENGTH=30;function getScriptTagHints(global){var scriptTagHints=[];var scripts=global.document.getElementsByTagName("script");for(var i=0,len=scripts.length;i<len;i++){var currentScript=scripts[i];var attrDict={};var attrs=currentScript.attributes;for(var attrIdx=0,attrsLen=attrs.length;attrIdx<attrsLen;attrIdx++){attrDict[attrs[attrIdx].name]=attrs[attrIdx].value}var scriptContent=currentScript.innerHTML;scriptTagHints.push({startContent:scriptContent.slice(0,START_CONTENT_LENGTH),endContent:scriptContent.slice(-END_CONTENT_LENGTH),contentLength:scriptContent.length,attributes:attrDict})}return scriptTagHints}mixiJsErrorReport.getScriptTagHints=getScriptTagHints})(mixiJsErrorReport||(mixiJsErrorReport={}));var mixiJsErrorReport;(function(mixiJsErrorReport){function getUserId(global){var cookie=global.document.cookie||"";var match=/_auid=([0-9a-f]+)/.exec(cookie);var auid=match&&match[1];return auid||"N/A"}mixiJsErrorReport.getUserId=getUserId})(mixiJsErrorReport||(mixiJsErrorReport={}));var mixiJsErrorReport;(function(mixiJsErrorReport){function createParamsByGlobalErrorHandlerArgs(args,samplingRateHint,planToSuppressHint,global){var samplingRate=samplingRateHint.samplingRate,standaloneMode=samplingRateHint.standaloneMode,developmentMode=samplingRateHint.developmentMode;var params={standalonemode:{enabled:standaloneMode.enabled,reason:standaloneMode.reason},developmentmode:{enabled:developmentMode.enabled,reason:developmentMode.reason},samplingrate:samplingRate,readystate:global.document.readyState,scripttags:[],auid:mixiJsErrorReport.getUserId(global),circuitbreaker:{enabled:planToSuppressHint.plan==="WILL_SUPPRESSED_AFTER_THE_NEXT",reason:planToSuppressHint.reason}};var messageOrEvent=args[0],source=args[1],lineno=args[2],colno=args[3],error=args[4];if(args.length>=1)params["message"]=messageOrEvent.toString();if(args.length>=2)params["source"]=source;if(args.length>=3)params["lineno"]=lineno;if(args.length>=4)params["colno"]=colno;if(args.length>=5&&error&&typeof error.stack==="string"){params["stack"]=error.stack}return params}mixiJsErrorReport.createParamsByGlobalErrorHandlerArgs=createParamsByGlobalErrorHandlerArgs})(mixiJsErrorReport||(mixiJsErrorReport={}));var mixiJsErrorReport;(function(mixiJsErrorReport){function map(array,fn){var result=[];for(var i=0,len=array.length;i<len;i++){result.push(fn(array[i],i))}return result}mixiJsErrorReport.map=map})(mixiJsErrorReport||(mixiJsErrorReport={}));var mixiJsErrorReport;(function(mixiJsErrorReport){function createEncodedParamsByGlobalErrorHandlerArgs(args,samplingRateHint,planToSuppressHint,global){var samplingRate=samplingRateHint.samplingRate,standaloneMode=samplingRateHint.standaloneMode,developmentMode=samplingRateHint.developmentMode;var params={standalonemode:{enabled:standaloneMode.enabled,reason:encodeURI(standaloneMode.reason)},developmentmode:{enabled:developmentMode.enabled,reason:encodeURI(developmentMode.reason)},samplingrate:samplingRate,readystate:global.document.readyState,scripttags:mixiJsErrorReport.map(mixiJsErrorReport.getScriptTagHints(global),encodeScriptTagHint),auid:encodeURI(mixiJsErrorReport.getUserId(global)),circuitbreaker:{enabled:planToSuppressHint.plan==="WILL_SUPPRESSED_AFTER_THE_NEXT",reason:encodeURI(planToSuppressHint.reason)}};var messageOrEvent=args[0],source=args[1],lineno=args[2],colno=args[3],error=args[4];if(args.length>=1)params["message"]=encodeURI(messageOrEvent.toString());if(args.length>=2&&typeof source==="string"){params["source"]=encodeURI(source)}if(args.length>=3)params["lineno"]=lineno;if(args.length>=4)params["colno"]=colno;if(args.length>=5&&error&&typeof error.stack==="string"){params["stack"]=encodeURI(error.stack)}return params}mixiJsErrorReport.createEncodedParamsByGlobalErrorHandlerArgs=createEncodedParamsByGlobalErrorHandlerArgs;function encodeScriptTagHint(hint){var startContent=hint.startContent,endContent=hint.endContent,contentLength=hint.contentLength,attributes=hint.attributes;return{startContent:encodeURI(startContent),endContent:encodeURI(endContent),contentLength:contentLength,attributes:encodeScriptTagAttribute(attributes)}}function encodeScriptTagAttribute(attributes){var encodedAttributes={};for(var key in attributes){if(!attributes.hasOwnProperty(key))continue;encodedAttributes[encodeURI(key)]=encodeURI(attributes[key])}return encodedAttributes}})(mixiJsErrorReport||(mixiJsErrorReport={}));var mixiJsErrorReport;(function(mixiJsErrorReport){function createGlobalErrorHandler(di){return function(){var logger=di.logger,state=di.state,sampler=di.sampler,global=di.global,restfulApiClient=di.restfulApiClient;try{state.consumeErrorReportCount();var hint=state.shouldSendErrorReport();if(hint.plan==="ALREADY_SUPPRESSED")return;var encodedParams=mixiJsErrorReport.createEncodedParamsByGlobalErrorHandlerArgs(arguments,sampler.getSamplingRateSafely(),hint,global);restfulApiClient.callSafely({url:"https://f1gtnk7qvl.execute-api.ap-northeast-1.amazonaws.com/prod/report",method:"POST",body:encodedParams},function(result){try{var error=result[0];if(error)throw error}catch(e){state.suppressReporting();logger.logCaughtErrorSafely(e)}})}catch(e){logger.logCaughtErrorSafely(e)}}}function watchUncaughtErrors(di){var global=di.global;global.onerror=createGlobalErrorHandler(di)}mixiJsErrorReport.watchUncaughtErrors=watchUncaughtErrors})(mixiJsErrorReport||(mixiJsErrorReport={}));var mixiJsErrorReport;(function(mixiJsErrorReport){var di=mixiJsErrorReport.composeDI();mixiJsErrorReport.watchUncaughtErrors(di)})(mixiJsErrorReport||(mixiJsErrorReport={}));