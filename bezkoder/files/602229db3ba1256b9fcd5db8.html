var __values=this&&this.__values||function(o){var s=typeof Symbol==="function"&&Symbol.iterator,m=s&&o[s],i=0;if(m)return m.call(o);if(o&&typeof o.length==="number")return{next:function(){if(o&&i>=o.length)o=void 0;return{value:o&&o[i++],done:!o}}};throw new TypeError(s?"Object is not iterable.":"Symbol.iterator is not defined.")};var __read=this&&this.__read||function(o,n){var m=typeof Symbol==="function"&&o[Symbol.iterator];if(!m)return o;var i=m.call(o),r,ar=[],e;try{while((n===void 0||n-- >0)&&!(r=i.next()).done)ar.push(r.value)}catch(error){e={error:error}}finally{try{if(r&&!r.done&&(m=i["return"]))m.call(i)}finally{if(e)throw e.error}}return ar};Namespace("jp.co.mixi.animation").use("brook.channel sendChannel").define(function(ns){var Transform=function(){var _Transform=function(){this.expression=""};(function(){this.scale=function(x,y){this.expression+="scale("+[x||1,y||1].join(",")+") ";return this};this.rotate=function(deg){this.rotate+="rotate("+deg+"deg) ";return this};this.translate=function(x,y){this.expression+="translate3d("+[x||"0",y||"0","0"].map(function(ex){return ex+"px"}).join(",")+") ";return this};this.skew=function(x,y){this.expression+="skew("+[x||"0",y||"0"].map(function(ex){return ex+"deg"}).join(",")+") ";return this};this.toString=function(){return this.expression}}).apply(_Transform.prototype);return{scale:function(){var instance=new _Transform;_Transform.prototype.scale.apply(instance,arguments);return instance},rotate:function(){var instance=new _Transform;_Transform.prototype.rotate.apply(instance,arguments);return instance},translate:function(){var instance=new _Transform;_Transform.prototype.translate.apply(instance,arguments);return instance},skew:function(){var instance=new _Transform;_Transform.prototype.skew.apply(instance,arguments);return instance}}}();var Transition=function(){var parseTime=function(str){return parseFloat(str||"0")*(/ms$/.test(str)?1:1e3)};var _TransitionElement=function(element,transitions){var options=transitions||{};this.element=element;this._toStyle={};this._afterStyle={};this.element.setStyle({"transition-duration":(options.duration||600)+"ms","transition-property":options.property||"all","transition-timing-function":typeof options["timing-function"]==="string"?options["timing-function"]:typeof options["timing-function"]==="undefined"?"ease":"cubic-bezier("+options["timing-function"].join(",")+")"});var _self=this;setTimeout(function(){_self.element.setStyle(_self._toStyle||{})},10);var durationTime=parseTime(_self.element.getStyle("transition-duration"))+parseTime(_self.element.getStyle("transition-delay"));setTimeout(function(){_self.element.setStyle({"transition-duration":"0s","transition-property":"none"}).setStyle(_self._afterStyle||{});(_self._callback||function(){}).apply(_self);setTimeout(function(){ns.sendChannel("jp.co.mixi.animation.transition.end").run()},500)},durationTime)};(function(){this.from=function(styleObject){this.element.setStyle(styleObject||{});return this};this.to=function(styleObject){this._toStyle=styleObject;return this};this.after=function(styleObject){this._afterStyle=styleObject;return this};this.callback=function(callback){this._callback=callback}}).apply(_TransitionElement.prototype);return function(element,extraOptions){return new _TransitionElement(element,extraOptions)}}();ns.provide({Transition:Transition,CSSTransform:Transform})});Namespace("jp.co.mixi.animation.effect").use("jp.co.mixi.animation Transition").use("jp.co.mixi.animation CSSTransform").define(function(ns){function fade(element,afterFade){ns.Transition(element).from({opacity:1,transform:ns.CSSTransform.translate(0,0)}).to({opacity:0,transform:ns.CSSTransform.translate(0,0)}).callback(afterFade)}ns.provide({fade:fade})});Namespace("jp.co.mixi.animation.scroll").define(function(ns){ns.provide({smoothScrollTo:function(element,options){var stopY=element.offsetTop,startY=window.pageYOffset;options=options||{};if(stopY==startY){if(options.hasOwnProperty("callback")!==true){return}options.callback();return}var code=stopY>startY?1:-1,distance=Math.abs(stopY-startY),fps=options.fps||30,duration=options.duration||.5,step=Math.round(distance/(fps*duration)),callback=options.callback||function(){},counter=0;var timerId=setInterval(function(){var isEndPhase=false;var delta=Math.abs(window.pageYOffset-stopY);if(delta<step||++counter>fps*duration){clearInterval(timerId);isEndPhase=true}window.scrollTo(0,window.pageYOffset+(delta<step?delta:step)*code);if(isEndPhase){window.scrollTo(0,stopY);callback()}},Math.round(1e3/fps))}})});Namespace("jp.co.mixi.asserting").define(function(ns){"use strict";var AssertionError=function(msg){if(!(this instanceof AssertionError))return new AssertionError(msg);this.message="assertion failed"+(msg?": "+msg:"")};var assert=function(cond,msg){if(cond())return;throw AssertionError(msg)};var assertString=function(value,msg){if(_.isString(value))return;throw AssertionError(msg||"expected string but got "+typeof value)};var assertNumber=function(value,msg){if(_.isNumber(value))return;throw AssertionError(msg||"expected number but got "+typeof value)};var assertBoolean=function(value,msg){if(_.isBoolean(value))return;throw AssertionError(msg||"expected boolean but got "+typeof value)};var assertArray=function(value,msg){if(_.isArray(value))return;throw AssertionError(msg||"expected array but got "+_getTypeString(value))};var assertObject=function(value,msg){if(_.isObject(value)&&!_.isFunction(value)&&!_.isArray(value))return;throw AssertionError(msg||"expected object but got "+_getTypeString(value))};var _getTypeString=function(value){return Object.prototype.toString.call(value)};ns.provide({AssertionError:AssertionError,assert:assert,assertString:assertString,assertNumber:assertNumber,assertBoolean:assertBoolean,assertArray:assertArray,assertObject:assertObject})});Namespace("jp.co.mixi.common.image.lazyload").define(function(ns){var DEFAULT_FREQUENCY=500;var LAZYLOAD_CLASSNAME="cpLazyLoad";var DEFAULT_THRESHOLD=500;var _scroll=function(){return window.pageYOffset};var _height=function(){var height=window.innerHeight||document.documentElement.clientHeight;return height};var _cumulativeOffsetTop=function(element){var cumulativeOffsetTop=0;while(element){cumulativeOffsetTop+=element.offsetTop||0;element=element.offsetParent}return cumulativeOffsetTop};var PositionObserver=function(){var Klass=function(){this.frequency=DEFAULT_FREQUENCY;this.checklist=[];this.initialize()};(function(){this.initialize=function(){this.clearId=setInterval(this.check.bind(this),this.frequency)};this.add=function(lazyload){this.checklist.push(lazyload)};this.check=function(){var lazyload;var length=this.checklist.length;for(var i=0;i<length;i++){lazyload=this.checklist[i];if(!lazyload.isLoaded||!lazyload.isLoading)lazyload.checkPosition()}}}).apply(Klass.prototype);return Klass}();var LazyLoad=function(){var Klass=function(element){this.element=element;this.datasets=$D(element);this.defaultSrc=this.element.getAttribute("src");this.threshold=this.datasets.threshold?parseInt(this.datasets.threshold,10):DEFAULT_THRESHOLD;this.isEffect=this.datasets.isEffect=="true"?true:false;this.isLoading=false;this.isLoaded=false;if(!this.datasets.src)return;this.initialize()};(function(){this.initialize=function(){this.hide();this.className=this.datasets.className?this.datasets.className:LAZYLOAD_CLASSNAME;this.setActiveOffsetY();if(this.activeOffsetY<0)this.loadSrc();this.element.addEventListener("load",this.loadImageHandler.bind(this));this.element.addEventListener("error",this.errorImageHandler.bind(this))};this.setActiveOffsetY=function(){this.activeOffsetY=_cumulativeOffsetTop(this.element)-_height()-this.threshold};this.checkPosition=function(){if(this.activeOffsetY>0&&this.activeOffsetY<=_scroll()){this.loadSrc()}};this.loadSrc=function(){if(this.isLoading||this.isLoaded)return;this.isLoading=true;this.element.classList.add(LAZYLOAD_CLASSNAME);this.element.setAttribute("src",this.datasets.src)};this.loadImageHandler=function(e){this.isLoading=false;if(e.target.getAttribute("src")==this.defaultSrc)return;this.isLoaded=true;this.show()};this.errorImageHandler=function(){if(!this.defaultSrc)return;this.isLoading=false;this.isLoaded=true;this.show()};this.show=function(){if(this.isEffect){this.element.style.opacity=1}};this.hide=function(){if(this.isEffect){this.element.style.opacity=0}}}).apply(Klass.prototype);return Klass}();var registerElements=function(elementList){var positionObserver=new PositionObserver;elementList.forEach(function(element){positionObserver.add(new LazyLoad(element))})};ns.provide({registerLazyLoadElements:registerElements,registerElements:registerElements})});Namespace("jp.co.mixi.data.accessor").use("brook.util through,mapper").use("brook.model createModel").define(function(ns){"use strict";var createAccessor=function(data,propertyNames){var _get=function(value){if(!value)value={};_.each(propertyNames,function(propertyName){value[propertyName]=data[propertyName]});return value};var _set=function(value){_.each(propertyNames,function(propertyName){data[propertyName]=value[propertyName]})};var accessor=ns.createModel({get:ns.mapper(_get),set:ns.through(_set)});accessor.funcGet=function(){accessor.notify("get").run();return _get()};accessor.funcSet=function(value){accessor.notify("set").run(value)};return accessor};ns.provide({createAccessor:createAccessor})});Namespace("jp.co.mixi.date.parser").define(function(ns){"use strict";ns.provide({parseMySqlDate:function(datetime){var parts=datetime.split(/[ :-]/).map(function(num){return parseInt(num,10)});return new Date(parts[0],parts[1]-1,parts[2],parts[3],parts[4],parts[5])}})});Namespace("jp.co.mixi.device.checker").use("jp.co.mixi.lang.navigator navigator").define(function(ns){var _isZeptoLoaded=function(){return"Zepto"in window};var _isiOS=function(){return _isZeptoLoaded()&&!!Zepto.os.ios};var _isiPhone=function(){return _isZeptoLoaded()&&!!Zepto.os.iphone};var _isiPhoneOfficialClientWebView=function(){return!!(_isiPhone&&!ns.navigator.userAgent.match(/Safari/)&&ns.navigator.userAgent.match(/nonavigation/))};var _isiPad=function(){return _isZeptoLoaded()&&!!Zepto.os.ipad};var _isAndroid=function(){return _isZeptoLoaded()&&!!Zepto.os.android};var _isChromeForAndroid=function(){return _isAndroid()&&/Chrome/.test(ns.navigator.userAgent)};var _isFirefoxForAndroid=function(){return/Android/.test(ns.navigator.userAgent)&&_isFirefox()};var _isFirefox=function(){return/Firefox/.test(ns.navigator.userAgent)};var _isFirefoxOSMobile=function(){return _isFirefox()&&/(Mobile|Tablet)/.test(ns.navigator.userAgent)&&!_isFirefoxForAndroid()};var _hasFixedPositionBug=function(){return _isiOS()&&_getVersion().charAt(0)=="5"};var _hasIframeClickThroughBug=function(){var version=_getVersion();return _isAndroid()&&parseFloat(version)>=2};var _hasTapHighlightThroughBug=function(){var version=_getVersion();return _isAndroid()&&parseFloat(version)>=2&&parseFloat(version)<3};var _hasPositionAbsoluteParentBug=function(){var version=_getVersion();return _isAndroid()&&parseFloat(version)>=2&&parseFloat(version)<3};var _hasPositionFixedParentBug=function(){var version=_getVersion();return _isAndroid()&&parseFloat(version)>=4};var _hasOnClickConfirmBug=function(){return _isiOS()&&/^7\.0/.test(_getVersion())};var _isSupportFixedPosition=function(){return true};var _isSmoothScrollSupportedDevice=function(){return!(_isAndroid()&&_getVersion()<=2.1)};var _getVersion=function(){return _isZeptoLoaded()?Zepto.os.version:0};var _isSmartDevice=function(){return"createTouch"in document.documentElement||"ontouchstart"in document.documentElement};ns.provide({isiOS:_isiOS,isiPhone:_isiPhone,isiPhoneOfficialClientWebView:_isiPhoneOfficialClientWebView,isiPad:_isiPad,isAndroid:_isAndroid,isChromeForAndroid:_isChromeForAndroid,isFirefoxForAndroid:_isFirefoxForAndroid,isFirefoxOSMobile:_isFirefoxOSMobile,hasFixedPositionBug:_hasFixedPositionBug,hasIframeClickThroughBug:_hasIframeClickThroughBug,hasTapHighlightThroughBug:_hasTapHighlightThroughBug,hasPositionAbsoluteParentBug:_hasPositionAbsoluteParentBug,hasPositionFixedParentBug:_hasPositionFixedParentBug,hasOnClickConfirmBug:_hasOnClickConfirmBug,isSupportFixedPosition:_isSupportFixedPosition,isSmoothScrollSupportedDevice:_isSmoothScrollSupportedDevice,getVersion:_getVersion,isSmartDevice:_isSmartDevice})});Namespace("jp.co.mixi.dom.dataset.converter").define(function(ns){"use strict";ns.provide({booleanize:function(v){if(v==="")return false;if(v==="1")return true;if(v==="0")return false;if(v==="true")return true;if(v==="false")return false;throw new Error("cannot convert boolean")}})});Namespace("jp.co.mixi.dom.dataset.formatter").use("jp.co.mixi.dom.dataset.converter booleanize").use("jp.co.mixi.dom.dataset.parametername trimParameter").use("jp.co.mixi.dom.dataset.validator isValidDataset").define(function(ns){"use strict";var typeConverterMap={string:function(v){return v},number:function(v){return parseInt(v,10)},boolean:ns.booleanize};ns.provide({format:function(format,dataset){if(!ns.isValidDataset(format,dataset)){throw new Error("invalid dataset")}var formattedDataset={};_.each(format,function(value,key){var trimmedKey=ns.trimParameter(key);var data=dataset[trimmedKey];if(!_.isUndefined(data)){formattedDataset[trimmedKey]=typeConverterMap[value](data)}});return formattedDataset}})});Namespace("jp.co.mixi.dom.dataset.parametername").define(function(ns){"use strict";var isOptional=function(key){return key.charAt(0)=="*"};var trim=function(key){return isOptional(key)?key.substring(1):key};ns.provide({isOptionalParameter:isOptional,trimParameter:trim})});Namespace("jp.co.mixi.dom.dataset.validator").use("jp.co.mixi.dom.dataset.converter booleanize").use("jp.co.mixi.dom.dataset.parametername isOptionalParameter,trimParameter").define(function(ns){"use strict";var isBoolean=function(v){try{ns.booleanize(v);return true}catch(e){return false}};var isNumber=function(v){return!_.isNaN(parseInt(v,10))};var typeValidatorMap={string:_.isString,number:isNumber,boolean:isBoolean};ns.provide({isValidDataset:function(format,dataset){if(_.isUndefined(dataset))return false;var invalids=_.filter(format,function(value,key){var param=ns.trimParameter(key);if(ns.isOptionalParameter(key)&&_.isUndefined(dataset[param])){return false}return!typeValidatorMap[value](dataset[param])});return invalids.length==0}})});Namespace("jp.co.mixi.dom.dataurischeme").use("brook promise").use("jp.co.mixi.image.encoder encodeBase64").define(function(ns){"use strict";var getDataURISchemeFromAPI=function(url,mimeType){var prefix="data:"+mimeType+";base64,";return ns.encodeBase64(url).bind(ns.promise(function(next,data){next(prefix+data)}))};var create=function(elem,mimeType){if(!elem){throw"require element"}if(!mimeType){throw"require mimeType"}var imgClone=document.createElement("img");imgClone.setAttribute("crossOrigin","anonymous");return ns.promise(function(next){var getFromAPI=function(){getDataURISchemeFromAPI(elem.src,mimeType).bind(ns.promise(function(innerNext,dataUri){next(dataUri)})).run()};imgClone.onload=function(){imgClone.onload=null;var canvas=document.createElement("canvas");canvas.width=imgClone.width;canvas.height=imgClone.height;var ctx=canvas.getContext("2d");ctx.drawImage(imgClone,0,0);try{next(canvas.toDataURL(mimeType))}catch(e){getFromAPI()}};imgClone.onerror=function(){imgClone.onerror=null;getFromAPI()};imgClone.src=elem.src})};ns.provide({createDataURIScheme:create})});Namespace("jp.co.mixi.dom.deferrer").define(function(ns){"use strict";var createDOMGetter=function(getterFunction,__this){var elementCache;return function(){if(elementCache===undefined){elementCache=__this?getterFunction.apply(__this):getterFunction()}return elementCache}};ns.provide({createDOMGetter:createDOMGetter})});Namespace("jp.co.mixi.dom.event").use("brook *").use("brook.util *").use("brook.dom.compat *").define(function(ns){var observeEvent=function(element,eventName,method){if(!element.enableObserverList)element.enableObserverList=[];element.isEventEnable=true;var observer=method.run?function(e){if(this.isEventEnable)method.run(e)}:function(e){if(this.isEventEnable)method.apply(this,[e])};element.enableObserverList.push({eventName:eventName,method:observer});element.addEventListener(eventName,observer)};var disableAllObserver=function(element){if(!element.enableObserverList.length)return;if(!element.disableObserverList)element.disableObserverList=[];while(element.enableObserverList.length){var observer=element.enableObserverList.shift();element.isEventEnable=false;element.disableObserverList.push(observer)}};var enableAllObserver=function(element){if(!element.disableObserverList.length)return;if(!element.enableObserverList)element.enableObserverList=[];while(element.disableObserverList.length){var observer=element.disableObserverList.shift();element.isEventEnable=true;element.enableObserverList.push(observer)}};ns.provide({observeEvent:observeEvent,disableAllObserver:disableAllObserver,enableAllObserver:enableAllObserver})});Namespace("jp.co.mixi.dom.form").use("jp.co.mixi.lang.util *").use("jp.co.mixi.net HTTPRequester").define(function(ns){var getFormData=function(formId){var postdata={};var form=$(formId);var _push_value=function(ele){if(ele.name===undefined||ele.name===""){return}if(postdata[ele.name]===undefined){postdata[ele.name]=ele.value}else if(ns.isArray(postdata[ele.name])){postdata[ele.name].push(ele.value)}else{postdata[ele.name]=[postdata[ele.name]];postdata[ele.name].push(ele.value)}};$A(form.querySelectorAll("input,select,textarea")).forEach(function(ele){if(ele.tagName=="INPUT"&&(ele.type=="checkbox"||ele.type=="radio")&&!ele.checked){return}_push_value(ele)});return postdata};var asyncSubmitForm=function(formId,otherParams,callback){var form=$(formId);var data=getFormData(formId);ns.merge(data,otherParams);(new ns.HTTPRequester).request({method:form.method.toUpperCase()||ns.HTTPRequester.POST,url:form.action,asynchronous:true,paramPOST:data,paramGET:{},otherRequestHeaders:null},callback);return data};ns.provide({formOf:function(element){var node=element;while((node=node.parentNode)!=null){if(node.tagName=="FORM")break}return node},getFormData:getFormData,asyncSubmitForm:asyncSubmitForm})});Namespace("jp.co.mixi.dom.form.textselection").define(function(ns){var ieSelector={select:function(formElement,offset,length){if(_.isNumber(offset)){var range=formElement.createTextRange();var beforeText=formElement.value.substr(0,offset);var newOffset=beforeText.replace(/\r\n/g,"\n").length;var selectionText=formElement.value.substr(offset,length);var newLength=selectionText.replace(/\r\n/g,"\n").length;range.moveStart("character",newOffset);range.move("character",0);range.moveEnd("character",newLength);range.select()}return document.selection.createRange().text},isSelected:function(formElement){var range=document.selection.createRange();return range.text.length>0},insertText:function(formElement,textStart,textEnd){if(formElement.tagName==="INPUT"){throw"Error: insertText does not support INPUT."}var textRange=document.selection.createRange();var range=formElement.createTextRange();if(textRange.text.replace(/\r?\n/g,"").length===0){textRange.text=textStart+textRange.text+textEnd;return}range.moveToPoint(textRange.offsetLeft,textRange.offsetTop);range.moveEnd("textedit");var selectionLength=textRange.text.length;var lastWraps=formElement.value.match(/(\r?\n)+$/);var lastWrapsLength=!_.isNull(lastWraps)?lastWraps[0].length:0;var beforeLength=formElement.value.length-range.text.length-lastWrapsLength;var afterLength=formElement.value.length-beforeLength-selectionLength;var backText=formElement.value.substr(beforeLength+selectionLength);var backLength=backText.replace(/\r\n/g,"\n").length;range.moveEnd("character",-1*backLength);var newRangeText=textStart+range.text+textEnd;range.text=newRangeText;ieSelector.select(formElement,beforeLength,newRangeText.length)}};var otherSelector={select:function(formElement,offset,length){if(_.isNumber(offset)){formElement.setSelectionRange(offset,offset+length)}var selectionStart=formElement.selectionStart;var selectionEnd=formElement.selectionEnd;return formElement.value.substring(selectionStart,selectionEnd)},isSelected:function(formElement){return formElement.selectionStart!=formElement.selectionEnd},insertText:function(formElement,textStart,textEnd){var selectionStart=formElement.selectionStart;var selectionEnd=formElement.selectionEnd;var beforeText=formElement.value.substring(0,selectionStart);var selectionText=formElement.value.substring(selectionStart,selectionEnd);var afterText=formElement.value.substring(selectionEnd,formElement.value.length);var newSelectionEnd=selectionEnd+textStart.length+textEnd.length;formElement.value=beforeText+textStart+selectionText+textEnd+afterText;if(selectionText.length===0){formElement.setSelectionRange(newSelectionEnd,newSelectionEnd)}else{formElement.setSelectionRange(selectionStart,newSelectionEnd)}}};var selector=!_.isUndefined(document.selection)?ieSelector:otherSelector;ns.provide({select:function(formElement,offset,length){if(_.isUndefined(formElement)){return""}if(_.isNumber(offset)){if(offset<0){offset=0}var afterTextLength=formElement.value.length-offset;if(!_.isNumber(offset)||length>afterTextLength){length=afterTextLength}}formElement.focus();return selector.select(formElement,offset,length)},isSelected:function(formElement){if(_.isUndefined(formElement)){return false}formElement.focus();return selector.isSelected(formElement)},insertText:function(formElement,textStart,textEnd){if(_.isUndefined(formElement)){return}formElement.focus();selector.insertText(formElement,textStart,textEnd)}})});Namespace("jp.co.mixi.dom.imagecache").use("brook promise").use("jp.co.mixi.dom.dataurischeme createDataURIScheme").use("jp.co.mixi.net.storage Storage").use("jp.co.mixi.logging Log").define(function(ns){"use strict";var NAMESPACE_STRING="jp.co.mixi.dom.imagecache";var getExtention=function(fileName){var fileTypes=fileName.split(".");var len=fileTypes.length;if(len===0){return null}return fileTypes[len-1]};var loadImageFromLocalStorage=function(src){return ns.Storage.load(NAMESPACE_STRING,src)};var saveImageToLocalStorage=function(src,img){var expire=new Date;expire.setTime(expire.getTime()+1e3*60*60*24*7);ns.Storage.save(NAMESPACE_STRING,src,img,expire)};ns.provide({registerElement:function(element,dataset){var $element=$j(element);var elementSrc="";$element.on("load",function(){$element.off("load","error");var ext=getExtention(elementSrc);ext=ext||"png";var encodedImage=loadImageFromLocalStorage(elementSrc);if(!encodedImage){ns.createDataURIScheme(element,"image/"+ext).bind(ns.promise(function(next,dataUri){saveImageToLocalStorage(elementSrc,dataUri)})).run()}});$element.on("error",function(){$element.off("load","error");var encodedImage=loadImageFromLocalStorage(elementSrc);if(encodedImage){element.src=encodedImage}else{ns.Log.info("load cache was failed.")}});if(dataset.src){element.src=dataset.src}elementSrc=element.src}})});Namespace("jp.co.mixi.dom.imageloadfailed").use("jp.co.mixi.logging Log").define(function(ns){"use strict";var _DEFAULT_TRIM_LENGTH=20;var _REPLACE_TEXT_CLASS="replaceText";var _trimTextWithWordLength=function(text,trimLength,suffix){var textTrimLength=trimLength||_DEFAULT_TRIM_LENGTH;var textSuffix=suffix||"...";var textLength=text.length;if(textLength<=textTrimLength){return text}else{return text.substr(0,textTrimLength-1)+textSuffix}};ns.provide({registerElement:function(element,dataset){var $element=$j(element);var $img=$element.find("img");var altText=_trimTextWithWordLength($img.attr("alt"));if(!altText){throw new Error("require alt attribute")}$img.on("load",function(){$element.find("."+_REPLACE_TEXT_CLASS).remove();$img.show()});$img.on("error",function(){ns.Log.log("image load failed, then image replaced to this text : "+altText);var $label=$j("<span/>").text(altText).addClass(_REPLACE_TEXT_CLASS);if(dataset.classFailedimageload){$label.addClass(dataset.classFailedimageload)}$element.append($label);$img.hide()})}})});Namespace("jp.co.mixi.dom.position").use("jp.co.mixi.lang parseIntAsDecimal").define(function(ns){"use strict";function positionedOffset(element){var position={top:-ns.parseIntAsDecimal($j(element).css("marginTop")),left:-ns.parseIntAsDecimal($j(element).css("marginLeft"))};do{position.left+=element.offsetLeft;position.top+=element.offsetTop;element=element.offsetParent;if(element){if(element.tagName.toLowerCase()==="body"){break}if($j(element).css("position")!=="static"){break}}}while(element);return position}ns.provide({positionedOffset:positionedOffset})});Namespace("jp.co.mixi.dom.postmessage").use("jp.co.mixi.gateway gateway").define(function(ns){"use strict";var _gateway_url_prefix=function(key){if(!ns.gateway)return;var str=ns.gateway(key);if(!str)return;return str.slice(0,-1)};var TRUSTED_ORIGIN=[_gateway_url_prefix("url_mixi_prefix")||"http://mixi.jp",_gateway_url_prefix("url_mixi_prefix_ssl")||"https://mixi.jp",_gateway_url_prefix("url_fan_prefix")||"http://page.mixi.jp",_gateway_url_prefix("url_fan_prefix_ssl")||"https://page.mixi.jp",_gateway_url_prefix("url_news_prefix")||"http://news.mixi.jp",_gateway_url_prefix("url_news_prefix_ssl")||"https://news.mixi.jp",_gateway_url_prefix("url_photo_prefix")||"http://photo.mixi.jp",_gateway_url_prefix("url_photo_prefix_ssl")||"https://photo.mixi.jp","http://d1aow18uk61pdc.cloudfront.net","http://n2.ads.mreco0.jp","http://test.ads.mreco0.jp"];var listenerTable=[];var trustedOriginTable={};for(var i=0;i<TRUSTED_ORIGIN.length;i++){if(!TRUSTED_ORIGIN[i])continue;trustedOriginTable[TRUSTED_ORIGIN[i]]=true}var _isTrustedOrigin=function(origin){return!!trustedOriginTable[origin]};var _assertPostMessageSupport=function(){if(!window.postMessage){throw new Error("window.postMessage is not supported by browser")}};var _assertTrustedOrigin=function(origin){if(!origin){throw new Error("Origin is missing")}if(!_isTrustedOrigin(origin)){throw new Error('Untrusted origin "'+origin+'"')}};var sendPostMessage=function(targetWindow,payload,targetOrigin){if(typeof payload!=="object"||payload===null){throw new TypeError("Only object is arrowed for payload.")}_assertPostMessageSupport();_assertTrustedOrigin(targetOrigin);setTimeout(function(){try{targetWindow.postMessage(payload,targetOrigin)}catch(e){targetWindow.postMessage(JSON.stringify(payload),targetOrigin)}},0)};var listenPostMessage=function(fromWindow,callback,origin){_assertPostMessageSupport();_assertTrustedOrigin(origin);listenerTable.push({fromWindow:fromWindow,callback:callback,origin:origin})};var listenPostMessageFromAny=function(callback,origins){_assertPostMessageSupport();if(typeof origins==="string"){origins=[origins]}var isListeningOrigin={};for(var i=0;i<origins.length;i++){var origin=origins[i];_assertTrustedOrigin(origin);isListeningOrigin[origin]=true}listenerTable.push({fromAny:true,callback:callback,isListeningOrigin:isListeningOrigin})};var _onMessage=function(e){if(!_isTrustedOrigin(e.origin))return;var decoded=false;var callListener=function(listener){if(!decoded&&typeof e.data==="string"){try{e.data=JSON.parse(e.data)}catch(err){}decoded=true}listener.callback(e)};for(var i=0;i<listenerTable.length;i++){var listener=listenerTable[i];if(listener.fromWindow===e.source){if(listener.origin!==e.origin){throw new Error('listener origin "'+listener.origin+'" does not match to event origin "'+e.origin+'"')}callListener(listener)}else if(listener.fromAny===true&&listener.isListeningOrigin[e.origin]){callListener(listener)}}};if(window.addEventListener){window.addEventListener("message",_onMessage)}else if(window.attachEvent){window.attachEvent("onmessage",_onMessage)}var provide={sendPostMessage:sendPostMessage,listenPostMessage:listenPostMessage,listenPostMessageFromAny:listenPostMessageFromAny};if(window.QUnit){provide._onMessage=_onMessage;provide._clearListeners=function(){listenerTable.length=0}}ns.provide(provide)});Namespace("jp.co.mixi.dom.postmessage.clientserver.client").use("brook promise").use("brook.model createModel").use("jp.co.mixi.dom.postmessage sendPostMessage,listenPostMessage").define(function(ns){"use strict";var MESSAGE_PROTOCOL="jp.co.mixi.dom.postmessage.clientserver";var requesterPool=[];var LIMIT_WAIT_MSEC=6e4;var getPostMessageModel=function(targetWindow,targetOrigin){return _getRequesterInstance(targetWindow,targetOrigin)};var _getRequesterInstance=function(targetWindow,targetOrigin){for(var i=0;i<requesterPool.length;i++){var candidate=requesterPool[i];if(candidate.window===targetWindow){if(candidate.origin===targetOrigin){return candidate.requester}throw new Error('origin "'+targetOrigin+'" is different from'+'previously registered one ("'+candidate.origin+'")')}}var requester=new PostMessageRequester(targetWindow,targetOrigin);requesterPool.push({window:targetWindow,origin:targetOrigin,requester:requester});return requester};var PostMessageRequester=function(targetWindow,targetOrigin){var nextId=1;var requests={};var isDefinedMethod={};var model=ns.createModel();this.waitForRemoteModelPromise=function(){var that=this;return ns.promise(function(n,v){var count=0;var totalMSec=0;var initWait=100;var hasRunCallback=false;var polling=function(wait){totalMSec+=wait;var timer=setTimeout(function(){if(hasRunCallback)return;if(totalMSec>LIMIT_WAIT_MSEC){n(v);throw new Error("May not be able to notify server model.")}that.notify("ready").subscribe(function(v){if(v.ready){if(!hasRunCallback){hasRunCallback=true;n(v)}}},v);count++;polling(initWait+count*count)},wait)};polling(initWait)})};var request=function(method,message,callback){var id=nextId++;var data={protocol:MESSAGE_PROTOCOL,direction:"request",id:id,method:method,message:message};requests[id.toString()]={callback:callback,id:id};ns.sendPostMessage(targetWindow,data,targetOrigin)};var createRequestPromise=function(method){return ns.promise(function(n,v){request(method,v,function(response){n(response)})})};var ensureMethod=function(method){if(isDefinedMethod[method])return;model.addMethod(method,createRequestPromise(method));isDefinedMethod[method]=true};this.notify=function(method){ensureMethod(method);return model.notify.apply(model,arguments)};this.method=function(method){ensureMethod(method);return model.method.apply(model,arguments)};this.addMethod=function(method){throw new Error("Cannot addMethod to client model")};var onReceive=function(e){var data=e.data;if(!(data.protocol===MESSAGE_PROTOCOL&&data.direction==="response"&&!!data.id)){return}var request=requests[data.id.toString()];if(!request)return;delete requests[data.id.toString()];if(data.error){throw new Error('Thrown on remote frame: "'+data.error+'"')}if(!request.callback)return;request.callback(data.message)};ns.listenPostMessage(targetWindow,onReceive,targetOrigin)};ns.provide({getPostMessageModel:getPostMessageModel})});Namespace("jp.co.mixi.dom.postmessage.clientserver.server").use("brook promise").use("brook.model createModel").use("jp.co.mixi.dom.postmessage sendPostMessage,listenPostMessage").define(function(ns){"use strict";var MESSAGE_PROTOCOL="jp.co.mixi.dom.postmessage.clientserver";var responderPool=[];var isServerModelReady=false;var getPostMessageServerModel=function(targetWindow,targetOrigin){var responder=_getResponderInstance(targetWindow,targetOrigin).getModel();responder.ready=function(n,v){isServerModelReady=true};return responder};var _getResponderInstance=function(targetWindow,targetOrigin){for(var i=0;i<responderPool.length;i++){var candidate=responderPool[i];if(candidate.window===targetWindow){if(candidate.origin===targetOrigin){return candidate.responder}throw new Error('origin "'+targetOrigin+'" is different from'+'previously registered one ("'+candidate.origin+'")')}}var responder=new PostMessageResponder(targetWindow,targetOrigin);responderPool.push({window:targetWindow,origin:targetOrigin,responder:responder});return responder};var PostMessageResponder=function(targetWindow,targetOrigin){var model=ns.createModel();model.addMethod("ready",ns.promise(function(n,v){v.ready=isServerModelReady;n(v)}));this.getModel=function(newModel){return model};var respond=function(id,message,isError){var data={protocol:MESSAGE_PROTOCOL,direction:"response",id:id};if(isError){data.error=message}else{data.message=message}ns.sendPostMessage(targetWindow,data,targetOrigin)};var onReceive=function(e){var data=e.data;if(!(data.protocol===MESSAGE_PROTOCOL&&data.direction==="request"&&!!data.id&&!!data.method)){return}var method=data.method;try{model.notify(method).subscribe(function(v){respond(data.id,v,false)},data.message)}catch(err){respond(data.id,err.toString(),true);throw err}};ns.listenPostMessage(targetWindow,onReceive,targetOrigin)};ns.provide({getPostMessageServerModel:getPostMessageServerModel})});Namespace("jp.co.mixi.dom.screen").use("jp.co.mixi.device.checker isiPhone,isAndroid").define(function(ns){var _getScreenHeightByDevice=function(heightAndroid,heightiPhone){var applyHeight=window.innerHeight;if(ns.isAndroid()){applyHeight=window.innerHeight+heightAndroid}if(ns.isiPhone()){applyHeight=window.innerHeight+heightiPhone}return applyHeight};var getScreenHeight=function(){var ANDROID_NAVIGATION_HEIGHT=57;var IPHONE_NAVIGATION_HEIGHT=-64;return _getScreenHeightByDevice(ANDROID_NAVIGATION_HEIGHT,IPHONE_NAVIGATION_HEIGHT)};var getScreenHeightIncludedAddressBar=function(){var ANDROID_NAVIGATION_HEIGHT=57;var isPortrait=window.innerHeight>window.innerWidth;var IPHONE_NAVIGATION_HEIGHT=(isPortrait?480:screen.width)-window.innerHeight-(isPortrait?64:52);return _getScreenHeightByDevice(ANDROID_NAVIGATION_HEIGHT,IPHONE_NAVIGATION_HEIGHT)};ns.provide({getScreenHeight:getScreenHeight,getScreenHeightIncludedAddressBar:getScreenHeightIncludedAddressBar})});Namespace("jp.co.mixi.dom.textarea").define(function(ns){var Textarea=function(element){var placeholderClass=element.dataset.placeholderClass;var modifyClass=function(method){if(!placeholderClass)return;element.classList[method](placeholderClass)};var activatePlaceholder=function(){element.setAttribute("data-is-input","false");element.value=element.dataset.placeholder;modifyClass("add")};var initializePlaceholder=function(){if(element.value===""||element.value===element.dataset.placeholder){activatePlaceholder()}};$j(element).bind("focus",function(e){if(element.dataset.isInput==="true")return;setTimeout(function(){if(element.value===element.dataset.placeholder){element.value=""}},100);modifyClass("remove")});$j(element).bind("blur",function(e){if(!element.value){activatePlaceholder()}else{element.setAttribute("data-is-input","true")}});$j(window).bind("pageshow",initializePlaceholder);initializePlaceholder()};var updatePlaceholder=function(ele,v){if(!_.isString(v))return;if(ele.dataset.isInput==="false"&&ele.value===ele.dataset.placeholder){ele.value=v}$j(ele).attr("data-placeholder",v)};var clearTextarea=function(ele){if(ele.value===ele.dataset.placeholder){ele.value=""}};ns.provide({registerElement:function(element){Textarea(element)},Textarea:Textarea,updatePlaceholder:updatePlaceholder,clearTextarea:clearTextarea})});Namespace("jp.co.mixi.event").use("brook promise").define(function(ns){var observeEvent=function(element,eventName,method){var observer=method.run?function(e){method.run(e)}:function(e){method.apply(this,[e])};$j(element).bind(eventName,observer)};ns.provide({observeEvent:observeEvent})});Namespace("jp.co.mixi.event.pc.windowrefocus").define(function(ns){var ReFocusManager=function(){return{setMonitoringFocus:function(callback){var INTERVAL=1e3;var isFocusOut=false;return setInterval(function(){if(document.hasFocus()){if(isFocusOut){callback()}isFocusOut=false}else{isFocusOut=true}},INTERVAL)},clearMonitoringFocus:function(monitoringFocus){clearInterval(monitoringFocus)}}}();ns.provide({ReFocusManager:ReFocusManager})});Namespace("jp.co.mixi.gateway").define(function(ns){ns.provide({gateway:function(name){return window.Mixi?Mixi.Gateway.getParam(name):undefined},getAllGatewayData:function(){return window.Mixi?Mixi.Gateway.getParam():undefined}})});Namespace("jp.co.mixi.geolocation.util").define(function(ns){var getPositionBetterAccuracy=function(callBack){var limitTime=3e4;var checkTime=1e4;var adoptAccuracy=60;var currentCoords={latitude:null,longitude:null,accuracy:1e8};var checkPosition=function(){if(currentCoords.latitude&&currentCoords.longitude){submit()}return};var submit=function(errorObj){clearInterval(sentryId);navigator.geolocation.clearWatch(watchID);callBack(currentCoords.latitude,currentCoords.longitude,errorObj)};var option={enableHighAccuracy:true,maximumAge:0,timeout:limitTime};var watchID=navigator.geolocation.watchPosition(function(position){if(position.coords.accuracy>currentCoords.accuracy)return;currentCoords=position.coords;if(currentCoords.accuracy<adoptAccuracy){submit()}},function(error){submit(error)},option);var sentryId=setInterval(checkPosition,checkTime)};ns.provide({getPositionBetterAccuracy:getPositionBetterAccuracy})});Namespace("jp.co.mixi.helper").define(function(ns){var Pager=function(){var Klass=function(total,perPage,currentPage){this.total(total);this.perPage(perPage);this.currentPage(currentPage)};(function(){this.total=function(total){if(typeof total!="undefined"){this._total=total}return this._total};this.perPage=function(perPage){if(typeof perPage!="undefined"){this._perPage=perPage}return this._perPage};this.currentPage=function(currentPage){if(typeof currentPage!="undefined"){this._currentPage=currentPage}if(this._currentPage<this.firstPage()){return this.firstPage()}if(this._currentPage>this.lastPage()){return this.lastPage()}return this._currentPage};this.firstPage=function(){return 1};this.lastPage=function(){var pages=this.total()/this.perPage();var lastPage;if(pages==Math.floor(pages)){lastPage=pages}else{lastPage=Math.floor(pages)+1}lastPage=lastPage<1?1:lastPage;return lastPage};this.nextPage=function(){return this.currentPage()<this.lastPage()?this.currentPage()+1:undefined};this.previousPage=function(){return this.currentPage()>1?this.currentPage()-1:undefined};this.first=function(){return this.total()==0?0:(this.currentPage()-1)*this.perPage()+1};this.last=function(){return this.currentPage()==this.lastPage()?this.total():this.currentPage()*this.perPage()};this.skipped=function(){var skipped=this.first()-1;return skipped<0?0:skipped};this.countOnCurrentPage=function(){return this.total()==0?0:this.last()-this.first()+1}}).apply(Klass.prototype);return Klass}();ns.provide({Pager:Pager})});Namespace("jp.co.mixi.image.encoder").use("brook promise").use("jp.co.mixi.net.jsonrpc JSONRPC").use("jp.co.mixi.logging Log").define(function(ns){"use strict";var encodeBase64=function(url){if(!url){throw"require image url"}return ns.promise(function(next){var jsonrpc=ns.JSONRPC.createService("/system/rpc.json");jsonrpc.call("jp.mixi.image.encoder.encodeBase64",{image_url:url},function(response){if(!response.error&&response.result.data){next(response.result.data)}else{ns.Log.info("failed image encode to base64")}})})};ns.provide({encodeBase64:encodeBase64})});Namespace("jp.co.mixi.image.precedentload").use("brook *").use("brook.util *").use("brook.channel *").use("brook.dom.compat *").define(function(ns){var precedentLoad=function(element){var dataset=ns.dataset(element);if(!dataset||!dataset.precedentImages)return;var images=dataset.precedentImages.split(/\s+/);for(var i=0;i<images.length;i++){var src=images[i];if(!src)continue;var image=new Image;image.src=src}};ns.provide({registerElement:precedentLoad,precedentLoad:precedentLoad})});Namespace("jp.co.mixi.lang").use("brook.lambda lambda").define(function(ns){ns.provide({parseIntAsDecimal:ns.lambda("parseInt($,10)")})});Namespace("jp.co.mixi.lang.array").use("brook promise").define(function(ns){var now=function(){return Date.now?Date.now():+new Date};var deferredIterator=function(time,iterator,mapped){time=time||200;return ns.promise(function(next,val){var index=0,length=val.length,results=[];(function watcher(){var start=now();while(index<length&&now()-start<time)results.push(iterator(val[index],index++));if(index<length)setTimeout(watcher,10);else next(mapped?results:val)})()})};ns.provide({deferredEach:function(time,iterator){return deferredIterator(time,iterator,false)},deferredMap:function(time,iterator){return deferredIterator(time,iterator,true)}})});Namespace("jp.co.mixi.lang.boolean").define(function(ns){"use strict";ns.provide({parseBoolean:function(value){return value=="0"||value=="false"?false:!!value}})});Namespace("jp.co.mixi.lang.class").define(function(ns){ns.provide({defineClass:function(){var properties=arguments;var klass=function(){this.initialize.apply(this,arguments)};for(var i=0,l=properties.length;i<l;i++)for(var property in properties[i])klass.prototype[property]=properties[i][property];if(!klass.prototype.initialize)klass.prototype.initialize=function(){};klass.prototype.constructor=klass;return klass},defineClassExtends:function(){var properties=arguments;var parentClass=properties[0];var klass=function(){this.initialize.apply(this,arguments)};var inherit=function(p){if(Object.create){return Object.create(p)}function f(){}f.prototype=p;return new f};klass.prototype=inherit(parentClass.prototype);klass.prototype.constructor=klass;for(var i=1,l=properties.length;i<l;i++)for(var property in properties[i])klass.prototype[property]=properties[i][property];return klass},definePropertyCaller:function(property,method){return function(){return this[property][method].apply(this[property],arguments)}},inherit:function(childClass,parentClass){var tempConstructor=function(){};tempConstructor.prototype=parentClass.prototype;childClass.prototype=new tempConstructor;childClass.prototype.superClass=parentClass.prototype.constructor}})});Namespace("jp.co.mixi.lang.date").define(function(ns){"use strict";var formatTimeSpanAgo=function(timestamp,reference){reference=reference||new Date;var delta=Math.max(0,reference.getTime()-timestamp);function _format_mm_dd(){var date=new Date;date.setTime(timestamp);return _padTo2Digit(date.getMonth()+1)+"月"+_padTo2Digit(date.getDate())+"日"}function _format(base,label){return Math.floor(delta/base)+label}var MS_OF_SECOND=1e3;var MS_OF_MINUTE=MS_OF_SECOND*60;var MS_OF_HOUR=MS_OF_MINUTE*60;var MS_OF_DAY=MS_OF_HOUR*24;return delta>=MS_OF_DAY?_format_mm_dd():delta>=MS_OF_HOUR?_format(MS_OF_HOUR,"時間前"):delta>=MS_OF_MINUTE?_format(MS_OF_MINUTE,"分前"):_format(MS_OF_SECOND,"秒前")};var _padTo2Digit=function(num){if(num<10){return"0"+num.toString()}return num.toString()};ns.provide({formatTimeSpanAgo:formatTimeSpanAgo})});Namespace("jp.co.mixi.lang.location").define(function(ns){"use strict";ns.provide({location:window.location})});Namespace("jp.co.mixi.lang.navigator").define(function(ns){"use strict";ns.provide({navigator:window.navigator})});Namespace("jp.co.mixi.lang.string").define(function(ns){var _isProcessable=function _isProcessable(text){return typeof text==="string"||typeof text==="number"};var _deleteSessionUrl=function(text){if(!_isProcessable(text)){return""}text=text.toString();var chars="[\\w\\-.?&,/=:%+~;#]*";return text.replace(new RegExp("(https?)://(m\\.)?(mixi\\.jp/)(\\w+)(\\.pl)\\?("+chars+")(ses=\\w+&?)("+chars+")","mg"),"$1://$2$3$4$5?$6$8")};var tuneHtml=function tuneHtml(text){if(!_isProcessable(text)){return""}text=text.toString();text=_deleteSessionUrl(text);return text.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br />").replace(/\{/g,"&#123;").replace(/\}/g,"&#125;").replace(/\+/g,"&#043;")};var tuneForm=function tuneForm(text){if(!_isProcessable(text)){return""}text=text.toString();return text.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\{/g,"&#123;").replace(/\}/g,"&#125;").replace(/\+/g,"&#043;").replace(/'/g,"&#039;").replace(/"/g,"&quot;")};var escapeHTML=function(text){if(!_isProcessable(text)){return""}text=text.toString();return text.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\{/g,"&#123;").replace(/\}/g,"&#125;").replace(/\+/g,"&#043;").replace(/'/g,"&#039;").replace(/"/g,"&quot;")};var unescapeHTML=function(text){if(!_isProcessable(text)){return""}text=text.toString();return text.replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&#123;/g,"{").replace(/&#125;/g,"}").replace(/&#043;/g,"+").replace(/&#039;/g,"'").replace(/&quot;/g,'"')};var lineFeedToBreak=function(text){if(!_isProcessable(text)){return""}text=text.toString();return text.replace(/\n/g,"<br />")};var tuneTextarea=function tuneTextarea(text){if(!_isProcessable(text)){return""}text=text.toString();return text.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\{/g,"&#123;").replace(/\}/g,"&#125;").replace(/\+/g,"&#043;")};var _padTo2Digit=function(num){if(num<10){return"0"+num.toString()}return num.toString()};var formatTime=function formatTime(timestamp){var dateObj=new Date(timestamp);return _padTo2Digit(dateObj.getHours())+":"+_padTo2Digit(dateObj.getMinutes())};var formatDate=function formatDate(timestamp){var dateObj=new Date(timestamp);return dateObj.getMonth()+1+"月"+dateObj.getDate()+"日"};var formatDatetime=function formatDatetime(timestamp,enableLeadingZero){var dateObj=new Date;dateObj.setTime(timestamp);var dateStr=dateObj.getFullYear()+"年";dateStr+=(enableLeadingZero?_padTo2Digit(dateObj.getMonth()+1):dateObj.getMonth()+1)+"月";dateStr+=(enableLeadingZero?_padTo2Digit(dateObj.getDate()):dateObj.getDate())+"日";dateStr+=" "+formatTime(timestamp);return dateStr};var formatElapsedTime=function(timestamp){var date=new Date(timestamp);var second=1e3;var minute=second*60;var hour=minute*60;var day=hour*24;var elapsedTime=(new Date).getTime()-date.getTime();if(elapsedTime>day){return _.string.sprintf("%02d月%02d日",date.getMonth()+1,date.getDate())}else if(elapsedTime>hour){return _.string.sprintf("%d時間前",elapsedTime/hour)}else if(elapsedTime>minute){return _.string.sprintf("%d分前",elapsedTime/minute)}else if(elapsedTime>second){return _.string.sprintf("%d秒前",elapsedTime/second)}else{return"0秒前"}};var formatCalendarDate=function(timestamp){if(!timestamp){return null}var WEEK_LABELS=["日","月","火","水","木","金","土"];var date=new Date;date.setTime(timestamp);return date.getMonth()+1+"/"+date.getDate()+"("+WEEK_LABELS[date.getDay()]+")"};var foldText=function foldText(text,length,suffix){if(arguments.length===4){text=arguments[0];length=arguments[1];suffix=arguments[3]}if(length<=0)return text;if(Object.prototype.toString.call(text)==="[object Number]")text=text.toString();if(!(Object.prototype.toString.call(text)==="[object String]"))return"";if(text.length==0)return"";var byteLength=length*2;var escapedString=escape(text);var escapedStringLength=escapedString.length;var innerSuffix=suffix||"…";var escapedIndex=0;var unicodeIndex=0;var byteTotal=0;var resultChars=[];while(escapedIndex<escapedStringLength&&byteTotal<byteLength){if(escapedString.charAt(escapedIndex)=="%"){if(escapedString.charAt(escapedIndex+1)=="u"){byteTotal+=2;escapedIndex+=6}else{byteTotal++;escapedIndex+=3}}else{byteTotal++;escapedIndex++}resultChars.push(text.charAt(unicodeIndex++))}var result=resultChars.join("")+(escapedIndex<escapedStringLength?innerSuffix:"");return result};var snipText=function snipText(text,length,encoding){return foldText(text,length,"...")};var breakUrl=function breakUrl(url){if(!_isProcessable(url)){return""}url=url.toString();for(var i=0,wrappedURL="";i<url.length;i++){wrappedURL+=url.charAt(i);if(i<url.length-1&&(i+1)%7==0){wrappedURL+="<wbr/>"}}return wrappedURL};var isBlank=function(text){return/^(\s|\u3000)*$/.test(text)};var countByteLength=function(text,multibyteCharLength){multibyteCharLength=multibyteCharLength||2;if(!_.isString(text)){return 0}var characters=text.split("");var totalByte=0;_.each(characters,function(c){var isMultibyteChar=escape(c).substring(0,2)=="%u";var charLength=isMultibyteChar?multibyteCharLength:1;totalByte+=charLength});return totalByte};var isEmpty=function(string){var trim=/^[\s\xA0\u3000]+$/;return string.replace(trim,"").length?false:true};var toQueryParams=function(text,delimiter){var delimiterChar=delimiter?delimiter:"&";var arrayOfPair=text.replace(/^.*[?]/,"").replace(/#.*$/,"").split(delimiterChar);if(!arrayOfPair[0]){return{}}var hashOfArray={};var createHash=function(e){var keyValue=e.split("=");var key=keyValue[0];var value=keyValue[1];if(keyValue[1]!==undefined){value=decodeURIComponent(value)}if(hashOfArray[key]){if(_.isArray(hashOfArray[key])){hashOfArray[key].push(value)}else{hashOfArray[key]=[hashOfArray[key],value]}}else{hashOfArray[key]=value}};var length=arrayOfPair.length;for(var i=0;i<length;i++){createHash(arrayOfPair[i])}return hashOfArray};var createUrl=function createUrl(){var args=_.toArray(arguments);if(args.length===0){return""}var path=(args.shift()||"").split("#");var paramList;if(args.length===1&&_.isArray(args[0])){paramList=args[0].slice()}else if(args.length===1&&_.isObject(args[0])){paramList=[];_.each(args[0],function(value,key){paramList.push(key,value)})}else if(args.length>0&&args.length%2===0){paramList=args}else{return path.join("#")}var encodedParamList=_.map(paramList,function(value){if(value===null||value===undefined)return"";return encodeURIComponent(value)});var pairs=[];var pair;while(!_.isEmpty(pair=encodedParamList.splice(0,2))){if(pair[0].length===0)continue;pairs.push(pair.join("="))}if(_.isEmpty(pairs))return path.join("#");if(!_.str.include(path[0],"?")){path[0]=path[0]+"?"}else if(!_.str.endsWith(path[0],"?")&&!_.str.endsWith(path[0],"&")){path[0]=path[0]+"&"}path[0]=path[0]+pairs.join("&");return path.join("#")};ns.provide({escapeHTML:escapeHTML,unescapeHTML:unescapeHTML,lineFeedToBreak:lineFeedToBreak,tuneHtml:tuneHtml,tuneTextarea:tuneTextarea,tuneForm:tuneForm,foldText:foldText,snipText:snipText,breakUrl:breakUrl,formatTime:formatTime,formatDate:formatDate,formatDatetime:formatDatetime,formatElapsedTime:formatElapsedTime,formatCalendarDate:formatCalendarDate,isBlank:isBlank,countByteLength:countByteLength,isEmpty:isEmpty,toQueryParams:toQueryParams,createUrl:createUrl})});Namespace("jp.co.mixi.lang.string.japanese").define(function(ns){var HAN_CHARS=" !\"#$%&'()*+,-./";HAN_CHARS+="0123456789:;<=>?";HAN_CHARS+="@ABCDEFGHIJKLMNO";HAN_CHARS+="PQRSTUVWXYZ[\\]^_";HAN_CHARS+="`abcdefghijklmno";HAN_CHARS+="pqrstuvwxyz{|}~(";HAN_CHARS+=")｡｢｣､･ｦｧｨｩｪｫｬｭｮｯ";HAN_CHARS+="ｰｱｲｳｴｵｶｷｸｹｺｻｼｽｾｿ";HAN_CHARS+="ﾀﾁﾂﾃﾄﾅﾆﾇﾈﾉﾊﾋﾌﾍﾎﾏ";HAN_CHARS+="ﾐﾑﾒﾓﾔﾕﾖﾗﾘﾙﾚﾛﾜﾝﾞﾟ";var ZEN_CHARS="　！＂＃＄％＆＇（）＊＋，－．／";ZEN_CHARS+="０１２３４５６７８９：；＜＝＞？";ZEN_CHARS+="＠ＡＢＣＤＥＦＧＨＩＪＫＬＭＮＯ";ZEN_CHARS+="ＰＱＲＳＴＵＶＷＸＹＺ［＼］＾＿";ZEN_CHARS+="｀ａｂｃｄｅｆｇｈｉｊｋｌｍｎｏ";ZEN_CHARS+="ｐｑｒｓｔｕｖｗｘｙｚ｛｜｝～（";ZEN_CHARS+="）。「」、・ヲァィゥェォャュョッ";ZEN_CHARS+="ーアイウエオカキクケコサシスセソ";ZEN_CHARS+="タチツテトナニヌネノハヒフヘホマ";ZEN_CHARS+="ミムメモヤユヨラリルレロワン゛°";var HAN_ARRAY=HAN_CHARS.split("");var ZEN_ARRAY=ZEN_CHARS.split("");var DIFF_HIRA_TO_KATA=96;var HIRAGANA_REGSTR="[ぁ-ゔ]";var KATAKANA_REGSTR="[ァ-ヴ]";var __assertIsCharacter=function(character){if(!_.isString(character)||character.length!==1){throw"Invalid arguments. Pass character."}};ns.provide({kata2hira:function(string){var regexp=new RegExp(KATAKANA_REGSTR,"g");return string.replace(regexp,function(kata){return String.fromCharCode(kata.charCodeAt(0)-DIFF_HIRA_TO_KATA)})},hira2kata:function(string){var regexp=new RegExp(HIRAGANA_REGSTR,"g");return string.replace(regexp,function(hira){return String.fromCharCode(hira.charCodeAt(0)+DIFF_HIRA_TO_KATA)})},han2zen:function(string){var hanReg=new RegExp("["+HAN_CHARS+"]","g");return string.replace(hanReg,function(han){var index=_.indexOf(HAN_ARRAY,han);return ZEN_ARRAY[index]})},zen2han:function(string){var zenReg=new RegExp("["+ZEN_CHARS+"]","g");return string.replace(zenReg,function(zen){var index=_.indexOf(ZEN_ARRAY,zen);return HAN_ARRAY[index]})},isHiragana:function(character){__assertIsCharacter(character);var regexp=new RegExp(HIRAGANA_REGSTR);return regexp.test(character)},isKatakana:function(character){__assertIsCharacter(character);var regexp=new RegExp(KATAKANA_REGSTR);return regexp.test(character)},isKanji:function(character){__assertIsCharacter(character);var charcode=character.charCodeAt(0);return/[\u4E00-\u9FCF]/.test(character)}})});Namespace("jp.co.mixi.lang.util").define(function(ns){var isElement=function(object){return!!(object&&object.nodeType==1)};var isArray=function(object){return Array.isArray(object)};var isHash=function(object){return object instanceof Hash};var isFunction=function(object){return typeof object==="function"};var isString=function(object){return Object.prototype.toString.call(object)==="[object String]"};var isNumber=function(object){return Object.prototype.toString.call(object)==="[object Number]"};var isUndefined=function(object){return typeof object==="undefined"};var merge=function(aObj,bObj){for(var p in bObj){if(bObj.hasOwnProperty(p)){aObj[p]=bObj[p]}}return aObj};var callMethod=function(methodName,obj){if(!obj)return;var args=Array.prototype.slice.call(arguments,2);return obj[methodName].apply(obj,args)};ns.provide({isElement:isElement,isArray:isArray,isHash:isHash,isFunction:isFunction,isString:isString,isNumber:isNumber,isUndefined:isUndefined,merge:merge,callMethod:callMethod})});Namespace("jp.co.mixi.logging").use("jp.co.mixi.logging.polyfilltrace polyfillStackTrace").define(function(ns){"use strict";var OVERRIDE_STACK_TRACE_LIMIT=20;var LogLevel={LOG:0,INFO:1,WARN:2,ERROR:3,DISABLE:10};var TRACE_LEVEL=LogLevel.WARN;var USERAGENT_OUTPUTS_TRACE_ON_CONSOLE_ERROR=/safari chrome/;var currentLevel=LogLevel.DISABLE;var throwIfNoConsole=false;var isTraceEnabled=false;var isErrorStackAvailable;var shouldThrowForStack;var isConsoleAvailable=!!window.console;var isPolyfillTraceAvailable=!!ns.polyfillStackTrace;var isConsoleGroupAvailable=isConsoleAvailable&&!!window.console.group;var isUserAgentTracesOnError=USERAGENT_OUTPUTS_TRACE_ON_CONSOLE_ERROR.test(window.navigator.userAgent.toLowerCase());var __isInited=false;var __initAvailability=function(){if(__isInited)return;__isInited=true;if(isErrorStackAvailable!==undefined)return;var thrown;try{throw new Error}catch(e){thrown=e}isErrorStackAvailable=!!thrown.stack;var notThrown=new Error;shouldThrowForStack=isErrorStackAvailable&&!notThrown.stack;if(Error.hasOwnProperty("stackTraceLimit")&&Error.stackTraceLimit<OVERRIDE_STACK_TRACE_LIMIT){Error.stackTraceLimit=OVERRIDE_STACK_TRACE_LIMIT}};var setLogLevel=function(level,options){__initAvailability();options=options||{};if(typeof level!=="number")throw new Error("level should be number.");if(options.ThrowIfNoConsole!==undefined&&typeof options.ThrowIfNoConsole!=="boolean"){throw new Error("throwIfNoConsole should be boolean.")}if(options.DisableTrace!==undefined&&typeof options.DisableTrace!=="boolean"){throw new Error("disableTrace should be boolean.")}currentLevel=level;throwIfNoConsole=!!options.ThrowIfNoConsole;isTraceEnabled=!options.DisableTrace;if(!isConsoleAvailable)return;Log.log(ns.CURRENT_NAMESPACE+" setLogLevel("+level+"), stackTraceMode: "+(shouldThrowForStack?"throw new Error(); => catch (e) { e.stack; }":isErrorStackAvailable?"(new Error()).stack":isPolyfillTraceAvailable?"polyfillStackTrace()":"none (Include polyfilltrace module for stack trace on where error.stack unavailable.)"))};var createLogFunc=function(level){return function(message,options){options=options||{};if(level<currentLevel)return;if(!isConsoleAvailable&&throwIfNoConsole)throw message;if(!isConsoleAvailable)return;if(message instanceof Error){writeLogToConsole(_getStackTrace(message,1),level);return}var doTrace=!!options.full||isTraceEnabled&&level>=TRACE_LEVEL&&!options.noTrace;if(!doTrace){writeLogToConsole(message,level);return}var errorForTrace=new Error;errorForTrace.name="StackTrace";errorForTrace.message="";if(shouldThrowForStack){try{throw errorForTrace}catch(e){errorForTrace=e}}writeLogToConsole(message,level,_getStackTrace(errorForTrace,1))}};var writeLogToConsole=function(message,level,traceText){try{if(traceText&&isConsoleGroupAvailable)window.console.group();switch(level){case LogLevel.LOG:message="[LOG] "+message;window.console.log(message);break;case LogLevel.INFO:window.console.info(message);break;case LogLevel.WARN:window.console.warn(message);break;case LogLevel.ERROR:window.console.error(message);break;default:message="[UNKNOWN] "+message;window.console.log(message);break}if(!traceText)return;if(level===LogLevel.ERROR&&isUserAgentTracesOnError)return;if(window.console.groupCollapsed){window.console.groupCollapsed();window.console.log(traceText);window.console.groupEnd()}else{window.console.log(traceText)}if(isConsoleGroupAvailable)window.console.groupEnd()}catch(e){}};var _getStackTrace=function(error,currentDepth){if(isErrorStackAvailable)return error.stack;var errorSummary=(error.name||"<UnknownError>")+": "+(error.message||"");if(!isPolyfillTraceAvailable)return errorSummary;var stack=ns.polyfillStackTrace({skipDepth:currentDepth+1});return errorSummary+"\n"+stack};var Log={log:createLogFunc(LogLevel.LOG),info:createLogFunc(LogLevel.INFO),warn:createLogFunc(LogLevel.WARN),error:createLogFunc(LogLevel.ERROR)};ns.provide({Log:Log,LogLevel:LogLevel,setLogLevel:setLogLevel})});Namespace("jp.co.mixi.logging.errorchannel").use("brook promise").use("brook.channel observeChannel,stopObservingChannel").use("jp.co.mixi.logging Log").define(function(ns){"use strict";var observer=ns.promise(function(n,v){ns.Log.error(v);n(v)});ns.provide({observeErrorChannel:function(){ns.observeChannel("error",observer)},stopObservingErrorChannel:function(){ns.stopObservingChannel("error",observer)}})});Namespace("jp.co.mixi.logging.polyfilltrace").define(function(ns){var MAX_FUNC_DETAIL_LINES=5;var MAX_FUNC_DETAIL_LENGTH=72;var MAX_MINIFIED_FUNC_DETAIL_LENGTH=200;var MAX_STACK_DEPTH=10;var INDENT_TEXT="    ";var ELLIPSIS_TEXT=" ...";var LONG_FUNC_TEXT="... (surpressed %d lines) ...";var _indentify=function(text,level){if(level===undefined)level=1;var indent="";_.times(level,function(){indent+=INDENT_TEXT});return _.map(text.split("\n"),function(line){return indent+line}).join("\n")};var _roundLine=function(text,maxLength){if(text.length>maxLength){text=text.slice(0,maxLength-ELLIPSIS_TEXT.length);text+=ELLIPSIS_TEXT}return text};var _getFuncSummary=function(funcString){var funcLines=funcString.split("\n",MAX_FUNC_DETAIL_LINES+1);var overflowText=funcLines.splice(MAX_FUNC_DETAIL_LINES,1)[0];var overflowCount=overflowText?overflowText.split("\n").length:0;if(overflowCount)funcLines.pop();if(!funcLines.length)return"<cannot retrieve function body>";if(funcLines.length===1){return _roundLine(funcString,MAX_MINIFIED_FUNC_DETAIL_LENGTH)}var summaryPerLine=_.map(funcLines,function(line){return _roundLine(line,MAX_FUNC_DETAIL_LENGTH)});if(overflowCount)summaryPerLine.push(LONG_FUNC_TEXT.replace("%d",overflowCount));return summaryPerLine.join("\n")};var _getFuncTrace=function(funcString){var matched=(""+funcString).match(/^\s*function (\w*)/);var funcName=matched&&matched[1]?matched[1]:"<anonymous>";return funcName+" :\n"+_indentify(_getFuncSummary(funcString))};var polyfillStackTrace=function(options){try{options=options||{};var skipDepth=options.skipDepth||0;var skippedDepth=0;var depth=0;var trace="";for(var f=arguments.callee.caller;f!==null;f=f.caller){if(skippedDepth<skipDepth){skippedDepth++;continue}depth++;if(depth>MAX_STACK_DEPTH)break;trace+=_getFuncTrace(f.toString())+"\n"}return"Polyfill StackTrace:\n"+_indentify(trace)}catch(e){return"Error occured during generating polyfill stacktrace."}};ns.provide({polyfillStackTrace:polyfillStackTrace})});Namespace("jp.co.mixi.nativeproxy").use("brook promise").use("brook.channel observeChannel").use("brook.util mapper").use("jp.co.mixi.gateway gateway").define(function(ns){var _nativeProxy=function(){return window.WebBridge};var _existWebBridge=function(){return window.WebBridge?true:false};var isEnableNativeProxy=function(){if(!_existWebBridge())return;return _nativeProxy().isEnableBridge()};var onStartNativeProxy=function(method){if(!_existWebBridge())return;if(!method)return;var callback=method&&method.run?function(){method.run()}:method;_nativeProxy().onStart(callback)};var callNativeProxy=function(dest,request,callback){if(!_existWebBridge())return;_nativeProxy().call(dest,request,callback)};var notifyNativeProxy=function(dest,request){if(!_existWebBridge())return;_nativeProxy().notify(dest,request)};var createNativeProxyPromise=function(dest){return ns.promise(function(next,request){callNativeProxy(dest,request,function(response){next({request:request,response:response})})})};var createNativeProxyGateway=function(ruleData){var promise=ruleData.onDisableProxy;onStartNativeProxy(function(){promise=ruleData.onEnableProxy});return ns.promise(function(next,value){promise.bind(next).run(value)})};var observeNativeProxy=function(dest,observer){if(!_existWebBridge())return;_nativeProxy().observe(dest,observer)};ns.provide({isEnableNativeProxy:isEnableNativeProxy,onStartNativeProxy:onStartNativeProxy,callNativeProxy:callNativeProxy,notifyNativeProxy:notifyNativeProxy,createNativeProxyPromise:createNativeProxyPromise,createNativeProxyGateway:createNativeProxyGateway,observeNativeProxy:observeNativeProxy})});Namespace("jp.co.mixi.nativeproxy.widget.messagenotify").use("jp.co.mixi.nativeproxy observeNativeProxy").define(function(ns){"use strict";ns.provide({registerElement:function(element,dataset){var $element=$j(element);ns.observeNativeProxy("jp.co.mixi.nativeproxy.widget.messagenotify",function(param){if(param.params&&parseInt(param.params.count,10)){$element.text(param.params.count);$element.show()}else{$element.hide()}})}})});Namespace("jp.co.mixi.nativeproxy.widget.nativebinder").use("jp.co.mixi.nativeproxy callNativeProxy").use("jp.co.mixi.gateway gateway").use("jp.mixi.service.analysis postUIEventLog").define(function(ns){"use strict";ns.provide({registerElement:function(element,dataset){if(!dataset.nativeDest){throw"require native dest."}var param=JSON.parse(dataset.nativeParam);if(!param){throw"require native param."}var $element=$j(element);dataset.bindEvent=dataset.bindEvent||"click";if(!ns.gateway("IS_WEB_BRIDGE_ENABLED_CLIENT")){$element.on(dataset.bindEvent,function(e){if(dataset.uiEventName){e.preventDefault();var callback=function(){location.href=param.url};ns.postUIEventLog(dataset.uiEventName,null,callback)}else{location.href=param.url}});return}$element.on(dataset.bindEvent,function(){ns.callNativeProxy(dataset.nativeDest,param,function(){})})}})});Namespace("jp.co.mixi.net").use("brook promise").use("jp.co.mixi.net.utils *").use("jp.co.mixi.net.storage *").use("jp.co.mixi.net.httprequester *").define(function(ns){ns.provide(ns)});Namespace("jp.co.mixi.net.cachedrpc").use("brook promise").use("brook.model createModel").use("jp.co.mixi.gateway gateway").use("jp.co.mixi.net.jsonrpc JSONRPC").use("jp.co.mixi.net.storage Storage").use("jp.co.mixi.logging Log").define(function(ns){"use strict";var STORAGE_NAMESPACE="cachedrpc";var STORAGE_EXPIRATION=1e3*60*60*24*30;var DEFAULT_CACHE_EXPIRATION=1e3*60*60*24;var RETRY_SEED=1e3*60;var MAX_RETRY_DURATION=RETRY_SEED*5;var THROTTLE_DURATION=1e3*15;var memberId=ns.gateway("login_member_id");var rpc=ns.JSONRPC.createService("/system/rpc.json",{auth_type:"postkey",secret:ns.gateway("rpc_post_key"),internal_encoding:"utf8"});var stringifyParams=function(params){return _.map(params,function(value,key){return key+":"+value}).sort().join(",")};var _throttleWithoutQueue=function(func,wait){var throttled=false;return function(){if(throttled)return;throttled=true;func();setTimeout(function(){throttled=false},wait)}};var createCachedRPCModel=function(method,params,options){params=params||{};options=options||{};var unknownOptions=_.without(_.keys(options),"expireMin");if(unknownOptions.length){ns.Log.warn("cachedrpc: Unknown option(s): "+unknownOptions.toString())}var cacheExpiration=options.expireMin?options.expireMin*1e3*60:DEFAULT_CACHE_EXPIRATION;var storageKey=memberId+"_"+method+(!_.isEmpty(params)?"_"+stringifyParams(params):"");var responseCache;var initialized=false;var get=ns.promise(function(n,v){if(!initialized){initialized=true;responseCache=ns.Storage.load(STORAGE_NAMESPACE,storageKey);model.notify("renew").run()}if(responseCache)n(responseCache.result)});var requestToServer=function(callback){try{rpc.call(method,params,function(response){if(response.isFailure()){ns.Log.error("requestToServer["+method+"]: got JSONRPC error response.");return}callback(response.result)})}catch(e){ns.Log.log("requestToServer["+method+"]: JSONRPC request failed, maybe offline?")}};var renewCache=function(callback){var now=(new Date).getTime();requestToServer(function(result){responseCache={result:result,timestamp:now};_.defer(function(){ns.Storage.save(STORAGE_NAMESPACE,storageKey,responseCache,new Date(now+STORAGE_EXPIRATION))});callback(result)})};var renewTimerId;var resetRenewTimer=function(time){ns.Log.log("resetRenewTimer: "+method+" / "+time);if(renewTimerId)clearTimeout(renewTimerId);renewTimerId=setTimeout(function(){renewTimerId=undefined;model.notify("renew").run()},time)};var lastRenewCallback;var retryCount=0;var _enqueueRenew=_.debounce(_throttleWithoutQueue(function(){ns.Log.log("enqueueRenew: renewing.");renewCache(function(result){retryCount=0;resetRenewTimer(cacheExpiration);if(!lastRenewCallback)return;lastRenewCallback(result);lastRenewCallback=undefined});var retryDuration=_.min([RETRY_SEED*(retryCount+1),MAX_RETRY_DURATION]);resetRenewTimer(retryDuration);retryCount++},THROTTLE_DURATION),0);var renew=ns.promise(function(n,v){ns.Log.log("renew: "+method);lastRenewCallback=n;_enqueueRenew()});var model=ns.createModel({get:get,renew:renew});return model};var models={};var getCachedRPCModel=function(method,params,options){var key=method+"_"+stringifyParams(params);if(models[key]&&options){ns.Log.info("cachedrpc: NOTE: options will not be overridden "+"when getCachedRPCModel called twice with same method/params.")}if(!models[key]){models[key]=createCachedRPCModel(method,params,options)}return models[key]};ns.provide({getCachedRPCModel:getCachedRPCModel,_createCachedRPCModel:createCachedRPCModel})});Namespace("jp.co.mixi.net.httprequester").use("jp.co.mixi.net.utils *").use("brook promise").define(function(ns){var RequestState={};if(window.XMLHttpRequest){RequestState.UNSENT=XMLHttpRequest.UNSENT||0;RequestState.OPENED=XMLHttpRequest.OPENED||1;RequestState.HEADERS_RECEIVED=XMLHttpRequest.HEADERS_RECEIVED||2;RequestState.LOADING=XMLHttpRequest.LOADING||3;RequestState.DONE=XMLHttpRequest.DONE||4}else{RequestState.UNSENT=0;RequestState.OPENED=1;RequestState.HEADERS_RECEIVED=2;RequestState.LOADING=3;RequestState.DONE=4}function HTTPRequester(){this.__xhr=null;this.__lastRequestUrl=null;this.__options={};this.__response=null}HTTPRequester.POST="POST";HTTPRequester.GET="GET";HTTPRequester.identifier=0;HTTPRequester.requesters={};HTTPRequester.AJAX_DEFAULT_REQUEST_HEADERS={"X-Requested-With":"XmlHttpRequest"};HTTPRequester.getIdentifier=function(){var current=HTTPRequester.identifier++;return(new Date).getTime().toString()+current.toString()};HTTPRequester.getRequester=function(key){var requester;if(HTTPRequester.requesters[key]===undefined){requester=new HTTPRequester;HTTPRequester.requesters[key]=requester}else{throw new Error("this key exist.")}return requester};HTTPRequester.abortAll=function(){ns.augmentArray(ns.keys(HTTPRequester.requesters)).xforEach(function(key){HTTPRequester.requesters[key].abort()},this)};HTTPRequester.prototype.abort=function(){this.__xhr.onreadystatechange=null;this.__xhr.abort()};HTTPRequester.getRequestObject=function(){try{return new XMLHttpRequest}catch(e0){try{return new ActiveXObject("Msxml2.XMLHTTP")}catch(e1){try{return new ActiveXObject("Microsoft.XMLHTTP")}catch(e2){throw new Error("faild to create requester")}}}};HTTPRequester.prototype.createRequestPromise=function(){var that=this;return ns.promise(function(n,v){that.request(v,n)})};HTTPRequester.prototype.request=function(options,callback){this.__xhr=HTTPRequester.getRequestObject();this.__setOptions(options);this.__setHandler(callback);this.__open();this.__setHeaders();this.__send();return this};HTTPRequester.prototype.getResponse=function(){return this.__response};HTTPRequester.prototype.__setOptions=function(options){if(!options){throw new Error("illegal options.")}this.__options.method=options.method?options.method:HTTPRequester.POST;if(!options.url){throw new Error('HTTPRequester.request() needs "url" option.')}this.__options.url=options.url;this.__options.asynchronous=typeof options.asynchronous=="boolean"?options.asynchronous:true;this.__options.requestContentType=options.requestContentType?options.requestContentType:"application/x-www-form-urlencoded; charset=UTF-8";this.__options.noCache=typeof options.noCache=="boolean"?options.noCache:true;this.__options.paramGET=options.paramGET?options.paramGET:null;this.__options.paramPOST=options.paramPOST?options.paramPOST:null;var otherRequestHeaders=HTTPRequester.AJAX_DEFAULT_REQUEST_HEADERS;this.__options.otherRequestHeaders=options.otherRequestHeaders?ns.merge(otherRequestHeaders,options.otherRequestHeaders):otherRequestHeaders};HTTPRequester.prototype.__setHandler=function(callback){var that=this;try{this.__xhr.onabort=function(evt){}}catch(error){}this.__xhr.onreadystatechange=function(evt){if(that.__xhr.readyState===RequestState.DONE){that.__response=new HTTPResponse(that.__xhr);that.__xhr.onreadystatechange=function(){};callback(that.__response)}}};HTTPRequester.prototype.__open=function(){var requestUrl=this.__options.url+(this.__options.url.indexOf("?")==-1?"?":"&")+(this.__options.paramGET?ns.serialize(this.__options.paramGET):"")+(this.__options.noCache?"&"+HTTPRequester.getIdentifier():"");this.__lastRequestUrl=requestUrl;this.__xhr.open(this.__options.method,requestUrl,this.__options.asynchronous)};HTTPRequester.prototype.__setHeaders=function(){if(this.__options.noCache){this.__xhr.setRequestHeader("Cache-Control","no-cache")}if(this.__options.method==HTTPRequester.POST){this.__xhr.setRequestHeader("Content-Type",this.__options.requestContentType)}if(this.__options.otherRequestHeaders){ns.augmentArray(ns.keys(this.__options.otherRequestHeaders)).xforEach(function(key){this.__xhr.setRequestHeader(key,this.__options.otherRequestHeaders[key])},this)}};HTTPRequester.prototype.__send=function(){var postBody=null;if(this.__options.paramPOST!==null&&this.__options.method===HTTPRequester.POST){postBody=ns.isString(this.__options.paramPOST)?this.__options.paramPOST:ns.serialize(this.__options.paramPOST)}this.__xhr.send(postBody)};function HTTPResponse(xhr){this.__status20x=xhr.status>=200&&xhr.status<300;this.statusCode=xhr.status;this.__rawString=xhr.responseText;this.__object=null;if(/javascript/.test(xhr.getResponseHeader("Content-Type"))||/json/.test(xhr.getResponseHeader("Content-Type"))){try{this.__object=JSON.parse(this.__rawString.replace(/^\/\*-secure-([\s\S]*)\*\/\s*$/,"$1"))}catch(err){}}}HTTPResponse.prototype.is20x=function(){return this.__status20x};HTTPResponse.prototype.getObject=function(){return this.__object};HTTPResponse.prototype.getRawString=function(){return this.__rawString};ns.provide({HTTPRequester:HTTPRequester,HTTPResponse:HTTPResponse})});Namespace("jp.co.mixi.net.jsonrpc").use("brook *").use("jp.co.mixi.net.jsonrpc.engine JSONRPCEngine,NativeProxyEngine").define(function(ns){var factory=function(endPoint,params,isEnableNativeProxyEngine){if(isEnableNativeProxyEngine)return ns.NativeProxyEngine.createService(endPoint,params);if(ns.JSONRPCEngine)return ns.JSONRPCEngine.createService(endPoint,params);if(JSON.RPC)return JSON.RPC.Client.createService(endPoint,params);throw new Error("required any jsonrpc libraries")};var JSONRPC=function(endPoint,params,isEnableNativeProxyEngine){var engine=factory(endPoint,params,isEnableNativeProxyEngine);var that=this;this.endPoint=engine.endPoint;this.requests=engine.requests;this.addedId=engine.addedId;this._onSuccess=function(){engine._onSuccess()};this._onFailure=function(){engine._onFailure()};this._onNotification=function(){engine._onNotification()};this.call=function(method,param,callback,errorCallback){engine.call(method,param,callback,errorCallback)};this.notify=function(method,param){engine.notify(method,param);return that};this.add=function(method,param,id){engine.add(method,param,id);return that};this.execute=function(callback){engine.execute(callback)};this.createRPCPromise=function(method){return ns.promise(function(n,request){engine.call(method,request,function(response){n({request:request,response:response})})})}};JSONRPC.createService=function(endPoint,params,isEnableNativeProxyEngine){return new JSONRPC(endPoint,params,isEnableNativeProxyEngine)};ns.provide({JSONRPC:JSONRPC})});Namespace("jp.co.mixi.net.jsonrpc.engine").use("jp.co.mixi.net.utils curry,augmentArray,isArray,serialize").use("jp.co.mixi.net.httprequester HTTPRequester").use("jp.co.mixi.nativeproxy callNativeProxy,notifyNativeProxy").define(function(ns){var VERSION="2.0";var REQUEST_CONTENT_TYPE="application/json-rpc; charset=UTF-8";var ERROR_CODE={PARSE_ERROR:-32700,METHOD_NOT_FOUND:-32600,INVALID_REQUEST:-32601,INVALID_PARAMS:-32602,INTERNAL_ERROR:-32603};var K=function(x){return x};var emptyFunction=function(){};var isErrorCode=function(code){return this.isFailure()&&this.error.code==code};var Response=function(value){this.id=value.id;this.result=value.result;this.error=value.error;this.jsonrpc=value.jsonrpc;return this};(function(){this.isSuccess=function(){return this.result&&!this.error};this.isFailure=function(){return!this.isSuccess()};this.isMethodNotFound=ns.curry(isErrorCode,ERROR_CODE.METHOD_NOT_FOUND);this.isParseError=ns.curry(isErrorCode,ERROR_CODE.PARSE_ERROR);this.isInvalidRequest=ns.curry(isErrorCode,ERROR_CODE.INVALID_REQUEST);this.isInvalidParams=ns.curry(isErrorCode,ERROR_CODE.INVALID_PARAMS);this.isInternalError=ns.curry(isErrorCode,ERROR_CODE.INTERNAL_ERROR);this.isNotification=function(){return!this.id};this.getErrorCode=function(){if(this.isSuccess()){throw new Error("not error")}return this.error.code};this.isSingleResponse=ns.curry(K,true);this.isBatchResponse=ns.curry(K,false)}).apply(Response.prototype);var ResponseAggregator=function(arrayOfResponse){this.responseList=arrayOfResponse;this.mapById=ns.augmentArray(arrayOfResponse).xfilter(function(e){return e.id?true:false});this.mapById=ns.augmentArray(this.mapById).xreduce(function(ret,e){ret[e.id]=e;return ret},{});return this};(function(){this.isSuccess=function(){return ns.augmentArray(this.responseList).xevery(function(e){return e.isSuccess()})};this.get=function(id){return this.mapById[id]};this.isSingleResponse=ns.curry(K,false);this.isBatchResponse=ns.curry(K,true)}).apply(ResponseAggregator.prototype);var _composeResponse=function(obj){if(ns.isArray(obj)){return new ResponseAggregator(ns.augmentArray(obj).xmap(_composeResponse))}else{return new Response(obj)}};var Client=function(serviceEndPoint){this.endPoint=serviceEndPoint;this.requests=[];this.addedId={}};(function(){this._onSuccess=function(callback,responseObject){callback(_composeResponse(responseObject))};this._onFailure=function(errorCallback,responseObject,methods){errorCallback(_composeResponse(responseObject));throw new Error("request failure: "+methods.join(","))};this._onNotification=emptyFunction;this.add=function(methodName,params,id){var requestId=id||this.requests.length;if(this.addedId[requestId]){throw new Error("same request id used")}this.addedId[requestId]=true;this.requests.push({jsonrpc:VERSION,method:methodName,params:params,id:requestId});return this};this.notify=function(methodName,params){this.requests.push({jsonrpc:VERSION,method:methodName,params:params,id:null});return this};this.execute=function(callback,errorCallback){var that=this;var requests=this.requests;var requestJSON=JSON.stringify(requests.length>1?requests:requests[0]);var _self=this;this.requests=[];this.addedId={};(new ns.HTTPRequester).request({method:ns.HTTPRequester.POST,url:this.endPoint,asynchronous:true,paramPOST:requestJSON,otherRequestHeaders:null,requestContentType:REQUEST_CONTENT_TYPE},function(response){var responseJSON=JSON.parse(response.getRawString()||"{}");if(response.is20x()){that._onSuccess(callback,responseJSON)}else{var methods=[];for(var i=0,len=requests.length;i<len;i++){methods[i]=requests[i].method}that._onFailure(errorCallback||function(){},responseJSON,methods)}})};this.call=function(methodName,params,callback,errorCallback){return this.add(methodName,params,false).execute(callback,errorCallback)}}).apply(Client.prototype);Client.createService=function(serviceEndPoint,params){return new Client(serviceEndPoint+(params?"?"+ns.serialize(params):""))};var NativeProxy=function(serviceEndPoint){this.endPoint=serviceEndPoint;this.requests=[];this.addedId={}};(function(){this._onSuccess=function(callback,responseObject){callback(_composeResponse(responseObject))};this._onFailure=function(callback,responseObject,methods){callback(_composeResponse(responseObject));throw new Error("NativeProxy request failure: "+methods.join(","))};this._onNotification=emptyFunction;this.add=function(methodName,params,id){var requestId=id||this.requests.length;if(this.addedId[requestId]){throw new Error("same request id used")}this.addedId[requestId]=true;this.requests.push({jsonrpc:VERSION,method:methodName,params:params,id:requestId});return this};this.notify=function(methodName,params){this.requests.push({jsonrpc:VERSION,method:methodName,params:params,id:null});return this};this.execute=function(callback){var that=this;var params=this._convertNativeProxyParams(this.requests[0]);var method=this.requests[0].method;this.requests=[];this.addedId={};if(callback){ns.callNativeProxy(method,params,function(response){var code=response.result&&response.result.code?parseInt(response.result.code,10):null;if(code&&code>=200&&code<300){that._onSuccess(callback,response)}else{that._onFailure(callback,response,[method])}})}else{ns.notifyNativeProxy(method,params)}};this.call=function(methodName,params,callback){return this.add(methodName,params,false).execute(callback)};this._convertNativeProxyParams=function(request){var NativeProxyParams={},files={},params={};var originalParams=request.params;var matchedURL=this.endPoint.match(/^.*:\/\/.*/);var url=matchedURL&&matchedURL.length?this.endpoint:location.protocol+"//"+location.hostname+(location.port?":"+location.port:"")+this.endPoint;NativeProxyParams.request={method:ns.HTTPRequester.POST,url:url,raw_body:JSON.stringify(request),headers:{"Content-Type":REQUEST_CONTENT_TYPE}};return NativeProxyParams}}).apply(NativeProxy.prototype);NativeProxy.createService=function(serviceEndPoint,params){return new NativeProxy(serviceEndPoint+(params?"?"+ns.serialize(params):""))};ns.provide({JSONRPCEngine:Client,NativeProxyEngine:NativeProxy})});Namespace("jp.co.mixi.net.jsonrpc.jsonp").use("brook promise").use("jp.co.mixi.lang.class defineClass").use("jp.co.mixi.net.jsonrpc JSONRPC").define(function(ns){var JSONP=ns.defineClass({initialize:function(endPoint,params){this.endPoint=endPoint;this.params=params;if(!window._JSONPCALLBACKS_){window._JSONPCALLBACKS_=function(response){JSONP.CALLBACKPOOL[response.id](response.result)}}},call:function(method,requestParams,callback){var jsonrpc=ns.JSONRPC.createService(this.endPoint,this.params);var requests=jsonrpc.add(method,requestParams).requests;var requestJSON=JSON.stringify(requests.length>1?requests:requests[0]);var head=document.head||document.getElementsByTagName("head")[0];var script=document.createElement("script");JSONP.jsonpRequestId++;JSONP.CALLBACKPOOL[JSONP.jsonpRequestId]=callback;script.id="jsonpRequest"+JSONP.jsonpRequestId;script.src=jsonrpc.endPoint+"&id="+JSONP.jsonpRequestId+"&callback=_JSONPCALLBACKS_"+"&json="+requestJSON;if(isIE()){script.onreadystatechange=function(){if(script.readyState=="loaded"){script.onreadystatechange=null;removeScriptTag(head,script);script=undefined}}}else{script.onload=function(){removeScriptTag(head,script);script=undefined}}head.insertBefore(script,head.firstChild)},createJSONPPromise:function(method){var _self=this;return ns.promise(function(n,request){_self.call(method,request,function(response){n({request:request,response:response})})})}});JSONP.CALLBACKPOOL={};JSONP.jsonpRequestId=0;JSONP.createService=function(endPoint,params){return new JSONP(endPoint,params)};var isIE=function(){return document.all?1:0};var removeScriptTag=function(head,script){if(head&&script.parentNode){head.removeChild(script)}};ns.provide({JSONP:JSONP})});Namespace("jp.co.mixi.net.jsonrpc.nativeproxy.uploader").use("brook promise").use("jp.co.mixi.net.utils serialize").use("jp.co.mixi.lang.class defineClass").use("jp.co.mixi.nativeproxy callNativeProxy").use("jp.co.mixi.net.httprequester HTTPRequester").define(function(ns){var VERSION="2.0";var Service=ns.defineClass({initialize:function(endPoint,params){var _self=this;_self.endPoint=endPoint;_self._authType=params.auth_type;_self._secret=params.secret},createRPCPromise:function(methodName){var _self=this;return ns.promise(function(next,request){var matchedURL=_self.endPoint.match(/^.*:\/\/.*/);var url=matchedURL&&matchedURL.length?_self.endpoint:location.protocol+"//"+location.hostname+(location.port?":"+location.port:"")+_self.endPoint;var params={request:{method:ns.HTTPRequester.POST,url:url,headers:{"Content-Type":"multipart/form-data"},body:{request:JSON.stringify({jsonrpc:VERSION,method:methodName,params:request.params,id:0})}}};$j.each(request.params,function(key,value){if(key=="toQueryString"||key=="keys")return;params[key]=value});var fileInputs=request.fileInputs;if(fileInputs&&fileInputs.length){$j.each(fileInputs,function(key,input){var file={type:"File",value:input.getAttribute("value")};var name=input.name;params[name]=file;params.request.body[name]=file})}ns.callNativeProxy(methodName,params,function(response){next({response:response,request:request})})})}});Service.createService=function(endPoint,params){return new Service(endPoint+(params?"?"+ns.serialize(params):""),params)};ns.provide({JSONRPCUploader:Service})});Namespace("jp.co.mixi.net.jsonrpc.uploader").use("brook promise").use("brook.dom.compat dataset").use("jp.co.mixi.lang.class defineClass").use("jp.co.mixi.lang.string unescapeHTML").use("jp.co.mixi.ui.template getTemplateBySource").define(function(ns){var VERSION="2.0";var IFRAME_ID="JS_JSONRPC_IFrame_Gateway";var IFRAME_TMPL='<iframe id="<TMPL_VAR EXPR=form(id)>" name="<TMPL_VAR EXPR=form(id)>" loading="eager" style="position: absolute; left: -9999px; width: 1px; height: 1px; border: none;"></iframe>';var Service=ns.defineClass({initialize:function(endPoint,params){var _self=this;_self.endPoint=endPoint;_self._authType=params.auth_type;_self._secret=params.secret;_self._createForm()},isSameParams:function(params){return this._authType===params.auth_type&&this._secret===params.secret},createRPCPromise:function(methodName){var _self=this;return ns.promise(function(next,request){$j(_self._form).empty();var originalCharset;originalCharset=document.charset||document.characterSet;try{document.charset="UTF-8"}catch(e){}_self._setFormParams({auth_type:_self._authType,secret:_self._secret,request:JSON.stringify({jsonrpc:VERSION,method:methodName,params:request.params,id:0})});var stayInputData=_self._getStayInputData(request.fileInputs);_self._setFiles(request.fileInputs);_self._observeOnLoad(function(response){next({response:response,request:request})});_self._form.submit();_.each(stayInputData,function(inputData){inputData.$dummy.replaceWith(inputData.$original)});try{document.charset=originalCharset||"euc-jp"}catch(e){}})},_createForm:function(){var _self=this;_self._iframe=$j("#"+IFRAME_ID).get(0);if(!_self._iframe){var template=ns.getTemplateBySource(IFRAME_TMPL);template.param({id:IFRAME_ID});_self._iframe=$j(template.output()).get(0);document.body.appendChild(_self._iframe)}_self._form=document.createElement("form");_self._form.method="post";_self._form.target=_self._iframe.name;_self._form.action=_self.endPoint;$j(_self._form).css({position:"absolute",left:"-1000px",width:"1px",height:"1px"});_self._form.enctype="multipart/form-data";_self._form.encoding="multipart/form-data";_self._form.acceptCharset="UTF-8";document.body.appendChild(_self._form)},_setFormParams:function(params){var _self=this;_(params).chain().keys().each(function(key){var input=document.createElement("input");input.name=key;input.value=params[key];_self._form.appendChild(input)})},_getStayInputData:function(inputsHash){var stayInputData=[];_.each(inputsHash,function(input){var stayInputTag=!!parseInt(ns.dataset(input).stayInputTag,10);var $input=$j(input);if(stayInputTag){var $dummy=$input.clone();$input.after($dummy);stayInputData.push({$original:$input,$dummy:$dummy})}});return stayInputData},_setFiles:function(inputs){var _self=this;var __isValidKey=function(key){return/^upload\d$/.test(key)};_(inputs).chain().keys().each(function(key){if(!__isValidKey(key)){throw new Error("invalid upload params")}var $input=$j(inputs[key]);$input.attr("name",key);_self._form.appendChild($input[0])})},_observeOnLoad:function(callback){var _self=this;var onLoadIframe=function(event){var iFrameBody=event.target.contentWindow.document.body;var response;try{if(iFrameBody.innerText){response=JSON.parse(ns.unescapeHTML(iFrameBody.innerText))}else{response=JSON.parse(ns.unescapeHTML(iFrameBody.textContent))}}catch(e){response={id:"0",jsonrpc:VERSION,error:{code:-32700,message:"Failed to parse response."}}}$j(_self._iframe).unbind("load",onLoadIframe);_self._form.reset();event.target.contentWindow.location.replace("about:blank");callback(response)};$j(_self._iframe).bind("load",onLoadIframe)}});var cache={};Service.createService=function(endPoint,params){var service=cache[endPoint];if(service&&service.isSameParams(params)){return service}service=cache[endPoint]=new Service(endPoint,params);return service};ns.provide({JSONRPCUploader:Service})});Namespace("jp.co.mixi.net.storage").define(function(ns){var KEY_PREFIX="jp.co.mixi.net.storage";try{var localStorage=window.localStorage}catch(e){var __isNotAvailable=true}var sessionStorage=window.sessionStorage;var Storage={isAvailable:function(){try{if(!!sessionStorage&&!!localStorage&&!!JSON&&!__isNotAvailable){sessionStorage.setItem("","");sessionStorage.removeItem("");localStorage.setItem("","");localStorage.removeItem("");return true}else{return false}}catch(error){return false}},load:function(namespace,key){if(!this.isAvailable()){return null}var storageKey=this._createKey(namespace,key);var item=this._parseJSON(sessionStorage.getItem(storageKey))||this._parseJSON(localStorage.getItem(storageKey));if(!item){return null}var value=item.value;var expire=Number(item.expire);var current=(new Date).getTime();if(expire){if(expire>current){return value}else{this.remove(namespace,key)}}else{return value}this.flush();return null},save:function(namespace,key,value,expire){if(!this.isAvailable()){return null}var item={namespace:namespace,key:key,value:value};if(expire){item.expire=expire.getTime();localStorage.setItem(this._createKey(namespace,key),this._stringifyJSON(item))}else{sessionStorage.setItem(this._createKey(namespace,key),this._stringifyJSON(item))}this.flush()},remove:function(namespace,key){if(!this.isAvailable()){return null}sessionStorage.removeItem(this._createKey(namespace,key));localStorage.removeItem(this._createKey(namespace,key));this.flush()},flush:function(){if(!this.isAvailable()){return null}var key;var current=(new Date).getTime();for(var i=0;i<localStorage.length;i++){key=localStorage.key(i);if(!this._isValidStorageKey(key)){return}var item=this._parseJSON(localStorage.getItem(key));if(item){var expire=Number(item.expire);if(!expire||expire<current){localStorage.removeItem(key)}}}},_createKey:function(namespace,key){return[KEY_PREFIX,namespace,key].join("-")},_parseJSON:function(string){if(!string){return null}try{if(JSON.parse){return JSON.parse(string)}else{return string.evalJSON()}}catch(error){return null}},_stringifyJSON:function(json){if(!json){return null}if(JSON.stringify){return JSON.stringify(json)}else{return Object.toJSON(json)}},_isValidStorageKey:function(key){var pattern=new RegExp("^"+KEY_PREFIX);return pattern.test(key)}};Storage.flush();ns.provide({Storage:Storage})});Namespace("jp.co.mixi.net.uri").define(function(ns){"use strict";var HTTP_URL_REGEX=new RegExp(/^s?https?:\/\/[-_.!~*'()a-zA-Z0-9;\/?:\@&=+\$,%#]+$/);var isHttpUrl=function(urlString){if(typeof urlString!=="string"){return false}return HTTP_URL_REGEX.test(urlString)};var parseQueryString=function(queryString){var queries=queryString.split("&");var queryMap={};for(var idx=queries.length-1;idx>=0;idx--){var queryKeyValuePair=queries[idx].split("=");if(queryKeyValuePair.length!==2)continue;var queryKey=decodeURIComponent(queryKeyValuePair[0]);var queryValue=decodeURIComponent(queryKeyValuePair[1]);queryMap[queryKey]=queryValue}return queryMap};var buildQueryString=function(queryMap){var queryStringEntries=_.map(queryMap,function(val,key){return encodeURIComponent(key)+"="+encodeURIComponent(val)});return queryStringEntries.join("&")};ns.provide({isHttpUrl:isHttpUrl,parseQueryString:parseQueryString,buildQueryString:buildQueryString})});Namespace("jp.co.mixi.net.utils").define(function(ns){var merge=function(aObj,bObj){for(var p in bObj){if(bObj.hasOwnProperty(p)){aObj[p]=bObj[p]}}return aObj};var isType=function(target,object){return target===Object.prototype.toString.call(object)};var curry=function(){var f=arguments[0];var arg=Array.prototype.slice.call(arguments,1);return function(){var innerArg=Array.prototype.slice.call(arguments,0);return f.apply(this,arg.concat(innerArg))}};var isArray=curry(isType,"[object Array]");var isString=curry(isType,"[object String]");var isObject=curry(isType,"[object Object]");var keys=function(object){var ret=[];for(var o in object){if(!object.hasOwnProperty(o))continue;ret.push(o)}return ret};var methods={xmap:function(f,instance){var ret=[];for(var i=0;i<this.length;i++){ret.push(f.call(instance,this[i]))}return ret},xforEach:function(f,instance){for(var i=0;i<this.length;i++){f.call(instance,this[i],i,0)}},xfilter:function(f,instance){var ret=[];for(var i=0;i<this.length;i++){if(f.call(instance,this[i]))ret.push(this[i])}return ret},xreduce:function(f,initial){var cur=initial||this[0];var start=!initial?1:0;for(var i=start;i<this.length;i++){cur=f.call(undefined,cur,this[i],i,this)}return cur},xevery:function(f,instance){for(var i=0;i<this.length;i++){if(!f.call(instance,this[i]))return false}return true}};var augmentArray=function(array){var ret=[];if(!isArray(array))return array;ret=array.slice(0,array.length);for(var m in methods){if(ret[m])continue;ret[m]=methods[m]}return ret};var serialize=function(object){var pair=function(k,v){if(v===undefined)return encodeURIComponent(k);if(v===null)return encodeURIComponent(k)+"=";if(isObject(v))return null;if(isArray(v))return augmentArray(v).xmap(curry(pair,k)).join("&");return encodeURIComponent(k)+"="+encodeURIComponent(v)};return augmentArray(augmentArray(keys(object)).xmap(function(v){return pair(v,object[v])})).xfilter(function(v){return v?true:false}).join("&")};ns.provide({merge:merge,isArray:isArray,isString:isString,keys:keys,curry:curry,serialize:serialize,augmentArray:augmentArray})});Namespace("jp.co.mixi.profiling.brookwidget").use("brook promise").use("brook.channel channel,sendChannel").use("brook.util lock,unlock,through").use("brook.dom.compat classList,dataset,getElementsByClassName").use("jp.co.mixi.profiling.widgetprofiler profiler").define(function(ns){var TARGET_CLASS_NAME="widget";var classList=ns.classList;var dataset=ns.dataset;var widgetChannel=ns.channel("widget");var errorChannel=ns.channel("error");var removeClassName=function(className,element){classList(element).remove(className)};var elementsByClassName=ns.promise(function(n,v){v=v||TARGET_CLASS_NAME;n([v,Array.prototype.slice.call(ns.getElementsByClassName(v))])});var mapByNamespace=ns.promise(function(n,val){var targetClassName=val[0];var widgetElements=val[1];var map={};for(var i=0,l=widgetElements.length;i<l;i++){var widget=widgetElements[i];removeClassName(targetClassName||TARGET_CLASS_NAME,widget);var data=dataset(widget);var widgetNamespace=data.widgetNamespace;if(!widgetNamespace)continue;if(!map[widgetNamespace])map[widgetNamespace]=[];map[widgetNamespace].push([widget,data])}n(map)});var mapToPairs=ns.promise(function(n,map){var pairs=[];for(var namespace in map)if(map.hasOwnProperty(namespace))pairs.push([namespace,map[namespace]]);n(pairs)});var applyNamespace=ns.promise(function(n,pair){Namespace.use([pair[0],"*"].join(" ")).apply(function(ns){n([ns,pair[1]])})});var registerElements=ns.promise(function(n,v){var _ns=v[0];var widgets=v[1];try{var i=0,l=widgets.length;if(_ns.registerElement){for(;i<l;i++){_ns.registerElement.apply(null,widgets[i])}}else if(_ns.registerElements){var elements=[];for(;i<l;i++){elements.push(widgets[i][0])}_ns.registerElements(elements)}else{throw"registerElement or registerElements not defined in "+_ns.CURRENT_NAMESPACE}}catch(e){errorChannel.sendMessage(e)}n(v)});var startProfiler=function(key,count){return ns.through(function(v){ns.profiler.start(key,count)})};var endProfiler=function(key,count){return ns.through(function(v){ns.profiler.end(key,count)})};var startWidgetProfiler=ns.through(function(v){var nsStr=v[0],count=v[1].length;ns.profiler.start(nsStr,count)});var endWidgetProfiler=ns.through(function(v){var nsStr=v[0].CURRENT_NAMESPACE,count=v[1].length;ns.profiler.end(nsStr,count)});var scatterWithAfterCallback=function(callback){return ns.promise(function(next,val){for(var i=0,l=val.length;i<l;i++){next(val[i])}callback()})};var updater=ns.promise().bind(startProfiler("findingWidget",1),ns.lock("class-seek"),elementsByClassName,mapByNamespace,mapToPairs,ns.unlock("class-seek"),endProfiler("findingWidget",1),scatterWithAfterCallback(function(){ns.sendChannel("jp.co.mixi.profiling.brookwidget.finish").run()}),startWidgetProfiler,applyNamespace,registerElements,endWidgetProfiler);ns.provide({changeObserver:function(){if(!ns.profiler.isEnabled)return;widgetChannel.promises=[];widgetChannel.observe(updater);ns.profiler.setupSummary()}})});Namespace("jp.co.mixi.profiling.widgetprofiler").use("brook.util through").use("brook.channel observeChannel").use("jp.mixi.service.analysis postWidgetProfilerLog").use("jp.co.mixi.device.checker isSmartDevice").define(function(ns){var COUNT_KEY="count";var TIME_KEY="time";var CHECK_INTERVAL_FOR_STARTING_ALL_WIDGET=3e3;profiler={isEnabled:false,isFirstOutput:true,archives:[],result:{},manager:{},logAggregate:{},enable:function(isEnabled){if(!isEnabled||this.hasDisableOption()){this.isEnabled=false;return}this.isEnabled=true;var self=this;ns.observeChannel("jp.co.mixi.profiling.brookwidget.finish",ns.through(function(v){self.output();self.archives.push(self.result);self.result={}}))},setupSummary:function(){var justStarted=0;ns.observeChannel("widget",ns.through(function(v){justStarted++}));var self=this;var intervalId=setInterval(function(){if(!justStarted){self.outputSummary();clearInterval(intervalId);return}justStarted=0},CHECK_INTERVAL_FOR_STARTING_ALL_WIDGET)},start:function(nsStr,count){this.manager[nsStr]=(new Date).getTime()},end:function(nsStr,count){var obj={};obj[COUNT_KEY]=count;obj[TIME_KEY]=(new Date).getTime()-this.manager[nsStr];this.result[nsStr]=obj;delete this.manager[nsStr]},output:function(){if(this.isFirstOutput){console.info("開発環境・ステージングのみwidget起動時間(ms)を出力します。");console.info("できるだけ実機で確認してください。PCの場合はchromeでの閲覧を推奨します。");console.info("無効化するにはクエリパラメータにdisable_widget_profiler=1を付与してください。");this.isFirstOutput=false}if(console.table&&!this.isLogMode()){console.table(this.result)}else{console.log("---");_.each(this.result,function(v,ns){console.log(ns+", "+v[COUNT_KEY]+", "+v[TIME_KEY])})}},outputSummary:function(){var self=this,totalCount=0,totalTime=0;_.each(this.archives,function(result){_.each(result,function(value,nsStr){if(self.logAggregate[nsStr]){self.logAggregate[nsStr][COUNT_KEY]+=value[COUNT_KEY];self.logAggregate[nsStr][TIME_KEY]+=value[TIME_KEY]}else{self.logAggregate[nsStr]=value}totalCount+=value[COUNT_KEY];totalTime+=value[TIME_KEY]})});console.log("合計widget数: "+totalCount+", 合計時間(ms): "+totalTime);if(ns.isSmartDevice()){ns.postWidgetProfilerLog(self.logAggregate,totalCount,totalTime,location.pathname)}},hasDisableOption:function(){return!!location.search.match(/disable_widget_profiler=1/)},isLogMode:function(){return!!location.search.match(/widget_profiler_output_mode=log/)}};ns.provide({profiler:profiler})});Namespace("jp.co.mixi.realtime").use("brook.model createModel").use("brook promise").define(function(ns){"use strict";var connect=ns.promise(function(n,v){var _ocean=new Ocean(v.url,{protocols_whitelist:["xhr-polling"]});_ocean.onopen=function(){model.notify("onOpen").run(v)};_ocean.onmessage=function(event){model.notify("onMessage").run(event)};_ocean.onclose=function(){model.notify("onClose").run()}});var model=ns.createModel();var onOpen=ns.promise(function(n,v){n(v)});var onMessage=ns.promise(function(n,v){n(v)});var onClose=ns.promise(function(n,v){n(v)});model.addMethod("connect",connect);model.addMethod("onOpen",onOpen);model.addMethod("onMessage",onMessage);model.addMethod("onClose",onClose);ns.provide({getRealtimeModel:function(){return model}})});Namespace("jp.co.mixi.stopwatch").define(function(ns){"use strict";var StopWatch={};var log={};var printers={};var createDefaultPrinter=function(){if("__default__"in printers){return}var defaultPrinter={element:document.getElementById("stopWatchOutput"),log:function(message){this.element.innerHTML+=message+"<br>"}};if(!defaultPrinter.element){defaultPrinter.element=document.createElement("div");defaultPrinter.element.id="stopWatchOutput";defaultPrinter.element.style.width="300px";defaultPrinter.element.style.height="300px";defaultPrinter.element.style.position="absolute";defaultPrinter.element.style.top="0";defaultPrinter.element.style.left="0";defaultPrinter.element.style.textAlign="left";defaultPrinter.element.style.overflow="scroll";defaultPrinter.element.style.border="1px solid #000";defaultPrinter.element.style.backgroundColor="#fff";document.getElementsByTagName("body")[0].appendChild(defaultPrinter.element)}printers.__default__=defaultPrinter};var print=function(name){var printer;if(!(name in printers)){createDefaultPrinter();printer=printers.__default__}else{printer=printers[name]}printer.log(name+":"+(log[name].end-log[name].start)+"ms")};StopWatch.wrap=function(name,actualCode,printer){if(printer!==undefined){StopWatch.setPrinter(name,printer)}StopWatch.start(name);actualCode();StopWatch.end(name)};StopWatch.setPrinter=function(name,printer){if(!("log"in printer)||typeof printer.log!=="function"){throw new Error('printer for StopWatch must implement "log" method.')}printers[name]=printer};StopWatch.start=function(name){log[name]={};log[name].start=new Date};StopWatch.end=function(name){log[name].end=new Date;print(name)};ns.provide({StopWatch:StopWatch})});Namespace("jp.co.mixi.touch.ui.fastclick").define(function(ns){"use strict";ns.provide({attachFastClick:function(element){FastClick.attach(element)}})});Namespace("jp.co.mixi.touch.ui.hideaddressbar").define(function(ns){var hideAddressBar=function(){var getScrollTop=function(){return window.pageYOffset};var scrollThreshold=20;setTimeout(function(){if(getScrollTop()<scrollThreshold){window.scrollTo(0,1)}},0)};ns.provide({hideAddressBar:hideAddressBar})});Namespace("jp.co.mixi.touch.ui.textarea.autoresize").use("brook.dom.compat dataset").define(function(ns){var DEFAULTS={eventType:"keyup",isStartup:true};var AutoResize=function(element){_.extend(this,ns.dataset(element));_.defaults(this,DEFAULTS);var resize=function(){if(element.scrollHeight>element.offsetHeight){element.style.height=element.scrollHeight+"px"}};if(this.isStartup&&element.scrollHeight)resize();element.addEventListener(this.eventType,resize);this.resize=resize};ns.provide({registerElement:function(element){new AutoResize(element)},AutoResize:AutoResize})});Namespace("jp.co.mixi.touch.ui.widget.devicebranch").use("jp.co.mixi.device.checker isiOS,isAndroid").use("jp.co.mixi.gateway gateway").use("jp.co.mixi.nativeproxy callNativeProxy").define(function(ns){"use strict";var elementQueue=[];var currentVersion=null;var isWebBridgeEnabled=ns.gateway("IS_WEB_BRIDGE_ENABLED_CLIENT");if(isWebBridgeEnabled){ns.callNativeProxy("jp.mixi.application.info.get",{},function(info){if(info.result){currentVersion=String(info.result.version)}else{currentVersion="0"}_.each(elementQueue,function(it){apply(it.element,it.dataset)})})}var isEnabledVersion=function(leastVersion){if(!leastVersion){return true}var result=true;var leastVersionParts=_.map(leastVersion.split("."),function(it){return parseInt(it,10)});var currentVersionParts=_.map(currentVersion.split("."),function(it){return parseInt(it,10)});var versionParts=_.zip(leastVersionParts,currentVersionParts);_.some(versionParts,function(it){if(it[0]===it[1]){return}result=it[0]<it[1];return true});return result};var apply=function(element,dataset){var root=$j(element);var devices=dataset.onlyDevice.toLowerCase().split(",");if(_.some(devices,function(it){return it==="ios"&&ns.isiOS()&&!isWebBridgeEnabled||it==="android"&&ns.isAndroid()&&!isWebBridgeEnabled||it==="app-ios"&&ns.isiOS()&&isWebBridgeEnabled||it==="app-android"&&ns.isAndroid()&&isWebBridgeEnabled&&isEnabledVersion(dataset.leastVersion)})){root.show()}else{root.remove()}};ns.provide({registerElement:function(element,dataset){if(isWebBridgeEnabled&&!currentVersion){elementQueue.push({element:element,dataset:dataset});return}apply(element,dataset)}})});Namespace("jp.co.mixi.touch.ui.widget.emailfield").use("jp.co.mixi.lang.class defineClass").define(function(ns){"use strict";ns.provide({registerElement:function(element,dataset){if(navigator.userAgent.match(/iPhone|iPod/i)){$j(element).find(dataset.querySelect).each(function(){this.type="email"})}}})});Namespace("jp.co.mixi.touch.ui.widget.externalbadge").use("jp.co.mixi.gateway gateway").use("jp.co.mixi.device.checker isiOS,isAndroid").define(function(ns){"use strict";ns.provide({registerElement:function(element,dataset){if(!ns.gateway("IS_WEB_BRIDGE_ENABLED_CLIENT")){return}var $element=$j(element);if(!dataset.classIos||!dataset.classAndroid){throw new Error("require data-class attributes for externalbadge widget")}if(ns.isiOS()){$element.find('[data-external-badge~="ios"]').addClass(dataset.classIos)}else if(ns.isAndroid()){$element.find('[data-external-badge~="android"]').addClass(dataset.classAndroid)}}})});Namespace("jp.co.mixi.touch.ui.widget.fastclick").use("jp.co.mixi.touch.ui.fastclick attachFastClick").define(function(ns){"use strict";ns.provide({registerElement:function(element,dataset){ns.attachFastClick(element)}})});Namespace("jp.co.mixi.touch.ui.widget.taphighlight").define(function(ns){"use strict";ns.provide({registerElement:function(element,dataset){var $root=$j(element);var tapSelector=dataset.tapSelector;var tapClass=dataset.tapClass;var touchStartHandler=function(){$j(tapClass).removeClass(tapClass);$j(this).addClass(tapClass)};var touchEndHandler=function(){$j(this).removeClass(tapClass)};$root.on("touchstart",tapSelector,touchStartHandler);$root.on("touchmove touchend touchcancel",tapSelector,touchEndHandler)}})});Namespace("jp.co.mixi.ui").use("jp.co.mixi.animation Transition").define(function(ns){var Overlay=function(){var DEFAULT_STYLE={opacity:0,position:"absolute",top:"0",left:"0",background:"black",width:"100%","z-index":"10",display:"none"};var getElement=function(){var targetElement;return function(){if(targetElement)return targetElement;targetElement=document.createElement("div");targetElement.setStyle(Overlay.DEFAULT_STYLE);targetElement.enableTouchSlide=false;document.body.appendChild(targetElement);return targetElement}}();return{appear:function(cb){var targetElement=getElement();ns.Transition(targetElement,{"timing-function":"ease-out"}).from({display:"block",height:Math.max(document.body.clientHeight,document.body.scrollHeight)+"px"}).to({opacity:.5}).callback(cb)},fade:function(cb){ns.Transition(getElement()).from({opacity:.5}).to({opacity:0}).after({display:"none"}).callback(cb)},DEFAULT_STYLE:DEFAULT_STYLE}}();ns.provide({Overlay:Overlay})});Namespace("jp.co.mixi.ui.areaclickable").use("brook.dom.compat dataset").use("jp.co.mixi.dom.event observeEvent").use("jp.co.mixi.nativeproxy createNativeProxyPromise,onStartNativeProxy").define(function(ns){var stopPropagationEvent=function(evt){evt.stopPropagation()};var stopEventFunc=function(elem){ns.observeEvent(elem,"click",stopPropagationEvent)};var moveLocationBy={_default:function(url){location.href=url},nativeProxy:function(url){var fullURL=url;if(!url.match(/.*:.*/)){fullURL=url.match(/^\/.*/)?location.origin+url:location.origin+"/"+url}ns.createNativeProxyPromise("system.net.webview.open").subscribe(function(value){if(value.response.error)location.href=url},{url:fullURL})}};var moveLocation=moveLocationBy["_default"];ns.onStartNativeProxy(function(){moveLocation=moveLocationBy["nativeProxy"]});var attachByElement=function(elem){ns.observeEvent(elem,"click",function(evt){evt.preventDefault();var url=ns.dataset(elem).url;if(url){moveLocation(url)}});elem.querySelectorAll("a,input,textarea").toArray().forEach(stopEventFunc)};ns.provide({registerElement:attachByElement})});Namespace("jp.co.mixi.ui.autoselector").define(function(ns){function autoSelector(form){var target=form.querySelector($D(form).targetRef||undefined);target&&target.addEventListener("change",function(){form.submit()})}ns.provide({registerElement:autoSelector})});Namespace("jp.co.mixi.ui.click_submit").use("jp.co.mixi.dom.form formOf").define(function(ns){function check(option){option.checked=true}function clickSubmit(element){var optionValueClassses=$A($$($D(element).optionValueClass));element.addEventListener("click",function(evt){optionValueClassses.forEach(check);ns.formOf(evt.target).submit()})}ns.provide({registerElement:clickSubmit})});Namespace("jp.co.mixi.ui.confirmlink").define(function(ns){function confirmLink($element,dataset){$element.on("click",function(evt){if(window.confirm(dataset.messageText)){if($element.attr("target")==="_blank"){window.open($element.attr("href"))}else{return}}evt.preventDefault();evt.stopPropagation()})}ns.provide({registerElement:function(element,dataset){confirmLink($j(element),dataset)}})});Namespace("jp.co.mixi.ui.counter_element").define(function(ns){ns.provide({CounterElement:function(elem,defaultCount){var count=parseInt(defaultCount||elem.innerHTML||0,10),update=function(v){count=v;elem.innerHTML=count;return elem.innerHTML},increment=function(){return update(++count)},decrement=function(){return update(--count)};this.update=update;this.increment=increment;this.decrement=decrement}})});Namespace("jp.co.mixi.ui.dialog.confirm").use("brook promise").use("jp.co.mixi.lang.class defineClass").use("jp.co.mixi.nativeproxy onStartNativeProxy,createNativeProxyPromise").define(function(ns){var DEFAULT_BUTTONS_DATA=[{text:"キャンセル",value:0},{text:"OK",value:1}];var Confirm=ns.defineClass({initialize:function(){ns.onStartNativeProxy(this.onStartNativeProxyPromise())},defaultMethod:function(option,callback){if(!(option&&option.body))return;callback(window.confirm(option.body))},nativeProxyMethod:function(option,callback){var _self=this;ns.createNativeProxyPromise("system.dialog.confirm").subscribe(function(value){if(!(value.response&&value.response.result)){callback(window.confirm(option.body))}callback(value.response.result.value,value.response)},{title:option.title?option.title:"確認",body:option.body?option.body:""})},onStartNativeProxyPromise:function(){var _self=this;return ns.promise(function(next,value){_self.defaultMethod=_self.nativeProxyMethod})},show:function(option,callback){this.defaultMethod(option,callback)}});ns.provide({confirm:new Confirm})});Namespace("jp.co.mixi.ui.dialog.toast").use("brook *").use("brook.util *").use("brook.widget *").use("brook.channel *").use("brook.dom.compat *").use("jp.co.mixi.animation *").use("jp.co.mixi.image.precedentload precedentLoad").use("jp.co.mixi.device.checker isSupportFixedPosition").define(function(ns){var baseElement=null;var textElement=null;var dialogs=[];var isRun=false;var IPHONE_HEADER_AND_BOTTOM_HEIGHT=64;var messageRendererOf={normal:function(messageElement,message){messageElement.innerText=message},feedback:function(messageElement,message){messageElement.innerHTML='<mark class="gLikeSign01">イイネ！</mark>'+message},interest:function(messageElement,message){messageElement.innerHTML='<mark class="gInterestSign01">気になる！</mark>'+message}};ns.observeChannel("dialog_toast",ns.promise(function(n,v){if(isRun)return;isRun=true;var dialog=dialogs.shift();baseElement.hide();messageRendererOf[v.type](textElement,v.message);if(!ns.isSupportFixedPosition()){var top=window.scrollY+window.screen.height-window.screen.height/2-IPHONE_HEADER_AND_BOTTOM_HEIGHT;baseElement.parentNode.style.top=top+"px"}else{baseElement.parentNode.style.position="fixed"}baseElement.parentNode.show();baseElement.show();setTimeout(function(){if(baseElement.isVisible())baseElement.hide()},2e3);var that=this;ns.Transition(baseElement,{duration:200}).from({opacity:0}).to({opacity:1}).callback(function(){setTimeout(function(){ns.Transition(baseElement,{duration:200}).from({opacity:1}).to({opacity:0}).callback(function(){baseElement.hide();baseElement.parentNode.hide();if(!dialogs.length){isRun=false;return}})},1e3)})}));ns.provide({registerElement:function(element){baseElement=element;baseElement.hide();textElement=element.querySelector(ns.dataset(element).textRef||undefined);ns.precedentLoad(element)}})});Namespace("jp.co.mixi.ui.focus_link").define(function(ns){ns.provide({registerElement:function(element){element.addEventListener("click",function(){$$0($D(element).targetRef).focus()})}})});Namespace("jp.co.mixi.ui.form").use("brook promise").use("brook.channel *").use("brook.util *").use("brook.dom.compat dataset").use("jp.co.mixi.event observeEvent").use("jp.co.mixi.lang.class defineClass").use("jp.co.mixi.ui.form.imageselector ImageSelector").define(function(ns){var Form=ns.defineClass({initialize:function(element,dataset){this.element=element;this.submitButton=$j(this.element).find('input[type="submit"]');var _self=this;this.imageSelectors=[];$j(this.element).find(".JS_imageSelector").each(function(index,ImageSelectorElement){var imageSelector=new ns.ImageSelector(ImageSelectorElement);_self.imageSelectors.push(imageSelector)});ns.observeEvent(this.element,"submit",ns.promise().bind(function(next,event){event.preventDefault();event.stopPropagation();next(event)}).bind(this._formValueMapper()).bind(this._getSubmitPromise()))},_formValueMapper:function(){var _self=this;return ns.promise(function(next,value){var params={};for(var j=0;j<_self.element.length;j++){var input=_self.element[j];if(input.name)params[input.name]=input.value}next(params)})},_getSubmitPromise:function(){var _self=this;return ns.promise(function(next,value){if(_self.submitPromise&&_self.submitPromise.subscribe){_self.submitPromise.subscribe(function(v){next(v)},value)}})},onSubmit:function(promise){this.submitPromise=promise},getElement:function(){return this.element},getAllSelectedImages:function(){var images=[];images=_.map(this.imageSelectors,function(imageSelector){return imageSelector.getSelectedImages()});return _.flatten(images)},submit:function(){this.element.submit()}});ns.provide({Form:Form})});Namespace("jp.co.mixi.ui.form.file.image").use("jp.co.mixi.lang.class defineClass").define(function(ns){"use strict";var MAX_SIZE=5242880;var ERROR_CODE={NO_ERROR:0,INVALID_FORMAT:1,OVER_SIZE:2};var ERROR_LABEL={0:"",1:"image_type_exception",2:"image_size_exception"};var ERROR_MESSAGE={0:"",1:"画像はJPEG形式またはPNG形式にしてください。",2:"添付する写真は5MB以下にしてください。"};function getGALabelFromErrorCode(errorCode){return ERROR_LABEL[errorCode]}function getErrorMessageFromErrorCode(errorCode){return ERROR_MESSAGE[errorCode]}function validationFile(file){var data={message:"",errorCode:ERROR_CODE.NO_ERROR};if(!file.type.match(/image\/(jpeg|png)/)&&!file.name.match(/.*\.(jpe?g|png)$/i)){data.errorCode=ERROR_CODE.INVALID_FORMAT;data.message=getErrorMessageFromErrorCode(ERROR_CODE.INVALID_FORMAT);return data}if(file.size>MAX_SIZE){data.errorCode=ERROR_CODE.OVER_SIZE;data.message=getErrorMessageFromErrorCode(ERROR_CODE.OVER_SIZE);return data}return data}var ImageUI=ns.defineClass({initialize:function($inputTypeFile){this._inputTypeFile=$inputTypeFile;this._createFileReader();this._setHandler()},selectFile:function(){this._inputTypeFile.click()},destroy:function(){this._inputTypeFile.off();this._inputTypeFile=null;this._fileReader=null},onLoaded:function(imageSrcData){},onError:function(message){},onCancel:function(){},_setHandler:function(){var self=this;this._inputTypeFile.on("change",_.bind(this._onChange,this))},_onLoaded:function(event){var imageSrcData=event.target.result;this.onLoaded(imageSrcData)},_onChange:function(event){var file=event.target.files[0];if(!file){this.onCancel();return}var validationData=validationFile(file);if(validationData.errorCode!==ERROR_CODE.NO_ERROR){this._inputTypeFile.val("");this.onError(validationData);return}if($j&&$j.os&&$j.os.android&&/^4\.0(\.\d+)?$/.test($j.os.version)){this._createFileReader()}this._fileReader.readAsDataURL(file)},_createFileReader:function(){this._fileReader=new FileReader;this._fileReader.onload=_.bind(this._onLoaded,this)}});ns.provide({createImageUI:function($inputTypeFile){return new ImageUI($inputTypeFile)},getGALabelFromErrorCode:getGALabelFromErrorCode,getErrorMessageFromErrorCode:getErrorMessageFromErrorCode})});Namespace("jp.co.mixi.ui.form.focus").define(function(ns){var autoFocus=function(elem){var targ=$j(elem).find('input[value=""]')[0];if(targ)targ.focus()};ns.provide({autoFocus:autoFocus})});Namespace("jp.co.mixi.ui.form.imageselector").use("brook promise").use("brook.channel *").use("brook.util *").use("brook.dom.compat dataset").use("jp.co.mixi.event observeEvent").use("jp.co.mixi.lang.class defineClass").use("jp.co.mixi.ui.dialog.confirm confirm").use("jp.co.mixi.ui.template getTemplateByElementId").use("jp.co.mixi.nativeproxy createNativeProxyPromise,isEnableNativeProxy,onStartNativeProxy").define(function(ns){var DEFAULT_SELECTABLE_COUNT=1;var FileCounter=ns.defineClass({initialize:function(maxCount){if(!maxCount)return;this.maxCount=maxCount;this.currentCount=0},countUp:function(){this.currentCount++},countDown:function(){this.currentCount--},isFull:function(){return!(this.currentCount<this.maxCount)}});var getFileIds=function(element){var files=$j(element).find('[data-input-type="file"]')||[];return _.map(files,function(file){return ns.dataset(file).value})};var ImageSelector=ns.defineClass({initialize:function(element){this.element=element;this.dataset=ns.dataset(element);this.filter=this.dataset.filter?this.dataset.filter.split(/\s+/):null;this.max=this.dataset.max?parseInt(this.dataset.max,10):DEFAULT_SELECTABLE_COUNT;this.name=this.dataset.name?this.dataset.name:"";this.baseTag=this.dataset.baseTag?"<"+this.dataset.baseTag+">":"<span>";this.thumbnailTemplate=ns.getTemplateByElementId(this.dataset.thumbnailTemplate);this.filecounter=new FileCounter(this.max);this._setElementParts();this._observeEvent();var _self=this;ns.onStartNativeProxy(ns.promise(function(next,value){$j(_self.element).show()}))},_setElementParts:function(){var buttonSelector=this.dataset?this.dataset.buttonRef:null;var statusSelector=this.dataset?this.dataset.statusRef:null;var storeSelector=this.dataset?this.dataset.storeRef:null;var thumbnailSelector=this.dataset?this.dataset.thumbnailRef:null;this.buttonElement=$j(this.element).find(buttonSelector);this.statusElement=$j(this.element).find(statusSelector);this.thumbnailElement=$j(this.element).find(thumbnailSelector)},_observeEvent:function(){var _self=this;ns.observeEvent(this.buttonElement,"click",ns.promise(function(next,event){if(_self.filecounter.isFull())return;next({filter:_self.filter,max:_self.max,selected:getFileIds(_self.thumbnailElement)})}).bind(ns.createNativeProxyPromise("system.form.picture.select")).bind(_self._onCompletePromise()))},_onCompletePromise:function(){var _self=this;return ns.promise(function(next,result){var response=result.response;if(response.result&&response.result.files.length){var file=response.result.files[0];var id=file.id;_self.filecounter.countUp();_self._appendThumbnail(id,file.thumbnail);if(_self.filecounter.isFull()){_self.disable()}}})},_appendThumbnail:function(id,thumbnailData){var params={value:id,thumbnail:"data:image/jpeg;base64,"+thumbnailData};this.thumbnailTemplate.param(params);var thumbnail=$j(this.thumbnailTemplate.output());var imgElement=$j(thumbnail).find("img");imgElement.bind("load",function(event){$j(event.target.parentNode).removeClass("loading");$j(imgElement).removeClass("loading");$j(imgElement).show()});var _self=this;$j(thumbnail).bind("click",function(event){ns.confirm.show({title:"確認",body:"削除しますか？"},function(value){if(!value)return;$j(thumbnail).remove();_self.filecounter.countDown();if(!_self.filecounter.isFull())_self.enable()})});$j(this.thumbnailElement).append(thumbnail);$j(imgElement).attr("src","data:image/jpeg;base64,"+thumbnailData);window.startTime=new Date},enable:function(){$j(this.buttonElement).removeClass("disabled")},disable:function(){$j(this.buttonElement).addClass("disabled")},getSelectedImages:function(){var thumbnails=$j(this.element).find('[data-input-type="file"]');var nameIndexs={};var _self=this;var name=_self.name;var images=_.map(thumbnails,function(file){var dataset=ns.dataset(file);if(_self.name&&_self.max>1){var count;if(nameIndexs[_self.name]){count=++nameIndexs[_self.name]}else{count=nameIndexs[_self.name]=1}name=_self.name+count}file.name=name;return file});return images}});ns.provide({ImageSelector:ImageSelector})});Namespace("jp.co.mixi.ui.form.resetattachedfile").define(function(ns){var resetAttachedFile=function($input){var $form=$j("<form />");var dummyInputOnOriginalPosition=$j('<input type="file" style="display:none"/>');$input.replaceWith(dummyInputOnOriginalPosition);$form.append($input);$form[0].reset();dummyInputOnOriginalPosition.replaceWith($input);$input.trigger("change");$form.remove();dummyInputOnOriginalPosition.remove()};ns.provide({resetAttachedFile:resetAttachedFile})});Namespace("jp.co.mixi.ui.getscrollbarwidth").define(function(ns){var scrollBarWidth=null;var getScrollBarWidth=function getScrollBarWidth(){if(scrollBarWidth!=null)return scrollBarWidth;var body=$$("body")[0];if(body===undefined)throw new Error('getscrollbarwidth is required "body"');var div=$(document.createElement("div"));div.setStyle({position:"absolute",top:"0px",left:"-100px",width:"100px",height:"100px",overflowY:"scroll"});body.insert(div);scrollBarWidth=parseInt(div.offsetWidth,10)-parseInt(div.clientWidth,10);div.remove();return scrollBarWidth};ns.provide({getScrollBarWidth:getScrollBarWidth})});Namespace("jp.co.mixi.ui.image.adjuster").define(function(ns){var adjustImage=function(element,dataset){setTimeout(function(){var image=$j(element);if(/MSIE/.test(navigator.userAgent)){image.removeAttr("width");image.removeAttr("height");image.show()}image.one("load",function(){var maxHeight=dataset.maxHeight;var maxWidth=dataset.maxWidth;var width=image.width();var height=image.height();if(!!dataset.noExpand&&width<maxWidth&&height<maxHeight){image.show();return}var ratioX=width/maxWidth||1;var ratioY=height/maxHeight||1;var ratio=Math.max(ratioX,ratioY);image.width(Math.floor(width/ratio));image.height(Math.floor(height/ratio));image.show()}).each(function(){if(this.complete){$j(this).trigger("load")}else{if(dataset.noImageUrl){$j(this).attr("src",dataset.noImageUrl)}}})})};ns.provide({registerElement:adjustImage})});Namespace("jp.co.mixi.ui.itemselector").use("brook promise").use("brook.util through").use("brook.model createModel").use("brook.dom.compat dataset").use("jp.co.mixi.lang.class defineClass").use("jp.co.mixi.ui.itemselector.filter BASIC_FILTER").use("jp.co.mixi.device.checker isAndroid").define(function(ns){var ITEM_ID_ATTRIBUTE="data-item-id";var __assertItems=function(items){_.each(items,function(item){if(item.id){return}throw"Invalid item : "+"Each item needs to have property [id]."})};var clickObserver=function(element,func){var useTouchEvent=window.ontouchend||window.ontouchend===null;if(ns.isAndroid&&ns.isAndroid()){useTouchEvent=false}if(useTouchEvent){var scrollWhenTouchStart;element.bind("touchstart",function(){scrollWhenTouchStart=window.scrollY});element.bind("touchend",function(){if(scrollWhenTouchStart===window.scrollY){func()}});element.click(function(event){event.preventDefault()})}else{element.click(func)}};var ItemSelector=ns.defineClass({initialize:function(args){var _self=this;_self._items=args.items;_self._itemListTemplate=args.itemListTemplate;_self._itemListElement=$j(args.itemListElement);if(args.selectLimit){_self._selectLimit=args.selectLimit}__assertItems(_self._items);_self._itemListElement.html("");_self._selectedIds={};_self._renderedUserOf={};_self._itemElementOf={};_self._eventHandler=ns.createModel();_self._currentFilter=ns.BASIC_FILTER.ALL();_self._eventHandler.addMethod("select",ns.through(function(selected){if(!_self._isSelectable()){return}_self._selectedIds[selected.item.id]=true;if(!selected.element){return}_self._styleChanger.select(selected.element)}));_self._eventHandler.addMethod("unselect",ns.through(function(unselected){delete _self._selectedIds[unselected.item.id];if(!unselected.element){return}_self._styleChanger.unselect(unselected.element)}));_self._eventHandler.addMethod("clearItemElements",ns.promise());_self._eventHandler.addMethod("renderItems",ns.promise());_self._eventHandler.addMethod("setFilter",ns.promise());_self._styleChanger={select:function(element){element.addClass("selected")},unselect:function(element){element.removeClass("selected")}}},clearItemElements:function(){var _self=this;return ns.through(function(){_self._itemListElement.html("");_self._itemElementOf={}}).bind(_self._eventHandler.notify("clearItemElements"))},renderItems:function(){var _self=this;_self._renderedUserOf={};return ns.promise(function(next,pageInfo){var offset=pageInfo.offset;var limit=pageInfo.limit||_self.getCount().total;var filteredItems=_.filter(_self._items,_self._currentFilter.test);filteredItems=filteredItems.splice(offset,limit);if(_.isEmpty(filteredItems)){next([]);return}_self._itemListTemplate.param({items:filteredItems});var toAppendElement=$j("<div>").html($j(_self._itemListTemplate.output()));var itemElements=toAppendElement.find(_.str.sprintf("[%s]",ITEM_ID_ATTRIBUTE));var errorMessage="Invalid template : "+"Set attribute [%s] on each item elements";if(filteredItems.length!==itemElements.length){throw _.str.sprintf(errorMessage,ITEM_ID_ATTRIBUTE)}_self._itemListElement.append(toAppendElement.children());_.each(itemElements,function(element){_self._registerItem($j(element))});next(itemElements)}).bind(_self._eventHandler.notify("renderItems"))},_registerItem:function(element){var _self=this;var itemId=ns.dataset(element.get(0)).itemId;var item=_(_self._items).find(function(_item){return _item.id==itemId});_self._itemElementOf[itemId]=element;if(_self.isSelected(item)){_self._styleChanger.select(element)}clickObserver(element,function(event){if(event){event.preventDefault();event.stopPropagation()}var eventName=_self.isSelected(item)?"unselect":"select";_self._eventHandler.notify(eventName).run({item:item,element:element})})},observeEvent:function(eventName,promise){this._eventHandler.method(eventName).observe(promise)},registerStyleChanger:function(type,changer){var _self=this;_self._styleChanger[type]=changer},isSelected:function(item){return this._selectedIds[item.id]},getSelectedIds:function(){return _.keys(this._selectedIds)},setFilter:function(filter){var _self=this;return ns.through(function(){_self._currentFilter=filter}).bind(_self._eventHandler.notify("setFilter"))},getCurrentFilter:function(){return this._currentFilter},getCount:function(){var filteredItems=_(this._items).filter(this._currentFilter.test);return{selected:_.keys(this._selectedIds).length,filtered:filteredItems.length,total:this._items.length}},_isSelectable:function(){if(!this._selectLimit){return true}return this.getSelectedIds().length>=this._selectLimit?false:true},select:function(id){var _self=this;var selectedElement=_self._itemElementOf[id];var selectedItem=_.find(_self._items,function(item){return item.id==id});_self._eventHandler.notify("select").run({item:selectedItem,element:selectedElement})},selectAll:function(){this._changeStatusAll("select")},unselectAll:function(){this._changeStatusAll("unselect")},_changeStatusAll:function(method){var _self=this;var filter=_self._currentFilter.test;var filteredItems=_.filter(_self._items,filter);_.each(filteredItems,function(item){var element=_self._itemElementOf[item.id];_self._eventHandler.notify(method).run({item:item,element:element})})}});ns.provide({ItemSelector:ItemSelector})});Namespace("jp.co.mixi.ui.itemselector.filter").define(function(ns){ns.provide({BASIC_FILTER:{ALL:function(){return{name:"全て",id:"all",test:function(){return true}}},SELECTED:function(itemSelector){return{name:"選択済み",id:"selected",test:function(item){return itemSelector.isSelected(item)}}}},createSelectedFilter:function(itemSelector){var selectedIds=itemSelector.getSelectedIds();return{name:"選択済み",id:"selected",test:function(item){return _.any(selectedIds,function(id){return id==item.id})}}}})});Namespace("jp.co.mixi.ui.itemselector.tool").use("jp.co.mixi.ui.paginator.more MorePaginator,registerMoreButton").use("jp.co.mixi.lang.class defineClass").use("brook.util through").define(function(ns){var SelectorTool=ns.defineClass({initialize:function(selector){this._selector=selector},registerFilterController:function(selectElement,filters){var _self=this;selectElement=$j(selectElement);_(filters).each(function(filter){var option=$j("<option>");option.attr("value",filter.id);option.text(filter.name);selectElement.append(option)});selectElement.change(function(){var selectedId=selectElement.val();var selectedFilter=_(filters).find(function(filter){return selectedId===filter.id});_self._selector.setFilter(selectedFilter).run()})},registerMoreLink:function(moreLinkElement,perPage){var _self=this;perPage=perPage||_self._selector.getCount().total;var getCurrentCount=function(){return _self._selector.getCount().filtered};var morePaginator=new ns.MorePaginator({totalCount:getCurrentCount(),perPage:perPage,showPagePromise:_self._selector.renderItems()});ns.registerMoreButton(morePaginator,moreLinkElement);_self._selector.observeEvent("setFilter",ns.through(function(){morePaginator.clear(getCurrentCount())}).bind(_self._selector.clearItemElements()).bind(morePaginator.showMore()));return morePaginator},registerCounter:function(selectedCountElement,totalCountElement){var _self=this;selectedCount=$j(selectedCountElement);totalCount=$j(totalCountElement);var update=function(currentCount){totalCount.text(currentCount.total);selectedCount.text(currentCount.selected)};var dispCount=_self._selector.getCount();update(dispCount);var timerId=setInterval(function(){var currentCount=_self._selector.getCount();if(dispCount.total==currentCount.total&&dispCount.selected==currentCount.selected){return}update(currentCount);dispCount=currentCount},250);return timerId},unregisterCounter:function(timerId){clearInterval(timerId)}});ns.provide({SelectorTool:SelectorTool})});Namespace("jp.co.mixi.ui.layer").use("brook promise").use("brook.util *").use("brook.lambda lambda").use("jp.co.mixi.lang.class *").define(function(ns){var baseOption={backgroundColor:"#000",opacity:"0.0",width:"100%"};var defaultOption={display:"none",position:"absolute",left:"0",top:"0"};var createDiv=function(option){var e=new Element("div");e.setStyle(defaultOption);e.setStyle(option);return e};var append=function(element){document.body.appendChild(element)};var remove=function(element){document.body.removeChild(element)};var addEventListener=Event.observe;var stack=_([]);var createLayer=function(option){var layer=new Layer(option);layer.apply(append);stack.push(layer);return layer};var deleteLayer=function(layer){layer.apply(remove)};var pairCaller=ns.definePropertyCaller("pair","invoke");var Layer=ns.defineClass({initialize:function(option){this.base=createDiv(_.extend(baseOption,option.base||{}));this.surface=createDiv(_.extend(option.surface||{}));this.pair=_([this.base,this.surface]);if(option.closed){addEventListener(this.base,"click",deleteLayer.curry(this))}},apply:function(f){this.pair.each(f)},show:function(left,top){$j(this.base).css("height",$j("body").height()+"px");pairCaller.call(this,"show");this.surface.setStyle({left:left+"px",top:top+"px"})},fade:function(){this.surface.fade({duration:.15});this.base.hide()},hide:pairCaller.curry("hide"),update:ns.definePropertyCaller("surface","update")});ns.provide({createLayer:createLayer,deleteLayer:deleteLayer})});Namespace("jp.co.mixi.ui.modalwindow").use("jp.co.mixi.ui.popup PopupBox").define(function(ns){"use strict";ns.provide({createModalWindow:function(element,dataset){return new ns.PopupBox(element,{closerOverlayElementSelector:dataset.closerOverlayElementSelector,triggerElementSelector:dataset.triggerElementSelector,closerElementSelector:dataset.closerElementSelector,zIndex:dataset.zIndex,popupPositionAlign:dataset.popupPositionAlign,popupPositionValign:dataset.popupPositionValign,popupPositionFixed:"true",closeOnOutsideClick:"true",closeAndRemove:dataset.closeAndRemove,htmlClass:dataset.htmlClass})}})});Namespace("jp.co.mixi.ui.more.list").define(function(ns){ns.provide({registerElement:function(element,dataset){var targets=$A($$(dataset.rowClass));var position=0;var defaultShowCount=parseInt(dataset.defaultShowCount);var showCount=parseInt(dataset.showCount);var moreButton=$$0(dataset.moreClass);if(defaultShowCount>=targets.length){for(position=0;position<targets.length;position++){targets[position].show();moreButton.hide()}}else{for(position=0;position<defaultShowCount;position++){targets[position].show()}}moreButton.addEventListener("click",function(){var i=0;for(i=position;i<position+showCount;i++){if(targets.length-1<i){this.hide();return}targets[i].show()}position=i})}})});Namespace("jp.co.mixi.ui.more.oneway").define(function(ns){var hideElement=function(element){element.hide()};var toggleElement=function(element){element.toggle()};ns.provide({registerElement:function(element,dataset){var targets=$A($$(dataset.ref));var parentDepth=parseInt(dataset.parentDepth||0);var own=element;for(var i=0;i<parentDepth;i++){own=own.parentNode}targets.forEach(hideElement);element.addEventListener("click",function(){targets.forEach(toggleElement);own.hide()})}})});Namespace("jp.co.mixi.ui.more.openclose").use("jp.co.mixi.animation.scroll smoothScrollTo").define(function(ns){var hideElement=function(element){element.hide()};var toggleElement=function(element){element.toggle()};ns.provide({registerElement:function(element,dataset){var isOpen=false;var link=element.querySelector("a");var targets=$A($$(dataset.ref));targets.forEach(hideElement);element.className=dataset.openClass;link.addEventListener("click",function(){targets.forEach(toggleElement);element.className=isOpen?dataset.openClass:dataset.closeClass;link.innerHTML=isOpen?dataset.openComment:dataset.closeComment;if(dataset.isSmoothCloseRef&&isOpen)ns.smoothScrollTo($$0(dataset.isSmoothCloseRef));isOpen=!isOpen})}})});Namespace("jp.co.mixi.ui.paginator").use("brook promise").use("brook.util through").use("brook.model createModel").use("jp.co.mixi.lang.class defineClass").define(function(ns){var __assertArgs=function(args,requiredArgs){_.each(requiredArgs,function(requiredKey){var keys=_(args).keys();if(!_(keys).include(requiredKey)){throw _.str.sprintf("Missing required argument : [%s]",requiredKey)}})};var Paginator=ns.defineClass({initialize:function(args){var _self=this;__assertArgs(args,["totalCount","perPage","showPagePromise"]);_self._totalCount=args.totalCount;_self._perPage=args.perPage;_self._showPagePromise=args.showPagePromise;_self._eventHandler=ns.createModel();_self._eventHandler.addMethod("movePage",ns.promise());_self._maxPage=args.totalCount===0?1:Math.ceil(args.totalCount/args.perPage)},moveTo:function(){var _self=this;return ns.through(function(pageNumber){if(pageNumber>_self._maxPage){pageNumber=_self._maxPage}if(pageNumber<1){pageNumber=1}_self.currentPage=pageNumber}).bind(_self._getPageInfo(),_self._showPagePromise,_self._eventHandler.notify("movePage"))},observePageMove:function(promise){this._eventHandler.method("movePage").observe(promise)},getMaxPage:function(){return this._maxPage},getCurrentPage:function(){return this.currentPage},isFirstPage:function(){return this.currentPage===1},isLastPage:function(){return this.currentPage===this._maxPage},_getPageInfo:function(){var _self=this;return ns.promise(function(next,value){var offset=(_self.currentPage-1)*_self._perPage;var limit=_self._perPage;if(_self.isLastPage()){limit=_self._totalCount-_self._perPage*(_self.currentPage-1)}next({offset:offset,limit:limit})})}});var registerNextPrevButtons=function(paginator,goNextElement,goPrevElement){goNextElement=$j(goNextElement);goPrevElement=$j(goPrevElement);var setButtonVisibility=ns.through(function(){if(paginator.isFirstPage()){goPrevElement.hide()}else{goPrevElement.show()}if(paginator.isLastPage()){goNextElement.hide()}else{goNextElement.show()}});setButtonVisibility.run();paginator.observePageMove(setButtonVisibility);goNextElement.click(function(evt){evt.preventDefault();evt.stopPropagation();paginator.moveTo().run(paginator.getCurrentPage()+1)});goPrevElement.click(function(evt){evt.preventDefault();evt.stopPropagation();paginator.moveTo().run(paginator.getCurrentPage()-1)})};ns.provide({Paginator:Paginator,registerNextPrevButtons:registerNextPrevButtons})});Namespace("jp.co.mixi.ui.paginator.more").use("brook promise").use("brook.model createModel").use("brook.util through").use("jp.co.mixi.lang.class defineClass").define(function(ns){var __assertArgs=function(args,requiredArgs){_.each(requiredArgs,function(requiredKey){var keys=_(args).keys();if(!_(keys).include(requiredKey)){throw _.str.sprintf("Missing required argument : [%s]",requiredKey)}})};var MorePaginator=ns.defineClass({initialize:function(args){var _self=this;__assertArgs(args,["totalCount","showPagePromise","perPage"]);_self._totalCount=args.totalCount;_self._showPagePromise=args.showPagePromise;_self._perPage=args.perPage;_self._currentOffset=0;_self._eventHandler=ns.createModel();_self._eventHandler.addMethod("showMore",ns.promise())},clear:function(totalCount){var _self=this;if(_.isNumber(totalCount)){_self._totalCount=totalCount}_self._currentOffset=0},showMore:function(){var _self=this;var getPageInfo=ns.promise(function(next,value){var offset=_self._currentOffset;_self._currentOffset+=_self._perPage;var isLastPage=!_self.hasNext();var limit=isLastPage?_self._totalCount-_self._currentOffset+_self._perPage:_self._perPage;next({offset:offset,limit:limit})});return getPageInfo.bind(_self._showPagePromise).bind(_self._eventHandler.notify("showMore"))},hasNext:function(){return this._totalCount-1>=this._currentOffset},observeShowMore:function(promise){this._eventHandler.method("showMore").observe(promise)}});var registerMoreButton=function(morePaginator,element){var moreElement=$j(element);var setElemVisibility=ns.through(function(){if(morePaginator.hasNext()){moreElement.show()}else{moreElement.hide()}});setElemVisibility.run();morePaginator.observeShowMore(setElemVisibility);moreElement.click(function(){morePaginator.showMore().run()})};ns.provide({MorePaginator:MorePaginator,registerMoreButton:registerMoreButton})});Namespace("jp.co.mixi.ui.parent_clickable").use("jp.co.mixi.dom.event observeEvent").use("jp.co.mixi.nativeproxy createNativeProxyPromise,onStartNativeProxy").define(function(ns){var moveLocationBy={_default:function(url,target){if(target=="_blank"){window.open(url)}else{location.href=url}},nativeProxy:function(url,target){var fullURL=url;if(!url.match(/.*:.*/)){fullURL=url.match(/^\/.*/)?location.origin+url:location.origin+"/"+url}ns.createNativeProxyPromise("system.net.webview.open").subscribe(function(value){if(value.response.error)location.href=url},{url:fullURL})}};var moveLocation=moveLocationBy["_default"];ns.onStartNativeProxy(function(){moveLocation=moveLocationBy["nativeProxy"]});var attachByElement=function(element){var dataset=$D(element);var parentDepth=parseInt(dataset.parentDepth||1);var ignoreNativeproxy=!!dataset.ignoreNativeproxy;element.querySelectorAll("a").toArray().forEach(function(anchor){var parent=anchor;for(var i=0;i<parentDepth;i++){parent=parent.parentNode}parent.addEventListener("click",function(event){event.stopPropagation();event.preventDefault();if(!ignoreNativeproxy||moveLocation!=moveLocationBy["nativeProxy"]){moveLocation(anchor.href,anchor.target)}},false)})};ns.provide({registerElements:function(targetElements){targetElements.forEach(attachByElement)},attachByElement:attachByElement})});Namespace("jp.co.mixi.ui.pc.areaclickable").use("brook *").use("brook.util *").define(function(ns){var ignoreElements=[];var canClickableElement=function(elem){var tagName=elem.tagName.toUpperCase();var parentTagName=$j(elem).parent().get(0).tagName.toUpperCase();if(tagName==="A"||tagName==="INPUT"||tagName==="TEXTAREA"||parentTagName==="A"){return false}else if(ignoreElements.indexOf(elem)>-1){return false}return true};var setClickable=function(elem,dataset){elem.observe("click",function(evt){if(!canClickableElement(evt.target)){return}evt.stop();var url=dataset.url;if(url){location.href=url}});var className=dataset.mouseoverClassName;if(!className){return}elem.observe("mouseover",function(evt){if(!elem.hasClassName(className)){elem.addClassName(className)}});elem.observe("mouseout",function(evt){if(elem.hasClassName(className)){elem.removeClassName(className)}})};var addIgnoreElement=function(element){if(ignoreElements.indexOf(element)===-1){ignoreElements.push(element)}};ns.provide({registerElement:setClickable,setClickable:setClickable,addIgnoreElement:addIgnoreElement})});Namespace("jp.co.mixi.ui.popup").use("jp.co.mixi.lang.class defineClass").define(function(ns){"use strict";var DEFAULT_CONTENT_ZINDEX=50;var MINIMUM_MARGIN=20;var PopupLayer=ns.defineClass({initialize:function(element,dataset){this.rootElement=$j(document.body);this.popupElement=$j(element);this.hideAreaElement=$j(dataset.hideAreaElementSelector);this.zIndex=dataset.zIndex||DEFAULT_CONTENT_ZINDEX;this.triggerElementSelector=dataset.triggerElementSelector;this.closerElementSelector=dataset.closerElementSelector;var _self=this;if(!this.closerElementSelector)throw new Error("undefined closer element selector");$j(this.rootElement).on("click",this.closerElementSelector,function(){_self.popupElement.hide();_self.hideAreaElement.show();_self.restoreScrollPosition()});if(!this.triggerElementSelector)return;$j(this.rootElement).on("click",this.triggerElementSelector,function(){_self.storeScrollPosition();_self.popupElement.show();_self.popupElement.css({zIndex:this.zIndex,position:"absolute"});_self.hideAreaElement.hide();_self.scrollToPageTop()})},scrollToPageTop:function(){window.scrollTo(0,0)},storeScrollPosition:function(){this.previousScrollTop=$j(window).scrollTop()},restoreScrollPosition:function(){window.scrollTo(0,this.previousScrollTop)}});var PopupBox=ns.defineClass({initialize:function(element,dataset){this.rootElement=$j(document.body);this.popupElement=$j(element);this.closerOverlayElement=$j(dataset.closerOverlayElementSelector);this.moveElementsToBottom();this.zIndex=dataset.zIndex;this.popupPositionAlign=dataset.popupPositionAlign;this.popupPositionValign=dataset.popupPositionValign;this.popupPositionFixed=dataset.popupPositionFixed=="true";this.triggerElementSelector=dataset.triggerElementSelector;this.closerElementSelector=dataset.closerElementSelector;this.htmlClass=dataset.htmlClass;this.closeAndRemove=dataset.closeAndRemove=="true";this.setClickEventHandlers();var closeOnOutsideClick=dataset.closeOnOutsideClick!=="false";if(closeOnOutsideClick){this.setCloserOverlay()}},moveElementsToBottom:function(){if(this.closerOverlayElement.length>0){this.moveElementToBottom(this.closerOverlayElement);if(!this.overlayEnclosesPopupElement()){this.moveElementToBottom(this.popupElement)}}else{this.moveElementToBottom(this.popupElement)}},overlayEnclosesPopupElement:function(){return this.closerOverlayElement.find(this.popupElement).length>0},moveElementToBottom:function(jElement){jElement.appendTo(this.rootElement)},setClickEventHandlers:function(){var _self=this;$j(this.closerElementSelector).on("click",function(event){event.preventDefault();event.stopPropagation();_self.close(event)});this.popupElement.on("click",function(event){event.stopPropagation()});if(!this.triggerElementSelector)return;$j(this.rootElement).on("click",this.triggerElementSelector,function(event){event.preventDefault();event.stopPropagation();_self.show(event)})},setCloserOverlay:function(){if(this.closerOverlayElement.length>0){if(this.zIndex!==undefined){this.closerOverlayElement.css({zIndex:this.zIndex-1})}}else{var zIndex=this.zIndex===undefined?this.popupElement.css("zIndex"):this.zIndex;this.closerOverlayElement=$j("<div>&nbsp;</div>");this.closerOverlayElement.css({position:"fixed",left:"0",top:"0",width:"100%",height:"100%",zIndex:zIndex-1,opacity:0,backgroundColor:"#000000"});this.rootElement.append(this.closerOverlayElement)}this.closerOverlayElement.hide();var _self=this;this.closerOverlayElement.on("click",function(event){_self.close(event)})},show:function(event){this.closerOverlayElement.show();this.popupElement.show();if(this.zIndex!==undefined){this.popupElement.css({zIndex:this.zIndex})}this.popupElement.css(this.getCoordinateOfPopup(event));if(this.htmlClass!==undefined){$j("html").addClass(this.htmlClass)}},close:function(event){this.popupElement.hide();this.closerOverlayElement.hide();if(this.closeAndRemove){this.popupElement.remove();this.closerOverlayElement.remove()}if(this.htmlClass!==undefined){$j("html").removeClass(this.htmlClass)}},getCoordinateOfPopup:function(event){var css={};var left=this.calcCoordinateOfLeft(event);var top=this.calcCoordinateOfTop(event);if(!_.isUndefined(left))css.left=left;if(!_.isUndefined(top))css.top=top;return css},getFrameOfTargetElement:function(event){if(!event){return{top:$j(document).scrollTop(),left:0,height:$j(window).height(),width:$j(window).width()}}else{var element=$j(event.target);var offset=element.offset();return{top:offset.top,left:offset.left,height:element.outerHeight(true),width:element.outerWidth(true)}}},getEventOffset:function(event,targetFrame){if(!this.popupPositionFixed||!event){return{x:0,y:0}}else{var eventOffsetX=event.pageX-targetFrame.left;var eventOffsetY=event.pageY-targetFrame.top;return{x:eventOffsetX,y:eventOffsetY-targetFrame.height}}},calcCoordinateOfLeft:function(event){if(!this.popupPositionAlign)return;var left;var targetFrame=this.getFrameOfTargetElement(event);var eventOffset=this.getEventOffset(event,targetFrame);switch(this.popupPositionAlign){case"center":{left=targetFrame.left-(this.popupElement.outerWidth(true)/2-targetFrame.width/2);break}case"left":{left=event.pageX-this.popupElement.outerWidth(true)-eventOffset.x;break}case"right":{left=event.pageX-eventOffset.x;break}case"windowCenter":{left=($j(window).width()-this.popupElement.outerWidth(true))/2;if(left<MINIMUM_MARGIN)left=MINIMUM_MARGIN;break}case"oneThirdLeft":{left=$j(window).width()/3-this.popupElement.outerWidth(true)/2;break}case"leftOfTrigger":{left=$j(event.currentTarget).offset().left;break}default:{throw new Error("No Specification Error: you must specific popup position by data-popup-position-align.")}}var normalizedLeft=left-this.rootElement.offset().left;return normalizedLeft},calcCoordinateOfTop:function(event){if(!this.popupPositionValign)return;var top;var targetFrame=this.getFrameOfTargetElement(event);var eventOffset=this.getEventOffset(event,targetFrame);switch(this.popupPositionValign){case"aboveTarget":{top=targetFrame.top-this.popupElement.outerHeight(true);break}case"belowTarget":{top=targetFrame.top+targetFrame.height;break}case"aboveCursor":{top=event.pageY-this.popupElement.outerHeight(true)-eventOffset.y;break}case"belowCursor":{top=event.pageY-eventOffset.y;break}case"center":{var centerY=targetFrame.top+targetFrame.height/2;top=centerY-this.popupElement.outerHeight(true)/2;break}case"windowCenter":{var jWindow=$j(window);top=(jWindow.height()-this.popupElement.outerHeight(true))/2;if(top<MINIMUM_MARGIN)top=MINIMUM_MARGIN;if(this.popupElement.css("position")!=="fixed"){top+=jWindow.scrollTop()}break}default:{throw new Error("No Specification Error: you must specific popup position by data-popup-position-valign.")}}var normalizedTop=top-this.rootElement.offset().top;return normalizedTop}});ns.provide({PopupLayer:PopupLayer,PopupBox:PopupBox})});Namespace("jp.co.mixi.ui.scroll_to").use("jp.co.mixi.animation.scroll smoothScrollTo").define(function(ns){ns.provide({registerElement:function(element){element.addEventListener("click",function(){ns.smoothScrollTo($$0(element.dataset.targetRef))},false)}})});Namespace("jp.co.mixi.ui.showwindow").define(function(ns){var ShowWindow=function(){var Klass=function(element){this.element=element};(function(_proto){_proto.show=function(cb){this.element.setStyle({display:"block"});cb()};_proto.hide=function(cb){this.element.setStyle({display:"none"});cb()}})(Klass.prototype);return Klass}(),falseThenError=function(value,message){if(!value){throw message}return value},WindowManager=function(){var parentWindowElement,windowMap={},currentOpenWindow,_wm={};_wm.registerContainer=function(container){var datasets=$D(container);parentWindowElement=falseThenError($(datasets.parentWindowId),"parentId does not exist.")};_wm.registerWindow=function(windowName,windowObject){windowMap[windowName]=windowObject};_wm.open=function(windowName,callback){var aWindow=falseThenError(windowMap[windowName],"no such a windowName");if(currentOpenWindow){throw"already opened Window"}currentOpenWindow=aWindow;setTimeout(function(){window.scrollTo(0,1)},100);window.setTimeout(function(){aWindow.show(function(){parentWindowElement.hide();callback(WindowManager)})},500)};_wm.getCurrentElement=function(){return currentOpenWindow.element};_wm.close=function(callback){var targetWindow=currentOpenWindow;if(!targetWindow){return}setTimeout(function(){window.scrollTo(0,1)},100);currentOpenWindow=null;parentWindowElement.show();targetWindow.hide(function(){window.setTimeout(function(){callback(WindowManager)},500)})};return _wm}(),registerElements=function(targetElements){if(targetElements.length!==1){throw"showwindow must be one"}WindowManager.registerContainer(targetElements[0]);$A(targetElements[0].querySelectorAll("div")).forEach(function(windowElement){WindowManager.registerWindow($D(windowElement).windowName,new ShowWindow(windowElement))})};ns.provide({registerElements:registerElements,ShowWindowManager:WindowManager})});Namespace("jp.co.mixi.ui.slideupwindow").use("brook promise").use("brook.dom.compat dataset").use("brook.channel observeChannel").use("jp.co.mixi.animation CSSTransform,Transition").use("jp.co.mixi.device.checker getVersion,isAndroid,isChromeForAndroid").define(function(ns){var parentWindowId;var SlideupWindow=function(){var Klass=function(element){this.element=element};(function(){this.show=function(cb){this.element.setStyle({top:"0px",zIndex:2147483647});ns.Transition(this.element).from({display:"block",transform:ns.CSSTransform.translate(0,window.innerHeight)}).to({transform:ns.CSSTransform.translate(0,0)}).callback(cb)};this.hide=function(cb){ns.Transition(this.element).from({transform:ns.CSSTransform.translate(0,0)}).to({transform:ns.CSSTransform.translate(0,window.innerHeight)}).after({display:"none"}).callback(cb)};this.refresh=function(){var refreshTarget=$j(this.element);var nowScrollY=window.pageYOffset;refreshTarget.css("display","none");window.setTimeout(function(){refreshTarget.css("display","block");window.scrollTo(0,nowScrollY)},0)};this.forceDisplay=function(){$j(this.element).show()}}).apply(Klass.prototype);return Klass}();var falseThenError=function(value,message){if(!value)throw message;return value};var WindowManager=function(){var parentWindowElement;var windowMap={};var currentOpenWindow;var _disableCSSAnimation=false;if(!ns.isChromeForAndroid()&&ns.isAndroid()&&parseFloat(ns.getVersion())>=4){ns.observeChannel("jp.co.mixi.animation.transition.end",ns.promise(function(n,v){if(currentOpenWindow){currentOpenWindow.refresh()}}))}return{registerContainer:function(container){var datasets=ns.dataset(container);parentWindowElement=$j("#"+datasets.parentWindowId);falseThenError(parentWindowElement.length===1,"parentId does not exist.")},registerWindow:function(windowName,windowObject){windowMap[windowName]=windowObject},disableCSSAnimation:function(){_disableCSSAnimation=true},open:function(windowName,callback){var aWindow=falseThenError(windowMap[windowName],"no such a windowName");if(currentOpenWindow)throw"already openedWindow";currentOpenWindow=aWindow;setTimeout(function(){window.scrollTo(0,1)},100);window.setTimeout(function(){if(_disableCSSAnimation){parentWindowElement.hide();$j(aWindow.element).show();callback(WindowManager);return}aWindow.show(function(){parentWindowElement.hide();callback(WindowManager)})},500)},getCurrentElement:function(){return currentOpenWindow.element},getElementByName:function(windowName){var aWindow=falseThenError(windowMap[windowName],"no such a windowName");return aWindow.element},close:function(callback){if(!currentOpenWindow)return;setTimeout(function(){window.scrollTo(0,1)},100);var targetWindow=currentOpenWindow;currentOpenWindow=null;parentWindowElement.show();if(_disableCSSAnimation){$j(targetWindow.element).hide();callback(WindowManager);return}targetWindow.hide(function(){window.setTimeout(function(){callback(WindowManager)},500)})},forceDisplayCurrentOpenWindow:function(){if(currentOpenWindow){currentOpenWindow.forceDisplay()}}}}();ns.provide({registerElements:function(targetElements){var parentWindowIds=_.map(targetElements,function(targetElement){var dataset=ns.dataset(targetElement);return falseThenError(dataset.parentWindowId,"parentId does not exist.")});var uniqueParentWindowIds=_.uniq(parentWindowIds);falseThenError(uniqueParentWindowIds.length===1,"parentIds must be unique.");var uniqueParentWindowId=uniqueParentWindowIds[0];if(!parentWindowId){parentWindowId=uniqueParentWindowId}else{falseThenError(parentWindowId===uniqueParentWindowId,"parentWindow must be unique")}_.each(targetElements,function(targetElement){WindowManager.registerContainer(targetElement);$j(targetElement).find("div").each(function(i,windowElement){WindowManager.registerWindow(ns.dataset(windowElement).windowName,new SlideupWindow(windowElement))})})},SlideupWindowManager:WindowManager})});Namespace("jp.co.mixi.ui.slideupwindow.statemanager").use("jp.co.mixi.ui.slideupwindow *").define(function(ns){var BaseState=function(){var Klass=function(templateId){this.templateId=templateId;this.stage=$(this.templateId);this.manager=null};(function(){this.show=function(){this.stage.show()};this.afterShow=function(windowManager){};this.hide=function(){this.stage.hide()};this.afterClose=function(){};this.setManager=function(manager){this.manager=manager};this.getManager=function(){return this.manager};this.close=function(){this.getManager().hide()};this.setParams=function(params){}}).apply(Klass.prototype);return Klass}();var WindowStateManager=function(){var Klass=function(windowId,states,initStateName){this.windowId=windowId;this.windowName=$D($(windowId)).windowName;this.states=states;Object.keys(this.states).forEach(function(key){this.states[key].setManager(this)}.bind(this));this.currentStateName=initStateName;this.initStateName=initStateName;this.isShow=false};(function(){this.show=function(){this.getCurrentState().show();var windowEle=$(this.windowId);windowEle.style.position="absolute";ns.SlideupWindowManager.open(this.windowName,function(windowManager){windowEle.style.webkitTransform="";this.isShow=true;windowEle.style.position="static";this.getCurrentState().afterShow(windowManager)}.bind(this))};this.hide=function(){if(!this.isShow){throw"This window hasn't been shown!"}$(this.windowId).style.position="absolute";ns.SlideupWindowManager.close(function(WindowManager){Object.keys(this.states).forEach(function(key){this.states[key].afterClose();this.states[key].hide()}.bind(this));this.isShow=false;this.currentStateName=this.initStateName}.bind(this))};this.showState=function(stateName,params){if(!this.isShow){throw"This window hasn't been shown!"}if(this.states[stateName]==null){throw"no such state:"+stateName}else{this.getCurrentState().hide();this.currentStateName=stateName;setTimeout(function(){window.scrollTo(0,1)},100);this.getCurrentState().setParams(params);this.getCurrentState().show();this.getCurrentState().afterShow(ns.SlideupWindowManager)}};this.getCurrentState=function(){if(this.currentStateName==null){throw"no state is set"}return this.states[this.currentStateName]}}).apply(Klass.prototype);return Klass}();ns.provide({BaseState:BaseState,WindowStateManager:WindowStateManager})});Namespace("jp.co.mixi.ui.statemanager").define(function(ns){var StateManager=function(){var Klass=function(states){this.states=states;this.num;this.id};(function(){this.setStates=function(newStates){this.states=newStates;this.keys=newStates.map(function(state){return Object.keys(state)[0]});this.map={};newStates.forEach(function(state){var key=Object.keys(state)[0];this.map[key]=state[key]}.bind(this));this.changeState(0)};this.keySet=function(){return this.keys};this.id2Number=function(id){var num;for(var i=0;i<this.keys.length;i++){if(this.keys[i]==id){num=i}}return num};this.changeState=function(num){if(typeof num==="string"){num=this.id2Number(num)}if(typeof num==="undefined"){return undefined}var id=this.keys[num];if(!this.map[id]){return undefined}setTimeout(function(){window.scrollTo(0,1)},100);this.keys.forEach(function(key){this.map[key].hide()}.bind(this));this.map[id].show();this.num=num;this.id=id;return id};this.next=function(){return this.changeState(this.num+1)};this.prev=function(){return this.changeState(this.num-1)};this.stateId=function(){return this.id};this.stateNumber=function(){return this.num}}).apply(Klass.prototype);return Klass}();var EmptyState=function(){var Klass=function(id,param){this.id=id;this.param=param;this.element={stage:$(id)}};(function(){this.show=function(){this.element.stage.show()};this.hide=function(){this.element.stage.hide()}}).apply(Klass.prototype);return Klass}();ns.provide({StateManager:StateManager,EmptyState:EmptyState})});Namespace("jp.co.mixi.ui.staticwindowmanager").define(function(ns){"use strict";var StaticWindowManager=function(){var Klass=function(element){this.element=element};(function(){this.getCurrentElement=function(){return this.element}}).apply(Klass.prototype);return Klass}();ns.provide({StaticWindowManager:StaticWindowManager})});Namespace("jp.co.mixi.ui.tab").define(function(ns){var searchParentTag=function(tag,element){return!element?undefined:element.tagName==tag?element:arguments.callee(tag,element.parentNode)};var Tab=function(){var Klass=function(element){this.element=element;this.data=$D(element);this.menuElements=$A(element.querySelectorAll(this.data.menuQuery||undefined));this.bodyElements=$A(element.querySelectorAll(this.data.bodyQuery||undefined));this.events={click:this.onClick.bind(this)};this.attach()};(function(){this.attach=function(){this.menuElements.forEach(function(element){element.addEventListener("click",this.events.click,false)}.bind(this))};this.detach=function(){this.menuElements.forEach(function(element){element.removeEventListener("click",this.events.click,false)}.bind(this))};this.onClick=function(e){var target=searchParentTag("A",e.target);var selectClass=this.data.menuSelectClass;this.menuElements.forEach(function(element){element.classList.remove(selectClass)});target.classList.add(selectClass);this.bodyElements.forEach(function(element){element.hide()});var bodyId=$D(target).tabBodyId;$(bodyId).show()}}).apply(Klass.prototype);return Klass}();ns.provide({Tab:Tab,registerElement:function(element){new Tab(element)}})});Namespace("jp.co.mixi.ui.template").use("jp.co.mixi.lang.string *").use("brook.view.htmltemplate HTMLTemplate").define(function(ns){var HTMLTemplate=ns.HTMLTemplate;var _linkableString=function(str){if(!str||str.length==0){return"__"}return str};HTMLTemplate.registerFunction("html_escape",ns.escapeHTML);HTMLTemplate.registerFunction("lf_to_br",ns.lineFeedToBreak);HTMLTemplate.registerFunction("html",ns.tuneHtml);HTMLTemplate.registerFunction("form",ns.tuneForm);HTMLTemplate.registerFunction("textarea",ns.tuneTextarea);HTMLTemplate.registerFunction("fold_text",ns.foldText);HTMLTemplate.registerFunction("snip_text",ns.snipText);HTMLTemplate.registerFunction("format_date",ns.formatDate);HTMLTemplate.registerFunction("format_datetime",ns.formatDatetime);HTMLTemplate.registerFunction("create_url",ns.createUrl);HTMLTemplate.registerFunction("linkable_string",_linkableString);var emptyFunction=function(){};("create_help_item_url create_help_category_url "+"create_mixi_url create_photo_mixi_url create_news_mixi_url").split(/\s/).forEach(function(name){HTMLTemplate.registerFunction(name,emptyFunction)});var _autoParameter=function(template){if(!window.Mixi){return template}template.param(Mixi.Gateway.getParam());return template};var getTemplateByElementId=function(elementId){var template=HTMLTemplate.getByElementId(elementId);if(!template){throw"cannot find template:"+elementId}return _autoParameter(template)};var getTemplateBySource=function(source){var template=HTMLTemplate.get(source);return _autoParameter(template)};ns.provide({getTemplateByElementId:getTemplateByElementId,getTemplateBySource:getTemplateBySource})});Namespace("jp.co.mixi.ui.textarea").use("brook.dom.compat dataset").use("jp.co.mixi.lang.class defineClass").define(function(ns){var TextArea=ns.defineClass({initialize:function(element,dataset){this.jElement=$j(element);this.element=element;this.placeholder=dataset.placeholder;this.placeholderClass=dataset.placeholderClass;var onBlur=_.bind(this.onBlur,this);var onFocus=_.bind(this.onFocus,this);this.jElement.blur(onBlur);this.jElement.focus(onFocus);if(this.jElement.parents("form")){this.jElement.parents("form").submit(_.bind(onFocus,this))}onBlur()},hasValue:function(){return this.jElement.val()!==""},isHolded:function(){return this.jElement.val()==this.placeholder},isInputted:function(){if(!this.placeholder){return this.jElement.val()!==""}return this.jElement.val()!==""&&this.jElement.val()!==this.placeholder},setValue:function(v){this.element.val(v)},onBlur:function(){if(this.hasValue()){return}this.jElement.val(this.placeholder);if(this.placeholderClass){this.jElement.addClass(this.placeholderClass)}},onFocus:function(){if(!this.isHolded()){return}this.jElement.val("");this.clearPlaceholderStyle()},clearPlaceholderStyle:function(){if(this.placeholderClass){this.jElement.removeClass(this.placeholderClass)}},reset:function(){this.jElement.val(this.placeholder);if(this.placeholderClass){this.jElement.addClass(this.placeholderClass)}}});ns.provide({registerElement:function(element,dataset){return new TextArea(element,dataset)},TextArea:function(element){var dataset=ns.dataset(element);return new TextArea(element,dataset)}})});Namespace("jp.co.mixi.ui.textarea.autoresize").use("jp.co.mixi.lang parseIntAsDecimal").use("jp.co.mixi.lang.class defineClass").define(function(ns){var _autoResize;var AutoResize=ns.defineClass({initialize:function(element,dataset){this.element=element;this.dataset=dataset;this.defaultHeight=ns.parseIntAsDecimal(this.element.offsetHeight);this.additionalHeight="additionalHeight"in dataset?Number(dataset.additionalHeight):0;if(this.element.scrollHeight){this.resize()}$j(this.element).on("keydown",_.bind(this.resize,this));$j(this.element).on("keyup",_.bind(this.resize,this));$j(this.element).on("mouseout",_.bind(this.resize,this))},resize:function(){if(this.dataset.maxHeight&&$j(this.element).height()>=this.dataset.maxHeight){$j(this.element).css("overflow-y","scroll");return}if(ns.parseIntAsDecimal(this.element.scrollHeight)>ns.parseIntAsDecimal(this.element.offsetHeight)){this.element.style.height=ns.parseIntAsDecimal(this.element.scrollHeight)+this.additionalHeight+"px"}if(ns.parseIntAsDecimal(this.element.scrollHeight)>ns.parseIntAsDecimal(this.dataset.maxHeight)){this.element.style.height=ns.parseIntAsDecimal(this.dataset.maxHeight)+"px"}},resetSize:function(){this.element.style.height=this.defaultHeight+"px"}});ns.provide({registerElement:function(element,dataset){_autoResize=new AutoResize(element,dataset)},resetSize:function(){_autoResize.resetSize()}})});Namespace("jp.co.mixi.ui.textarea.watcher").use("jp.co.mixi.dom.event observeEvent").define(function(ns){var INTERVAL=100;var Watcher=function(interval){this.timerIds=[];this.interval=interval||INTERVAL};Watcher.prototype.start=function(handler){var timerId=setInterval(handler,this.interval);this.timerIds.push(timerId);return timerId};Watcher.prototype.stop=function(timerId){if(timerId){clearInterval(timerId)}else{this.timerIds.forEach(function(timerId){clearInterval(timerId)});this.timerIds=[]}};Watcher.prototype.register=function(textarea,handler){this.registerHandler(textarea,handler)};Watcher.prototype.registerHandler=function(textarea,handler){var _self=this;ns.observeEvent(textarea,"focus",function(evt){var timerId=_self.start(handler);ns.observeEvent(textarea,"blur",function(evt){_self.stop(timerId)})})};ns.provide({createTextareaWatcher:function(interval){return new Watcher(interval)}})});Namespace("jp.co.mixi.ui.textareawithplaceholder").define(function(ns){var _placeholderClass;var _defaultText;var _modifyClass=function(element,method,classElement){if(!classElement)return;$j(element)[method](classElement)};var initializePlaceholder=function(element){_placeholderClass=$j(element).attr("data-placeholder-class");_defaultText="defaultText";var activatePlaceholder=function(){$j(element).val($j(element).attr("data-placeholder"));_modifyClass(element,"addClass",_placeholderClass);_modifyClass(element,"addClass",_defaultText)};var initialize=function(){var _placeholder=$j(element).attr("data-placeholder");if($j(element).val()===""||$j(element).val()===_placeholder){activatePlaceholder()}else{_modifyClass(element,"removeClass",_placeholderClass);_modifyClass(element,"removeClass",_defaultText)}};$j(element).on("focus",function(){setTimeout(function(){clearTextarea(element)},100);_modifyClass(element,"removeClass",_placeholderClass);_modifyClass(element,"removeClass",_defaultText)});$j(element).on("blur",function(){var _placeholder=$j(element).attr("data-placeholder");if($j(element).val()===""||$j(element).val()===_placeholder){activatePlaceholder()}});$j(window).ready(initialize);initialize()};var updatePlaceholder=function(element,v){if(!_.isString(v))return;if($j(element).val()===$j(element).attr("data-placeholder")){$j(element).val(v)}$j(element).attr("data-placeholder",v)};var clearTextarea=function(element){if($j(element).val()===$j(element).attr("data-placeholder")){$j(element).val("")}};ns.provide({initializePlaceholder:initializePlaceholder,updatePlaceholder:updatePlaceholder,clearTextarea:clearTextarea})});Namespace("jp.co.mixi.ui.widget").use("brook.widget *").define(function(ns){ns.provide({bindAllWidget:ns.bindAllWidget,callByClassName:function(className){ns.bindAllWidget.run(className)}})});Namespace("jp.co.mixi.ui.widget.formpreview").use("jp.co.mixi.ui.template getTemplateByElementId").define(function(ns){"use strict";var DEFAULT_WAIT=1e3;var createFormPreview=function(element,dataset){var root=$j(element);var form=dataset.formSelector?root.find(dataset.formSelector):root;var preview=root.find(dataset.previewSelector);var wait=dataset.wait||DEFAULT_WAIT;var isPreviewUpdateQueued=false;var updatePreview=function(){isPreviewUpdateQueued=false;var param={};_.each(form.serializeArray(),function(pair){param[pair.name]=pair.value});var template=ns.getTemplateByElementId(dataset.templateId);template.param(param);preview.html(template.output())};var debounceUpdatePreview=_.debounce(function(){if(!isPreviewUpdateQueued)return;updatePreview()},wait);var enqueueUpdatePreview=function(){isPreviewUpdateQueued=true;preview.html("");debounceUpdatePreview()};form.on("change reset",updatePreview);form.on("input keyup cut paste",enqueueUpdatePreview);_.defer(updatePreview)};ns.provide({registerElement:createFormPreview})});Namespace("jp.co.mixi.ui.widget.hashtab").use("brook.dom.compat dataset").define(function(ns){"use strict";var createHashTab=function(container,options){var tabItemSelector=options.tabItemSelector||"li";var activeClass=options.activeTabClass||"active";var useLocationReplace=options.useLocationReplace==="true";var tabItems=container.find(tabItemSelector);var clickHandler=function(e){var locator=$j(this);var dataHref=ns.dataset(locator.get(0)).href;if(useLocationReplace){var linkHref=locator.attr("href");if(linkHref)e.preventDefault();var href=dataHref||linkHref;if(href)location.replace(href)}else if(dataHref){location.hash=dataHref}};container.on("click","a[href], [data-href]",clickHandler);var hashChangeHandler=function(){tabItems.removeClass(activeClass);var hash=location.hash;var selector='[href="'+hash+'"], '+'[data-href="'+hash+'"], '+'[data-href-aliases~="'+hash+'"]';tabItems.filter(selector).addClass(activeClass);hasSelector(tabItems,selector).addClass(activeClass)};$j(window).on("hashchange",hashChangeHandler);var hasSelector=function(collection,selector){var domList=[];collection.each(function(i,dom){if($j(dom).find(selector).length){domList.push(dom)}});return $j(domList)};hashChangeHandler()};ns.provide({registerElement:function(domElement,dataset){createHashTab($j(domElement),dataset)}})});Namespace("jp.co.mixi.ui.widget.historyback").define(function(ns){"use strict";var registerElement=function(element){$j(element).click(function(evt){history.back()})};ns.provide({registerElement:registerElement})});Namespace("jp.co.mixi.ui.widget.iframespinner").define(function(ns){"use strict";var registerElement=function(element,dataset){var loading=$j(element).find(dataset.loadingClass);var iframe=$j(element).find(dataset.iframeClass);iframe.hide();iframe.on("load",function(){iframe.show();loading.hide()});iframe.attr("src",dataset.iframeSrc)};ns.provide({registerElement:registerElement})});Namespace("jp.co.mixi.ui.widget.onetimesubmitform").define(function(ns){ns.provide({registerElement:function(element,dataset){var submitButton=$j(element).find(dataset.oneTimeSubmitButtonClass);submitButton.removeAttr("disabled");$j(element).submit(function(){submitButton.attr("disabled","disabled")})}})});Namespace("jp.co.mixi.ui.widget.partialpageloader").use("brook.util through").use("brook.widget bindAllWidget").use("brook.channel observeChannel").use("jp.co.mixi.asserting assertString").define(function(ns){"use strict";var load=function(element,dataset){ns.assertString(dataset.url);var target=dataset.url;if(dataset.selector){target=target+" "+dataset.selector}$j(element).load(target,function(){ns.bindAllWidget.run()})};ns.provide({registerElement:function(element,dataset){var loadOnce=_.once(function(){load(element,dataset)});if(!dataset.observeChannel&&!dataset.observeHashfragment){loadOnce();return}if(dataset.observeChannel){var channels=dataset.observeChannel.split(" ");_.each(channels,function(channelName){ns.observeChannel(channelName,ns.through(loadOnce))})}if(dataset.observeHashfragment){var loadByHashFragment=function(){if(location.hash===dataset.observeHashfragment){loadOnce()}};loadByHashFragment();window.addEventListener("hashchange",loadByHashFragment)}}})});Namespace("jp.co.mixi.ui.widget.placeholderhelper").use("jp.co.mixi.logging Log").define(function(ns){"use strict";var POLLING_INTERVAL=1e3;var pollingQueue=[];var startPolling=_.once(function(){setInterval(function(){_.each(pollingQueue,function(cb){cb()})},POLLING_INTERVAL)});var detectListenerType=function(){var inputTag=$j('<input type="text" />')[0];var safariVersion=$j.browser.safari?parseFloat($j.browser.version,10):undefined;if($j.browser.ie&&parseInt($j.browser.version,10)===9)return"IE9";if(safariVersion&&safariVersion>3.1&&safariVersion<5)return"oldSafari";if(safariVersion&&safariVersion<3.1)return"fallback";if("oninput"in inputTag)return"input";if("onpropertychange"in inputTag)return"oldIE";return"fallback"};var getListenerType=_.once(function(){var type=detectListenerType();ns.Log.info(ns.CURRENT_NAMESPACE+": initialized with "+type+" listener");return type});var createPlaceHolderHelper=function(element,dataset){var jElement=$j(element);var inputAreaSel=dataset.inputAreaSelector||".inputArea";var placeholderSel=dataset.placeholderSelector||".coverText";var inputArea=jElement.find(inputAreaSel);var placeholder=jElement.find(placeholderSel);var classReceiver=dataset.classReceiver==="input"?inputArea:jElement;var filledClass=dataset.filledClass||"filled";if(inputArea.length===0){ns.Log.error("inputArea element for placeholderhelper is not found!")}if(placeholder.length===0){ns.Log.error("placeholder element which is required by placeholderhelper for keeping from IE8 bug is not found!")}var isClassAdded=false;var onChangeHandler=function(){var shouldAdded=inputArea[0].value.length>0;if(!isClassAdded&&shouldAdded){classReceiver.addClass(filledClass);isClassAdded=true}else if(isClassAdded&&!shouldAdded){classReceiver.removeClass(filledClass);isClassAdded=false}};switch(getListenerType()){case"input":inputArea.on("input",onChangeHandler);break;case"oldSafari":inputArea.on("textInput",onChangeHandler);break;case"IE9":inputArea.on("input selectionchange",onChangeHandler);break;case"oldIE":var previousValue=inputArea.val();inputArea.on("propertychange",function(e){var currentValue=inputArea.val();if(currentValue!==previousValue){_.defer(onChangeHandler);previousValue=currentValue}});placeholder.on("mousedown",function(){_.defer(function(){inputArea.focus()})});break;default:inputArea.on("change keyup cut paste",onChangeHandler)}pollingQueue.push(onChangeHandler);startPolling();onChangeHandler()};ns.provide({registerElement:function(element,dataset){createPlaceHolderHelper(element,dataset)}})});Namespace("jp.co.mixi.ui.widget.shortcut").use("brook promise").use("brook.util through,from").use("jp.co.mixi.event observeEvent").use("jp.co.mixi.lang.class defineClass").use("jp.co.mixi.nativeproxy createNativeProxyPromise,onStartNativeProxy").use("jp.co.mixi.device.checker isAndroid").define(function(ns){var IMPLEMENT_SHORTCUT_CLIENT_VERSION=58;var WebViewShortcut=ns.defineClass({initialize:function(element,dataset){this.element=element;this.dataset=dataset;this.uri=this.dataset.uri;this.label=this.dataset.label;this.icon=this.dataset.icon;this._observeEvent();var _self=this;ns.onStartNativeProxy(ns.from({}).bind(ns.createNativeProxyPromise("jp.mixi.application.info.get")).bind(ns.through(function(value){try{if(!_self._isShortcutMakingSupported(value.response.result))return;$j(_self.element).show()}catch(e){}})))},_isShortcutMakingSupported:function(result){var isSupported=result.is_shortcut_making_supported;var version=result.version;if(isSupported===undefined){return ns.isAndroid()&&version>=IMPLEMENT_SHORTCUT_CLIENT_VERSION?true:false}return!!isSupported},_observeEvent:function(){var _self=this;ns.observeEvent(this.element,"click",ns.promise().bind(function(next,value){ns.createNativeProxyPromise("jp.mixi.webview.shortcut.create").run({uri:_self.uri,icon:_self.icon,label:_self.label})}))}});ns.provide({registerElement:function(element,dataset){new WebViewShortcut(element,dataset)}})});Namespace("jp.co.mixi.ui.widget.util").define(function(ns){var isEnabled=function(element){var target=element instanceof $j?element:$j(element);return target.parents().find("body").length>0};ns.provide({isEnabled:isEnabled})});Namespace("jp.co.mixi.ui.widget.youtubeplayer").define(function(ns){var tag=document.createElement("script");tag.src="https://www.youtube.com/iframe_api";tag.async=true;var bodyTag=document.getElementsByTagName("body")[0];bodyTag.insertAdjacentElement("beforeend",tag);var enablePlayerName;var readiness=false;var players=new Map;var queue=[];window.onYouTubeIframeAPIReady=function(){readiness=true;consume(queue)};var consume=function(list){while(list.length>0){list.shift().apply()}};var registerElement=function(element,dataset){var playerName=dataset.playerName;var videoId=dataset.videoId;var height=dataset.height;var width=dataset.width;queue.push(function(){var player=new YT.Player(playerName,{height:height,width:width,videoId:videoId,events:{onReady:onReady,onStateChange:onStateChange},playerVars:{origin:window.location.origin}})});var onReady=function(event){players.set(playerName,event.target)};var onStateChange=function(event){var e_1,_a;if(event.data===YT.PlayerState.PLAYING){enablePlayerName=playerName;try{for(var players_1=__values(players),players_1_1=players_1.next();!players_1_1.done;players_1_1=players_1.next()){var _b=__read(players_1_1.value,2),name_1=_b[0],player=_b[1];if(name_1!==enablePlayerName){player.stopVideo()}}}catch(e_1_1){e_1={error:e_1_1}}finally{try{if(players_1_1&&!players_1_1.done&&(_a=players_1.return))_a.call(players_1)}finally{if(e_1)throw e_1.error}}}};if(readiness)consume(queue)};ns.provide({registerElement:registerElement})});Namespace("jp.co.mixi.validator").use("jp.co.mixi.lang.string isEmpty").use("jp.co.mixi.lang.string countByteLength").define(function(ns){var MULTIBYTE_LENGTH=2;var validate=function(validateData){var error={messages:[],isValid:true};var methodOf={NOT_EMPTY:function(text){if(ns.isEmpty(text)){error.isValid=false}},MAX_CHAR_LENGTH:function(text,maxCount){if(_isOverMaxCharLength(text,maxCount)){error.messages.push(text.length-maxCount+"文字オーバーしています");error.isValid=false}},MAX_BYTE_LENGTH:function(text,maxCount){if(_isOverMaxByteLength(text,maxCount)){error.messages.push(Math.ceil((ns.countByteLength(text,MULTIBYTE_LENGTH)-maxCount)/2)+"文字オーバーしています");error.isValid=false}}};_.each(validateData.rules,function(rule){if(_.isObject(rule)){methodOf[_.keys(rule)](validateData.value,_.values(rule))}else{methodOf[rule](validateData.value)}});return error};var _isOverMaxCharLength=function(text,maxCount){if(text.length>maxCount){return true}return false};var _isOverMaxByteLength=function(text,maxCount){if(ns.countByteLength(text,MULTIBYTE_LENGTH)>maxCount){return true}return false};ns.provide({validate:validate})});Namespace("jp.co.mixi.widget.button.sendchannelbutton").use("jp.co.mixi.lang.class defineClass").use("brook.channel sendChannel").define(function(ns){"use strict";var SendChannelButtonWidget=ns.defineClass({initialize:function(element,dataset){this._jElement=$j(element);this._jElement.on("click",function(){ns.sendChannel(dataset.sendChannelId).run()})}});ns.provide({registerElement:function(element,dataset){return new SendChannelButtonWidget(element,dataset)}})});Namespace("jp.co.mixi.widget.confirmonclick").define(function(ns){"use strict";var init=function(element,dataset){var $element=$j(element);var confirmMessage=dataset.confirmMessage;$element.on("click",function(e){return window.confirm(confirmMessage)})};ns.provide({registerElement:init})});Namespace("jp.co.mixi.widget.linkblock").use("jp.co.mixi.logging Log").define(function(ns){"use strict";ns.provide({registerElement:function(element,dataset){if(!dataset.url){ns.Log.warn("'data-url' attribute is missing");return}var $root=$j(element);$root.on("click",function(){location.href=dataset.url});$root.find("a, input, textarea").on("click",function(e){e.stopPropagation()})}})});Namespace("jp.co.mixi.widget.openwindow").define(function(ns){"use strict";ns.provide({registerElement:function(element,dataset){if(!dataset.url)throw new Error("data-url required");if(!dataset.windowName)throw new Error("data-window-name required");$j(element).on("click",function(){window.open(dataset.url,dataset.windowName,dataset.features||"");return false})}})});Namespace("jp.co.mixi.widget.popup.modalwindow").use("jp.co.mixi.ui.modalwindow createModalWindow").define(function(ns){"use strict";ns.provide({registerElement:function(element,dataset){return ns.createModalWindow(element,dataset)}})});Namespace("jp.co.mixi.widget.popup.popupbox").use("jp.co.mixi.ui.popup PopupBox").define(function(ns){"use strict";ns.provide({registerElement:function(element,dataset){return new ns.PopupBox(element,dataset)}})});Namespace("jp.co.mixi.widget.popup.popuplayer").use("jp.co.mixi.ui.popup PopupLayer").define(function(ns){"use strict";ns.provide({registerElement:function(element,dataset){return new ns.PopupLayer(element,dataset)}})});Namespace("jp.co.mixi.widget.scrolltop").define(function(ns){"use strict";var TOPY=1;ns.provide({registerElement:function(element){$j(element).on("click",function(e){window.scrollTo(0,TOPY)})}})});