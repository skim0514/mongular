Namespace("jp.mixi.adnetwork.anchor.footerspacer").use("jp.mixi.adnetwork.ui.touch.page enableAnchor").define(function(ns){"use strict";var registerElement=function(element,dataset){ns.enableAnchor(dataset.pageAddClass)};ns.provide({registerElement:registerElement})});Namespace("jp.mixi.adnetwork.anchor.visibilitycontroller").define(function(ns){"use strict";var WAIT_TIME_MSEC=100;var registerElement=function(element,dataset){var anchor=$j(element).find(".anchor");var target='textarea, input[type="text"], select';$j(document.body).on("click",target,function(){anchor.hide()});$j(document.body).on("blur",target,function(){setTimeout(showAnchor,WAIT_TIME_MSEC)});var showAnchor=function(){anchor.show()}};ns.provide({registerElement:registerElement})});Namespace("jp.mixi.adnetwork.google.adexchange.ui.readmore").use("brook.widget bindAllWidget").use("brook.util through").use("jp.co.mixi.lang.class defineClass").use("jp.co.mixi.ui.template getTemplateByElementId").define(function(ns){"use strict";var adCount=0;var MAX_AD_COUNT=2;var AdInserter=ns.defineClass({initialize:function(args){this.templateId=args.templateId;this.jContentContainer=args.jContentContainer;this.commentListSelector=args.commentListSelector;this.buttonType=args.buttonType;this.buttonTypePrevious=args.buttonTypePrevious;var template=ns.getTemplateByElementId(this.templateId);this.adHtml=template.output();if(!this.adHtml)return;this.insertAd=ns.through(_.bind(this._insertAd,this))},_insertAd:function(v){if(adCount>=MAX_AD_COUNT)return;var result=v.response.result;if(!result)return;var readCommentCount=result.content.length;if(readCommentCount===0)return;var target;var commentList=this.jContentContainer.find(this.commentListSelector);if(this.buttonType===this.buttonTypePrevious){target=commentList[readCommentCount]}else{target=commentList[commentList.length-readCommentCount]}$j(target).before(this.adHtml);ns.bindAllWidget.run();adCount++}});ns.provide({createAdInserter:function(args){return new AdInserter(args)}})});Namespace("jp.mixi.adnetwork.google.adsense.widget.loadasyncscript").use("jp.mixi.adnetwork.google.model.adexchange getModel").define(function(ns){"use strict";var registerElement=function(element,dataset){var ins=$j(element).find(".adsbygoogle")[0];var adx=ns.getModel();adx.notify("add").run({element:element,param:{element:ins}})};ns.provide({registerElement:registerElement})});Namespace("jp.mixi.adnetwork.google.dfp.anchor.widget.closablecontainer").define(function(ns){"use strict";var registerElement=function(element,dataset){var $element=$j(element);var $anchorCloseButton=$element.find(dataset.anchorCloseButton);$anchorCloseButton.on("click",function(){$element.hide()})};ns.provide({registerElement:registerElement})});Namespace("jp.mixi.adnetwork.google.dfp.widget").use("jp.mixi.adnetwork.google.model.dfp loadDfpScript,prepareApsSlot,preparePrebidSlot").use("jp.mixi.adnetwork.google.model.dfp.slot.builder SlotBuilder").define(function(ns){"use strict";window.googletag=window.googletag||{};var googletag=window.googletag;googletag.cmd=googletag.cmd||[];var registerElement=function(element,dataset){ns.loadDfpScript(element);if(dataset.isLazyLoad){var wait=500;var $window=$j(window);var threshold=$j(element).offset().top-$window.height();var listener=_.throttle(function(){if(threshold<=$window.scrollTop()){displaySlot(element,dataset);$window.off("scroll",listener)}},wait);$window.on("scroll",listener);listener()}else{displaySlot(element,dataset)}};var displaySlot=function(element,dataset){var slotBuilder=new ns.SlotBuilder(element,dataset);var slotElementId=slotBuilder.getAdSlot();var slotPath=slotBuilder.getClientId();var slotSize=slotBuilder.getSize();googletag.cmd.push(function(){slotBuilder.build()});var isApsEnabled=dataset.isAmazonHeaderBiddingEnabled;var amazonSlotName=dataset.amazonHeaderBiddingSlotName;var prebidParamsJSON=dataset.prebidHeaderBiddingParamsJson;var usePrebidOldVersion=dataset.usePrebidOldVersion?true:false;var isPrebidEnabled=prebidParamsJSON?true:false;var isPrebidReady=false;var isApsReady=false;if(isPrebidEnabled||isApsEnabled){if(isPrebidEnabled){ns.preparePrebidSlot(element,JSON.parse(prebidParamsJSON),usePrebidOldVersion,function(){isPrebidReady=true;if(!isApsEnabled||isApsReady){googletag.cmd.push(function(){googletag.display(slotElementId)})}})}if(isApsEnabled){ns.prepareApsSlot(slotElementId,amazonSlotName,slotSize,function(){isApsReady=true;if(!isPrebidEnabled||isPrebidReady){googletag.cmd.push(function(){googletag.display(slotElementId)})}})}}else{googletag.cmd.push(function(){googletag.display(slotElementId)})}};ns.provide({registerElement:registerElement})});Namespace("jp.mixi.adnetwork.google.model.adexchange").use("brook promise").use("brook.util through").use("brook.model createModel").define(function(ns){"use strict";var model;var loadScript=ns.through(_.once(function(value){var script=document.createElement("script");script.src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js";script.async=true;value.element.appendChild(script)}));var addParam=ns.through(function(value){(window.adsbygoogle=window.adsbygoogle||[]).push(value.param)});var getModel=function(){if(model)return model;model=ns.createModel({add:ns.promise().bind(loadScript,addParam)});return model};ns.provide({getModel:getModel})});Namespace("jp.mixi.adnetwork.google.model.dfp").use("jp.mixi.adnetwork.script.loader getScriptLoader").define(function(ns){"use strict";var DFP_SCRIPT="//securepubads.g.doubleclick.net/tag/js/gpt.js";var isLoaded=false;var isApsLoaded=false;var isPrebidLoaded=false;var setIsLoaded=function(flag){isLoaded=flag};var loadDfpScript=function(element){if(isLoaded)return;if(!_.isElement(element)){throw new Error("element is required")}var scriptLoader=ns.getScriptLoader();scriptLoader.load(DFP_SCRIPT,element);isLoaded=true};var prepareApsSlot=function(slotId,amazonSlotName,sizes,onReady){if(!isApsLoaded){!function(a9,a,p,s,t,A,g){if(a[a9])return;function q(c,r){a[a9]._Q.push([c,r])}a[a9]={init:function(){q("i",arguments)},fetchBids:function(){q("f",arguments)},setDisplayBids:function(){},targetingKeys:function(){return[]},_Q:[]};A=p.createElement(s);A.async=!0;A.src=t;g=p.getElementsByTagName(s)[0];g.parentNode.insertBefore(A,g)}("apstag",window,document,"script","//c.amazon-adsystem.com/aax2/apstag.js");apstag.init({pubID:"138f2e02-8341-4255-b4f3-872c3ced0f91",adServer:"googletag"});isApsLoaded=true}apstag.fetchBids({slots:[{slotID:slotId,slotName:amazonSlotName,sizes:sizes}],timeout:2e3},function(bids){googletag.cmd.push(function(){apstag.setDisplayBids();onReady()})})};var preparePrebidSlot=function(element,prebidParams,usePrebidOldVersion,onReady){var slotId=element.id;if(!isPrebidLoaded){var scriptLoader=ns.getScriptLoader();if(usePrebidOldVersion){scriptLoader.load("https://external-script.mixi.net/adnetwork/prebid/prebid-2.44.4-20200820.js",element)}else{scriptLoader.load("https://external-script.mixi.net/adnetwork/prebid/prebid-4.5.0-20210114.js",element)}isPrebidLoaded=true}var adUnits=[];for(var size in prebidParams){if({}.hasOwnProperty.call(prebidParams,size)){var sizeXY=size.split("x");adUnits.push({code:slotId,mediaTypes:{banner:{sizes:[parseInt(sizeXY[0]),parseInt(sizeXY[1])]}},bids:prebidParams[size]})}}var PREBID_TIMEOUT=1e3;window.pbjs=window.pbjs||{};var pbjs=window.pbjs;pbjs.que=pbjs.que||[];pbjs.que.push(function(){var customGranularity={buckets:[{min:0,max:2e3,increment:.1}]};pbjs.enableAnalytics([{options:{endpoint:"https://prebid-a.rubiconproject.com/event",accountId:12046},provider:"rubicon"}]);pbjs.setConfig({priceGranularity:customGranularity,userSync:{filterSettings:{iframe:{bidders:"*",filter:"include"}}},currency:{adServerCurrency:"JPY",conversionRateFile:"https://currency.prebid.org/latest.json",bidderCurrencyDefault:{yieldone:"JPY",rubicon:"USD",pubmatic:"USD",aja:"USD"},defaultRates:{USD:{JPY:100}}}});pbjs.bidderSettings={pubmatic:{bidCpmAdjustment:function(bidCpm){return bidCpm*.9}}};pbjs.requestBids({adUnits:adUnits,bidsBackHandler:initAdserver})});var initAdserverSet=false;function initAdserver(){if(initAdserverSet)return;initAdserverSet=true;googletag.cmd.push(function(){pbjs.que.push(function(){pbjs.setTargetingForGPTAsync([slotId]);onReady()})})}setTimeout(function(){initAdserver()},PREBID_TIMEOUT)};ns.provide({loadDfpScript:loadDfpScript,prepareApsSlot:prepareApsSlot,preparePrebidSlot:preparePrebidSlot,setIsLoaded:setIsLoaded})});Namespace("jp.mixi.adnetwork.google.model.dfp.slot.builder").use("jp.co.mixi.lang.class defineClass").use("jp.co.mixi.lang.string toQueryParams").define(function(ns){"use strict";var AD_THRESHOLD_WIDTH=342;var AD_SLOT_ID_SEPARATOR="-";var adSlotIdCounter={};var SlotBuilder=ns.defineClass({initialize:function(element,dataset,googletag){this.element=element;this.dataset=dataset;this.googletag=typeof googletag==="undefined"?window.googletag:googletag;this.isResponsible=!!parseInt(this.dataset.isResponsible,10);this.isMultiSizeResponsible=!!parseInt(this.dataset.isMultiSizeResponsible,10);this.useSequentialSlotId=!!parseInt(this.dataset.useSequentialSlotId,10);this.isFluid=!!parseInt(this.dataset.isFluid,10)},collapseEmptyDiv:function(){return typeof this.dataset.collapseEmptyDiv==="undefined"?true:!!parseInt(this.dataset.collapseEmptyDiv,10)},getClientId:function(){return"/"+this.dataset.adClient+"/"+this.dataset.adChannel},getAdSlot:function(){if(typeof this._adSlot!=="undefined"){return this._adSlot}if(this.useSequentialSlotId){if(typeof adSlotIdCounter[this.dataset.adSlot]==="undefined"){adSlotIdCounter[this.dataset.adSlot]=0}adSlotIdCounter[this.dataset.adSlot]++;this._adSlot=this.dataset.adSlot+AD_SLOT_ID_SEPARATOR+adSlotIdCounter[this.dataset.adSlot];this.element.id=this._adSlot}else{this._adSlot=this.dataset.adSlot}return this._adSlot},getMultiSizeArray:function(sizes){var sizeArray=sizes.split(",");return _.map(sizeArray,function(value,index,array){var wh=value.split("x").map(function(item){return parseInt(item,10)});if(wh[0]==0){return"fluid"}return wh})},getSize:function(){if(this.dataset.imageSize){return this.getMultiSizeArray(this.dataset.imageSize)}return[parseInt(this.dataset.adWidth,10),parseInt(this.dataset.adHeight,10)]},defaultAdSlot:function(){var clientId=this.getClientId();var size=this.getSize();return this.googletag.defineSlot(clientId,size,this.getAdSlot())},responsibleAdSlot:function(){var clientId=this.getClientId();var parsedAdMinWidth=parseInt(this.dataset.adMinWidth,10);var parsedAdMinHeight=parseInt(this.dataset.adMinHeight,10);var parsedAdMaxWidth=parseInt(this.dataset.adMaxWidth,10);var parsedAdMaxHeight=parseInt(this.dataset.adMaxHeight,10);var parsedAdThresholdWidth=parseInt(this.dataset.adThresholdWidth,10);var parsedAdThresholdHeight=parseInt(this.dataset.adThresholdHeight,10);var size=[[parsedAdMinWidth,parsedAdMinHeight],[parsedAdMaxWidth,parsedAdMaxHeight]];var adSlot=this.googletag.defineSlot(clientId,size,this.getAdSlot());var mapping=this.googletag.sizeMapping().addSize([parsedAdThresholdWidth,parsedAdThresholdHeight],[parsedAdMaxWidth,parsedAdMaxHeight]).addSize([0,0],[parsedAdMinWidth,parsedAdMinHeight]).build();adSlot.defineSizeMapping(mapping);return adSlot},multiSizeResponsibleAdSlot:function(dataset){var clientId=this.getClientId();var sizes=this.getSize();var adSlot=this.googletag.defineSlot(clientId,sizes,this.getAdSlot());var adMinWidth=parseInt(this.dataset.adMinWidth,10);var minSizes=_.filter(sizes,function(size){return adMinWidth===size[0]});var mapping=this.googletag.sizeMapping().addSize([AD_THRESHOLD_WIDTH,0],sizes).addSize([0,0],minSizes).build();return adSlot.defineSizeMapping(mapping)},fluidAdSlot:function(dataset){var clientId=this.getClientId();var size="fluid";return this.googletag.defineSlot(clientId,size,this.getAdSlot())},build:function(){var adSlot;if(this.isResponsible){adSlot=this.responsibleAdSlot()}else if(this.isMultiSizeResponsible){adSlot=this.multiSizeResponsibleAdSlot()}else if(this.isFluid){adSlot=this.fluidAdSlot()}else{adSlot=this.defaultAdSlot()}adSlot.setCollapseEmptyDiv(this.collapseEmptyDiv());if(this.dataset.pageUrl){adSlot.set("page_url",this.dataset.pageUrl)}if(this.dataset.adtest){adSlot.set("adtest",this.dataset.adtest)}if(this.dataset.keyValue){var pair=ns.toQueryParams(this.dataset.keyValue);for(var key in pair){adSlot.setTargeting(key,pair[key])}}adSlot.addService(this.googletag.pubads());this.enableServices();return adSlot},enableServices:_.once(function(){this.googletag.enableServices()})});ns.provide({SlotBuilder:SlotBuilder})});Namespace("jp.mixi.adnetwork.script.loader").use("jp.co.mixi.net.uri isHttpUrl").use("jp.co.mixi.lang.class defineClass").define(function(ns){"use strict";var loader;var ScriptLoader=ns.defineClass({initialize:function(){this.loadedScripts=[]},load:function(src,element,onComplete){var scriptSrc=appendProtocolIfNeeded(src);if(!ns.isHttpUrl(scriptSrc))throw new Error("src is not url.");if(!_.isElement(element))throw new Error("element is required.");if(_.contains(this.loadedScripts,scriptSrc)){return}var script=document.createElement("script");script.async=true;script.type="text/javascript";script.src=scriptSrc;if(_.isFunction(onComplete)){script.onload=script.onerror=function(){onComplete();script.onload=script.onerror=script.onreadystatechange=null};script.onreadystatechange=function(){if(this.readyState==="loaded"||this.readyState==="complete"){onComplete();script.onload=script.onerror=script.onreadystatechange=null}}}element.appendChild(script);this.loadedScripts.push(scriptSrc)}});var appendProtocolIfNeeded=function(str){if(/^(https?):/i.test(str)){return str}else{var protocol="https:"===document.location.protocol?"https:":"http:";return protocol+str}};ns.provide({getScriptLoader:function(){if(loader){return loader}loader=new ScriptLoader;return loader}})});Namespace("jp.mixi.adnetwork.timelinead.widget.smartad").use("jp.co.mixi.gateway gateway").use("jp.co.mixi.ui.template getTemplateByElementId").define(function(ns){"use strict";var isLoaded=false;var timelineAd=ns.gateway("timeline_ad");if(!timelineAd)return;var channelId=timelineAd.channel_id;var mediaId=timelineAd.media_id;var publisherId=timelineAd.publisher_id;var reportLabel=timelineAd.report_label;var positions=timelineAd.positions;var gender=timelineAd.gender;var age=timelineAd.age;var smartAdClass=".JS_SmartAdArea";var renderSmartAd=function(element,dataset){if(!isLoaded){var script=document.createElement("script");script.src="//cdn.smartnews-ads.com/web/latest/sn_main.min.js";script.async=true;element.appendChild(script);isLoaded=true;$j(script).on("load",function(){initSmartAd(element,dataset)})}else{initSmartAd(element,dataset)}};function initSmartAd(element,dataset){var $element=$j(element);var template=ns.getTemplateByElementId("timelinead");var entryClass=dataset.entryClass;if(!entryClass)throw new Error("data-entry-class is required");var $entryList=$element.find(entryClass);if(!$entryList.length)return;var availablePositions=_.filter(positions,function(position){return position<=$entryList.length});if(!availablePositions.length)return;var smartAdManager=new window.SmartAd.Manager(publisherId,mediaId);function renderAdParam(ad){var renderedAd=ad;renderedAd.avatar_url=ad.avatar.url;if(ad.small_img)renderedAd.small_img_url=ad.small_img.url;return renderedAd}function showAds(ads){ads.forEach(function(ad,idx){template.param(renderAdParam(ad));var html=template.output();var position=availablePositions[idx];if(!position)return;$entryList.eq(position-1).after(html);var $smartAdArea=$element.find(smartAdClass);var container=$smartAdArea[idx];smartAdManager.detectViewableImp(ad,container);$smartAdArea.eq(idx).on("click",function(){smartAdManager.handleClick(ad)})});$element.find(".JS_settingButton").on("click",function(event){event.stopPropagation();if(confirm("広告を非表示にしますか？\n（プレミアム会員限定機能）")){location.href="//mixi.jp/redirector.pl?id=10595"}})}if(gender){smartAdManager.customValues["gender"]=gender}if(age){smartAdManager.customValues["age"]=age}smartAdManager.getAds(channelId,availablePositions.length,reportLabel).then(function(ads){showAds(ads)})}ns.provide({registerElement:renderSmartAd})});Namespace("jp.mixi.adnetwork.ui.touch.page").define(function(ns){"use strict";var enableAnchor=function(pageAddClass){$j("#page").addClass(pageAddClass)};ns.provide({enableAnchor:enableAnchor})});